# การแก้ไข: เพิ่มการแสดงดูสลิปในหน้าจัดการเครดิต

## 📋 สรุปการแก้ไข

ฉันได้แก้ไขให้แสดงปุ่ม **"ดูสลิป"** (หลักฐานการโอนเงิน) ในหน้าจัดการเครดิต admin เพื่อให้ admin สามารถตรวจสอบรูปภาพหลักฐานการโอนเงินของผู้ใช้ได้

---

## ✨ ฟีเจอร์ที่เพิ่มมา

### 1. **ปุ่มดูสลิป (View Slip Button)**
   - **ที่ตั้ง**: ในหน้าจัดการเครดิต admin (จัดการเครดิต)
   - **ที่แสดง**: ในส่วน "คำขอเติมเครดิต" ที่ pending รอการตรวจสอบ
   - **ไอคอน**: 🖼️ ดูสลิป
   - **เงื่อนไข**: แสดงเฉพาะเมื่อมีรูปภาพหลักฐาน (proofImageUrl) อยู่

### 2. **Modal เพื่อแสดงรูปภาพสลิป**
   - **ชื่อ**: "ดูหลักฐานการโอนเงิน"
   - **แสดง**:
     - 👤 อีเมลของผู้ใช้
     - 🖼️ รูปภาพสลิปที่อัปโหลด
     - ⬇️ ปุ่มดาวน์โหลด
     - 🔗 ปุ่มเปิดในแท็บใหม่

### 3. **การทำงาน**
   - เมื่อคลิกปุ่ม "ดูสลิป" จะดึงข้อมูลคำขอเติมเครดิตจาก Firestore
   - ตรวจสอบว่ามีรูปภาพ (proofImageUrl) อยู่หรือไม่
   - หากมี จะแสดง Modal พร้อมรูปภาพ
   - ผู้ใช้สามารถ:
     - ดูรูปภาพขนาดใหญ่
     - ดาวน์โหลดรูปภาพ
     - เปิดรูปภาพในแท็บใหม่

---

## 🔧 การเปลี่ยนแปลงโค้ด

### 1. Modal สำหรับแสดงสลิป (บรรทัด ~1524)
```html
<!-- Slip/Receipt Modal -->
<div id="slipModal" class="modal fixed inset-0 z-50 hidden items-center justify-center">
  <!-- Modal content -->
  <div id="slipImage">...</div>
  <button id="slipDownloadBtn">ดาวน์โหลด</button>
  <button id="slipOpenBtn">เปิดในแท็บใหม่</button>
</div>
```

### 2. ฟังก์ชัน showSlipModal() (บรรทัด ~1571)
```javascript
function showSlipModal(imageUrl, userEmail = '') {
  // ตั้งค่ารูปภาพและอีเมล
  // แสดง modal
  showModalElement(slipModal);
}
```

### 3. เพิ่มปุ่มดูสลิปในรายการคำขอ (บรรทัด ~4900)
```html
<!-- ปุ่มดูสลิป (แสดงให้ทุกคนดู ถ้ามีรูปภาพ) -->
${data.proofImageUrl
  ? `<button data-view-slip="${docSnap.id}">🖼️ ดูสลิป</button>`
  : ''
}
```

### 4. Event Listener สำหรับปุ่มดูสลิป (บรรทัด ~4950)
```javascript
listEl.querySelectorAll('[data-view-slip]').forEach(btn => {
  btn.addEventListener('click', async () => {
    const requestId = btn.getAttribute('data-view-slip');
    const snap = await getDoc(doc(db, 'creditRequests', requestId));
    if (snap.exists()) {
      const data = snap.data();
      if (data.proofImageUrl) {
        showSlipModal(data.proofImageUrl, data.userEmail);
      }
    }
  });
});
```

---

## 🎯 วิธีใช้งาน (สำหรับ Admin)

### ขั้นตอน 1: เปิดหน้าจัดการเครดิต
1. ลงชื่อเข้าใช้ระบบด้วยบัญชี Admin
2. คลิกปุ่ม "เติมเครดิตลูกค้า" ที่ Header

### ขั้นตอน 2: ดูคำขอเติมเครดิต
1. ไปที่ส่วน "คำขอเติมเครดิต" (ฝั่งขวา)
2. จะเห็นรายการคำขอที่ pending
3. หากมีรูปภาพหลักฐาน จะมีปุ่ม **"🖼️ ดูสลิป"**

### ขั้นตอน 3: ดูรูปภาพหลักฐาน
1. คลิกปุ่ม "🖼️ ดูสลิป"
2. Modal จะแสดงรูปภาพสลิป
3. คุณสามารถ:
   - **ดูรูป**: ดูรูปภาพขนาดใหญ่ในกล่องดำ
   - **ดาวน์โหลด**: คลิก "⬇️ ดาวน์โหลด" เพื่อเก็บรูปภาพ
   - **เปิดใหม่**: คลิก "🔗 เปิดในแท็บใหม่" เพื่อดูรูปเต็มหน้า

### ขั้นตอน 4: อนุมัติหรือปฏิเสธคำขอ
1. หลังจากตรวจสอบรูปภาพหลักฐาน
2. คลิก **"อนุมัติ"** เพื่อเพิ่มเครดิต
3. หรือคลิก **"ปฏิเสธ"** หากหลักฐานไม่ครบ

---

## 📊 ที่เก็บข้อมูล

ข้อมูลหลักฐานการโอนเงิน ถูกเก็บไว้ใน:
- **Collection**: `creditRequests`
- **Field**: `proofImageUrl`
- **ที่เก็บรูปภาพ**: Firebase Storage
- **Path**: `slips/email_user/YYYY-MM-DD/filename.ext`

---

## ✅ ลักษณะการแสดงผล

### 1. รายการคำขอเติมเครดิต
```
┌─────────────────────────────────────┐
│ user@email.com        [กำลังตรวจสอบ] │
│ จำนวน: 1,000 เครดิต · เวลา: ...    │
│                                     │
│ [🖼️ ดูสลิป] [อนุมัติ] [ปฏิเสธ]      │
└─────────────────────────────────────┘
```

### 2. Modal ดูสลิป
```
┌─────────────────────────────────────┐
│ ดูหลักฐานการโอนเงิน                  ✖  │
├─────────────────────────────────────┤
│ อีเมล: user@email.com               │
│                                     │
│        [รูปภาพสลิป]                 │
│                                     │
│ [⬇️ ดาวน์โหลด] [🔗 เปิดในแท็บใหม่]  │
└─────────────────────────────────────┘
```

---

## 🚀 ความสามารถของระบบ

- ✅ แสดงปุ่มดูสลิปสำหรับแต่ละคำขอ
- ✅ ดึงรูปภาพจาก Firebase Storage
- ✅ แสดงรูปภาพในกล่องขยายใหญ่
- ✅ สนับสนุนการดาวน์โหลด
- ✅ เปิดรูปภาพในแท็บใหม่
- ✅ แสดงอีเมลของผู้ใช้
- ✅ ใช้งานได้ทั้ง Admin และ User (ดูเฉพาะของตัวเอง)

---

## 📝 หมายเหตุ

1. **ปุ่มดูสลิป** จะแสดงเฉพาะเมื่อมีรูปภาพ (proofImageUrl) ใน Firestore
2. หากคำขอไม่มี proofImageUrl จะไม่มีปุ่มดูสลิป
3. ปุ่มอนุมัติและปฏิเสธจะแสดงเฉพาะสำหรับ admin และสถานะ pending
4. ผู้ใช้ปกติสามารถดูหลักฐานของคำขอของตัวเองได้

---

## 🔍 ทดสอบคุณสมบัติ

สำหรับการทดสอบ:
1. เข้าสู่ระบบด้วย Admin
2. เปิด "เติมเครดิตลูกค้า"
3. สร้างคำขอเติมเครดิตจากบัญชี User (มีรูปภาพหลักฐาน)
4. จะเห็นปุ่ม "🖼️ ดูสลิป" ในส่วน "คำขอเติมเครดิต"
5. คลิกปุ่มเพื่อตรวจสอบรูปภาพ

---

**เสร็จสิ้น! ✨**
