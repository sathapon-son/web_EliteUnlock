<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Elite Unlock — โปรแกรมปลดล็อคมือถือ (ของแท้ ราคาคุ้ม เปิดไว)</title>
  <meta name="description" content="ขายโปรแกรมปลดล็อคมือถือของแท้ Unlocktool, TSM TOOL PRO ฯลฯ ราคาเป็นมิตร เปิดใช้งานรวดเร็ว มีรับประกัน และดูแลหลังการขายจริง">

  <!-- Favicon / App Icons -->
  <link rel="icon" type="image/png" sizes="32x32" href="logo.png">
  <link rel="apple-touch-icon" href="logo.png">
  <meta name="theme-color" content="#4f46e5">

  <!-- Open Graph / Social -->
  <meta property="og:title" content="Elite Unlock — โปรแกรมปลดล็อคมือถือ">
  <meta property="og:description" content="ของแท้ 100% • เปิดใช้งานรวดเร็ว • ราคาคุ้มค่า • มีดูแลหลังการขายจริง">
  <meta property="og:image" content="logo.png">
  <meta property="og:type" content="website">

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card-hover{transition:.25s ease}
    .card-hover:hover{transform:translateY(-5px);box-shadow:0 15px 30px rgba(0,0,0,.08)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:50}
    .modal.active{display:flex}
    .badge{display:inline-flex;align-items:center;gap:.5rem;padding:.4rem .7rem;border-radius:.6rem;font-size:.8rem}
    #adminOrdersModal .orders-scroll{max-height:70vh;overflow-y:auto;padding-right:.75rem;}
  </style>
</head>

<body class="bg-gradient-to-b from-slate-50 to-slate-100 text-slate-800 antialiased">
  <!-- Header -->
  <header class="max-w-6xl mx-auto px-6 py-6 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <!-- ใช้โลโก้ -->
      <img src="logo.png" alt="Elite Unlock Logo" class="w-10 h-10 rounded-lg object-contain bg-white shadow" />
      <div>
        <h1 class="text-2xl font-semibold">Elite Unlock — โปรแกรมปลดล็อคมือถือ</h1>
        <p class="text-sm text-slate-600">
          ของแท้ 100% • เปิดใช้งานรวดเร็ว • ราคาคุ้มค่ากว่า • มีดูแลหลังการขายจริง
        </p>
      </div>
    </div>
    <button id="contactBtn" class="bg-indigo-600 text-white text-sm px-4 py-2 rounded-md shadow">ติดต่อ / สั่งซื้อ</button>
  </header>

  <main class="max-w-6xl mx-auto px-6 pb-16">
    <!-- Hero badges -->
    <section class="mb-6">
      <div class="rounded-2xl p-6 bg-white shadow">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <h2 class="text-2xl md:text-3xl font-extrabold">ปลดล็อคอย่างมั่นใจ — ของแท้ ราคาเป็นมิตร เปิดไว</h2>
            <p class="text-slate-600 mt-1">
              คีย์/ไลเซนส์แท้สำหรับ Unlocktool, TSM TOOL PRO และเครื่องมือยอดนิยมอื่น ๆ เน้นความคุ้มค่า พร้อมคำแนะนำเบื้องต้น และรับประกันการเปิดใช้งานตามเงื่อนไข
            </p>
          </div>
          <div class="flex flex-wrap gap-2">
            <span class="badge bg-emerald-50 text-emerald-700">✔ รับประกันเปิดใช้งาน</span>
            <span class="badge bg-sky-50 text-sky-700">⏱ เปิดไว</span>
            <span class="badge bg-amber-50 text-amber-700">฿ ราคาเป็นมิตร</span>
            <span class="badge bg-violet-50 text-violet-700">🛟 ซัพพอร์ตหลังการขาย</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Product Detail (inline on main page) -->
    <section id="productDetail" class="mb-10 hidden">
      <div class="rounded-2xl p-6 bg-white shadow">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
          <div>
            <img id="detailImage" src="" alt="" class="w-full rounded-md border bg-slate-50 object-cover" style="aspect-ratio: 800/550;" />
          </div>
          <div class="space-y-3">
            <div class="text-slate-500" id="detailProgram"></div>
            <h3 id="detailName" class="text-2xl font-bold"></h3>
            <div class="text-2xl font-extrabold text-indigo-700">฿<span id="detailPrice">0</span></div>
            <div id="detailFields" class="space-y-2"></div>
            <div class="flex gap-2">
              <button id="detailAddCart" class="bg-indigo-600 text-white px-4 py-2 rounded-md">เพิ่มในตะกร้า</button>
              <button id="detailCancel" class="bg-slate-200 text-slate-700 px-4 py-2 rounded-md">ยกเลิก</button>
            </div>
            <div id="detailMsg" class="text-sm text-red-600"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Search -->
    <section class="mb-4">
      <div class="relative w-full md:w-96">
        <input id="searchInput" type="search"
               placeholder="ค้นหา: โปรแกรม หรือ แพ็กเกจ (เช่น Unlocktool, 6 เดือน, 1 ปี)"
               class="w-full p-3 pl-10 rounded-lg border bg-white shadow-sm outline-none focus:ring-2 focus:ring-indigo-500">
        <svg class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.3-4.3M10 18a8 8 0 100-16 8 8 0 000 16z"/>
        </svg>
      </div>
      <p id="status" class="text-sm text-slate-600 mt-2">กำลังโหลดข้อมูล...</p>
    </section>

    <!-- Packages (cards grouped) -->
    <section id="pricing" class="mb-10">
      <!-- เปลี่ยนหัวข้อเป็น "แพ็กเกจ" -->
      <h3 class="text-2xl font-bold mb-4">แพ็กเกจ</h3>
      <div id="groups" class="grid gap-6 md:grid-cols-2"></div>
      <p id="emptyState" class="hidden text-sm text-slate-500 mt-4">ไม่พบรายการที่ตรงกับคำค้นหา</p>
    </section>

    <!-- Trust sections -->
    <section class="mb-10 grid md:grid-cols-3 gap-4">
      <div class="p-5 rounded-2xl bg-white shadow">
        <h4 class="font-bold text-lg mb-2">ทำไมลูกค้าเลือกเรา</h4>
        <ul class="text-sm space-y-2 text-slate-700">
          <li>• ไลเซนส์แท้ ตรวจสอบได้</li>
          <li>• ราคาเป็นมิตร คุ้มค่าการใช้งานระยะยาว</li>
          <li>• เปิดใช้งานรวดเร็ว ตามคิว ไม่ดองงาน</li>
          <!-- เอาออก: มีคู่มือ/คำแนะนำเริ่มต้นให้จนใช้งานได้ -->
          <li>• ติดต่อได้จริง หลายช่องทาง</li>
        </ul>
      </div>
      <div class="p-5 rounded-2xl bg-white shadow">
        <h4 class="font-bold text-lg mb-2">การรับประกัน & นโยบาย</h4>
        <ul class="text-sm space-y-2 text-slate-700">
          <li>• รับประกันการเปิดใช้งานตามเงื่อนไข</li>
          <li>• เปิดไม่สำเร็จภายใต้ขั้นตอนที่แนะนำ — ดูแลแก้ไข/คืนเงินตามเงื่อนไข</li>
          <!-- เอาออก: ออกหลักฐานการชำระ/ใบเสร็จได้ -->
          <!-- เอาออก: เก็บข้อมูลลูกค้าเพื่อออกหลักฐานเท่านั้น -->
          <li>• โปร่งใส ชี้แจงค่าใช้จ่ายก่อนทำรายการ</li>
        </ul>
      </div>
      <!-- เอาออกทั้งบล็อกรีวิวจากผู้ใช้งาน -->
      <div class="p-5 rounded-2xl bg-white shadow">
        <h4 class="font-bold text-lg mb-2">คำถามที่พบบ่อย</h4>
        <div class="text-sm text-slate-700 space-y-2">
          <div><span class="font-semibold">Q:</span> เปิดใช้งานใช้เวลานานไหม?<br><span class="text-slate-700">A:</span> โดยทั่วไปเปิดภายในคิวงาน หากข้อมูลพร้อมจะรวดเร็ว</div>
          <div><span class="font-semibold">Q:</span> ราคาทำไมถูก?<br><span class="text-slate-700">A:</span> เราโฟกัสราคาเป็นมิตรและปริมาณออเดอร์ เพื่อให้ลูกค้าเข้าถึงของแท้ได้ง่าย</div>
        </div>
      </div>
    </section>

    <!-- Contact (on-page) -->
    <section id="contact" class="rounded-2xl p-6 bg-white shadow">
      <h3 class="text-2xl font-bold mb-2">ติดต่อ / สั่งซื้อ</h3>
      <div class="grid md:grid-cols-3 gap-6">
        <div class="space-y-1 text-sm">
          <div class="font-semibold">โทรศัพท์</div>
          <div class="text-slate-800 text-base">062-607-2670</div>
          <div class="text-xs text-slate-500">เวลาทำการ 09:00–21:00 น.</div>
        </div>
        <div class="space-y-1 text-sm">
          <div class="font-semibold">Facebook</div>
          <a class="text-indigo-600 hover:underline break-all" href="https://www.facebook.com/S.Sonsupap" target="_blank" rel="noopener">
            facebook.com/S.Sonsupap
          </a>
        </div>
        <div class="space-y-1 text-sm">
          <div class="font-semibold">LINE</div>
          <div class="text-slate-700">ID: <span class="font-medium">@825lhqmj</span></div>
          <div class="flex items-center gap-3">
            <!-- เปลี่ยนเป็น LINE_QR.png -->
            <img src="LINE_QR.png" alt="LINE QR Code" class="w-24 h-24 rounded-md border" />
            <a class="text-indigo-600 hover:underline" href="https://line.me/R/ti/p/@825lhqmj" target="_blank" rel="noopener">เพิ่มเพื่อน</a>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal Contact -->
  <div id="contactModal" class="modal" aria-hidden="true">
    <div class="bg-white rounded-xl shadow-lg max-w-lg w-full p-6 relative">
      <button id="closeModal" class="absolute right-3 top-3 text-slate-400 hover:text-slate-600 text-lg" aria-label="Close">&times;</button>
      <h3 class="text-xl font-bold mb-4 text-center">ติดต่อ / สั่งซื้อ</h3>
      <div class="space-y-4 text-sm">
        <div>
          <div class="font-semibold text-slate-700">📞 โทรศัพท์</div>
          <div class="text-lg text-indigo-700">062-607-2670</div>
        </div>
        <div>
          <div class="font-semibold text-slate-700">📘 Facebook</div>
          <a href="https://www.facebook.com/S.Sonsupap" target="_blank" class="text-indigo-600 hover:underline">
            facebook.com/S.Sonsupap
          </a>
        </div>
        <div>
          <div class="font-semibold text-slate-700">💬 LINE</div>
          <p>ID: <strong>@825lhqmj</strong></p>
          <div class="flex gap-4 items-center mt-2">
            <!-- เปลี่ยนเป็น LINE_QR.png -->
            <img src="LINE_QR.png" alt="LINE QR" class="w-24 h-24 rounded-md border">
            <a href="https://line.me/R/ti/p/@825lhqmj" target="_blank" class="text-indigo-600 hover:underline">เพิ่มเพื่อน</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="max-w-6xl mx-auto px-6 py-6 text-sm text-slate-500 text-center">
    © 2025 Elite Unlock · ของแท้ ราคาเป็นมิตร เปิดไว · โทร 062-607-2670 · FB: S.Sonsupap · LINE: @825lhqmj
  </footer>

  
  <script type="module">
  // ----- Global Variables -----
  let CURRENT_USER = null;
  let CURRENT_USER_DOC = null;
  let IS_ADMIN = false;
  let FS_PRODUCTS = [];
  let PENDING_ORDER = null;
  let USER_ORDERS_UNSUB = null;
  let ADMIN_ORDERS_UNSUB = null;
  let PRODUCTS_UNSUB = null;
  let CART = [];

  // ----- Firebase Configuration -----
  const firebaseConfig = {
    apiKey: "AIzaSyAvZLhir8UvnBsb0NuK5r6y73TfoclBC-4",
    authDomain: "eliteunlock-c194e.firebaseapp.com",
    projectId: "eliteunlock-c194e",
    storageBucket: "eliteunlock-c194e.firebasestorage.app",
    messagingSenderId: "12192434961",
    appId: "1:12192434961:web:ad7cff07c16e81e34fdab0",
    measurementId: "G-FFR5YG8S8J"
  };

  // Cloudinary (unsigned upload preset)
  const CLOUD_NAME = "dj3ylqec8";
  const UPLOAD_PRESET = "slip_unsigned";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import {
    getAuth, onAuthStateChanged,
    createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc,
    query, where, getDocs, onSnapshot, serverTimestamp, increment,
    runTransaction, deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
  import { getAnalytics, isSupported } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-analytics.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  // Optional: Analytics (non-blocking)
  try { isSupported().then(ok=>{ if(ok) getAnalytics(app); }); } catch {}

  // Configure admin emails (edit to your admin accounts) or use isAdmin in user doc
  const ADMIN_EMAILS = [
    // "owner@example.com"
  ];

  // ----- Elements -----
  const groupsEl   = document.getElementById("groups");
  const statusEl   = document.getElementById("status");
  const emptyEl    = document.getElementById("emptyState");
  const searchEl   = document.getElementById("searchInput");
  const contactBtn = document.getElementById("contactBtn");
  const modal      = document.getElementById("contactModal");
  const closeBtn   = document.getElementById("closeModal");

// Auth UI bits (ย้ายไปอยู่ฝั่งขวารวมกับปุ่ม "ติดต่อ / สั่งซื้อ")
const header = document.querySelector('header');
header.classList.add('flex-wrap', 'gap-3'); // ให้พับบรรทัดได้ ป้องกันปุ่มล้น

const headerRight = document.createElement('div');
// จัดให้ปุ่ม auth + ปุ่มติดต่ออยู่ขวาเสมอ และเว้นช่องว่างสวยงาม
headerRight.className = 'flex items-center gap-3 ml-auto';

// วาง headerRight ไว้ก่อนปุ่มติดต่อ แล้วดึงปุ่มติดต่อเข้าไปอยู่ในกล่องเดียวกัน
header.insertBefore(headerRight, contactBtn);
headerRight.appendChild(contactBtn);

  headerRight.innerHTML = `
    <div class="flex items-center gap-3">
      <div id="userInfo" class="text-sm text-slate-700 hidden"></div>
      <div id="balanceInfo" class="text-sm font-semibold text-indigo-700 hidden"></div>
      <button id="registerBtn" class="bg-emerald-600 text-white text-sm px-4 py-2 rounded-md shadow">สมัครสมาชิก</button>
      <button id="loginBtn" class="bg-indigo-600 text-white text-sm px-4 py-2 rounded-md shadow">เข้าสู่ระบบ</button>
      <button id="logoutBtn" class="bg-slate-200 text-slate-700 text-sm px-3 py-2 rounded-md shadow hidden">ออกจากระบบ</button>
    </div>
  `;

  // Register Modal
  const regModal = document.createElement('div');
  regModal.className = 'modal'; regModal.id = 'regModal'; regModal.setAttribute('aria-hidden','true');
  regModal.innerHTML = `
    <div class="bg-white rounded-xl shadow-lg max-w-md w-full p-6 relative">
      <button id="closeReg" class="absolute right-3 top-3 text-slate-400 hover:text-slate-600 text-lg" aria-label="Close">&times;</button>
      <h3 class="text-xl font-bold mb-4 text-center">สมัครสมาชิก</h3>
      <div class="space-y-3">
        <input id="authEmailR" type="email" placeholder="อีเมล" class="w-full border rounded p-2" />
        <input id="authPassR" type="password" placeholder="รหัสผ่าน" class="w-full border rounded p-2" />
        <input id="authPass2R" type="password" placeholder="ยืนยันรหัสผ่าน" class="w-full border rounded p-2" />
        <button id="doRegister" class="w-full bg-emerald-600 text-white px-4 py-2 rounded-md">สมัครสมาชิก</button>
        <div id="authMsgR" class="text-sm text-red-600"></div>
      </div>
    </div>`;
  document.body.appendChild(regModal);

  // Login Modal
  const loginModal = document.createElement('div');
  loginModal.className = 'modal'; loginModal.id = 'loginModal'; loginModal.setAttribute('aria-hidden','true');
  loginModal.innerHTML = `
    <div class="bg-white rounded-xl shadow-lg max-w-md w-full p-6 relative">
      <button id="closeLogin" class="absolute right-3 top-3 text-slate-400 hover:text-slate-600 text-lg" aria-label="Close">&times;</button>
      <h3 class="text-xl font-bold mb-4 text-center">ลงชื่อเข้าใช้</h3>
      <div class="space-y-3">
        <input id="authEmailL" type="email" placeholder="อีเมล" class="w-full border rounded p-2" />
        <input id="authPassL" type="password" placeholder="รหัสผ่าน" class="w-full border rounded p-2" />
        <button id="doLogin" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-md">ลงชื่อเข้าใช้</button>
        <div id="authMsgL" class="text-sm text-red-600"></div>
      </div>
    </div>`;
  document.body.appendChild(loginModal);

  // Order Modal
  const orderModal = document.createElement('div');
  orderModal.className = 'modal'; orderModal.id = 'orderModal'; orderModal.setAttribute('aria-hidden','true');
  orderModal.innerHTML = `
    <div class="bg-white rounded-xl shadow-lg max-w-md w-full p-6 relative">
      <button id="closeOrder" class="absolute right-3 top-3 text-slate-400 hover:text-slate-600 text-lg" aria-label="Close">&times;</button>
      <h3 class="text-xl font-bold mb-4 text-center">ยืนยันการสั่งซื้อ</h3>
      <div id="orderSummary" class="text-sm text-slate-700 mb-3"></div>
      <div id="orderEmailBlock" class="space-y-2 hidden">
        <label class="text-sm">กรอกอีเมลสำหรับสินค้านี้</label>
        <input id="orderEmailInput" type="email" placeholder="อีเมลสำหรับใช้งานสินค้า" class="w-full border rounded p-2" />
      </div>
      <div id="orderPasswordBlock" class="space-y-2 hidden">
        <label class="text-sm">รหัสผ่านสำหรับสินค้านี้</label>
        <input id="orderPasswordInput" type="password" placeholder="รหัสผ่านสำหรับสินค้านี้" class="w-full border rounded p-2" />
      </div>
      <div class="flex gap-2 mt-4">
        <button id="confirmOrder" class="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-md">ยืนยันสั่งซื้อ</button>
        <button id="cancelOrder" class="flex-1 bg-slate-200 text-slate-700 px-4 py-2 rounded-md">ยกเลิก</button>
      </div>
      <div id="orderMsg" class="mt-2 text-sm text-red-600"></div>
    </div>`;
  document.body.appendChild(orderModal);

  // Order History Modal (for users)
  const historyModal = document.createElement('div');
  historyModal.className = 'modal'; historyModal.id = 'historyModal'; historyModal.setAttribute('aria-hidden','true');
  historyModal.innerHTML = `
    <div class="bg-white rounded-xl shadow-lg max-w-4xl w-full p-6 relative">
      <button id="closeHistory" class="absolute right-3 top-3 text-slate-400 hover:text-slate-600 text-lg" aria-label="Close">&times;</button>
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-bold mb-4">ประวัติการสั่งซื้อ</h3>
      </div>
      

      <div class="overflow-y-auto max-h-[70vh] pr-2" style="max-height:70vh;">
        <table id="ordersTable" class="w-full text-sm border-collapse">
          <thead>
            <tr class="text-left border-b">
              <th class="p-2">ชื่อโปรแกรม</th>
              <th class="p-2">สถานะ</th>
              <th class="p-2">เครดิต</th>
              <th class="p-2">วันที่</th>
              <th class="p-2">Order Reply</th>
            </tr>
          </thead>
          <tbody id="ordersTbody" class="text-slate-700"></tbody>
        </table>
      </div>
    </div>`;
  document.body.appendChild(historyModal);

  // Top-up Modal (separate from history)
  const topupModal = document.createElement('div');
  topupModal.className = 'modal'; topupModal.id = 'topupModal'; topupModal.setAttribute('aria-hidden','true');
  topupModal.innerHTML = `
    <div class="bg-white rounded-xl shadow-lg max-w-md w-full p-6 relative">
      <button id="closeTopup" class="absolute right-3 top-3 text-slate-400 hover:text-slate-600 text-lg" aria-label="Close">&times;</button>
      <h3 class="text-xl font-bold mb-4 text-center">เติมเครดิต</h3>
      <div class="space-y-3 text-sm text-center flex flex-col items-center">
        <div>
          <div class="font-semibold">1. พร้อมเพย์</div>
          <div class="text-lg">0885698501</div>
          <div>สถาพร สอนสุภาพ</div>
        </div>
        <div>
          <div class="font-semibold">2. บัญชี</div>
          <div class="text-lg">4030426581</div>
          <div>กรุงไทย</div>
          <div>สถาพร สอนสุภาพ</div>
        </div>
        <div class="flex flex-col md:flex-row items-center justify-center gap-6">
          <div class="text-center">
            <img src="LINE_QR.png" alt="LINE QR" class="w-32 h-32 border rounded mx-auto" />
            <div class="text-sm text-slate-700 mt-2">ติดต่อผ่าน LINE</div>
          </div>
        </div>
        <div class="rounded-lg p-3 bg-amber-50 border max-w-[90%]">โปรดติดต่อเพื่อยืนยันการชำระเงินผ่าน LINE เท่านั้น:<br/><strong>LINE ID: @825lhqmj</strong><br/>หากต้องการความสะดวก ให้ส่งภาพสลิปผ่านแชท LINE</div>
      </div>
    </div>`;
  document.body.appendChild(topupModal);
  // wire topup modal buttons
  document.getElementById('closeTopup')?.addEventListener('click', ()=>{ document.getElementById('topupModal')?.classList.remove('active'); });
  document.getElementById('topupModal')?.addEventListener('click', (e)=>{ if(e.target===document.getElementById('topupModal')) document.getElementById('topupModal')?.classList.remove('active'); });

  // Cart Modal
  const cartModal = document.createElement('div');
  cartModal.className = 'modal'; cartModal.id = 'cartModal'; cartModal.setAttribute('aria-hidden','true');
  cartModal.innerHTML = `
    <div class="bg-white rounded-xl shadow-lg max-w-2xl w-full p-6 relative">
      <button id="closeCart" class="absolute right-3 top-3 text-slate-400 hover:text-slate-600 text-lg" aria-label="Close">&times;</button>
      <h3 class="text-xl font-bold mb-4 text-center">ตะกร้าสินค้า</h3>
      <div id="cartList" class="space-y-3 max-h-[60vh] overflow-auto text-sm"></div>
      <div class="flex items-center justify-between mt-4">
        <div class="text-lg font-semibold">รวมทั้งหมด: <span id="cartTotal">0</span> เครดิต</div>
        <button id="continueShopping" class="bg-indigo-600 text-white text-sm px-4 py-2 rounded-md">ยืนยันการสั่งซื้อ</button>
      </div>
      <div id="cartMsg" class="mt-2 text-sm"></div>
    </div>`;
  document.body.appendChild(cartModal);

  // Product Detail Modal (Buy Now)
  const productModal = document.createElement('div');
  productModal.className = 'modal'; productModal.id = 'productModal'; productModal.setAttribute('aria-hidden','true');
  productModal.innerHTML = `
    <div class="bg-white rounded-xl shadow-lg max-w-3xl w-full p-6 relative">
      <button id="closeProduct" class="absolute right-3 top-3 text-slate-400 hover:text-slate-600 text-lg" aria-label="Close">&times;</button>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="space-y-3">
          <img id="pdImage" src="" alt="" class="w-full object-cover rounded border bg-slate-50" style="aspect-ratio: 800/550;" />
          <div class="text-sm text-slate-500" id="pdProgram"></div>
        </div>
        <div class="space-y-3">
          <h3 class="text-2xl font-bold" id="pdName"></h3>
          <div class="text-2xl font-extrabold text-indigo-700">฿<span id="pdPrice">0</span></div>
          <div id="pdFields" class="space-y-2"></div>
          <div>
            <button id="pdAddCart" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-md">เพิ่มในตะกร้า</button>
          </div>
          <div id="pdMsg" class="text-sm"></div>
        </div>
      </div>
    </div>`;
  document.body.appendChild(productModal);

  // Admin UI was moved out of the main page and into modals/header buttons per request.

  // Admin Orders Modal (for pending orders) - opens as popup for easier management
  const adminOrdersModal = document.createElement('div');
  adminOrdersModal.className = 'modal'; adminOrdersModal.id = 'adminOrdersModal'; adminOrdersModal.setAttribute('aria-hidden','true');
  adminOrdersModal.innerHTML = `
    <div class="bg-white rounded-xl shadow-lg max-w-6xl w-full p-6 relative">
      <button id="closeAdminOrders" class="absolute right-3 top-3 text-slate-400 hover:text-slate-600 text-lg" aria-label="Close">&times;</button>
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-bold mb-4">คำสั่งซื้อ (Admin)</h3>
      </div>
      <div class="mb-4">
        <div class="text-sm text-slate-600 mb-2">ตัวกรองสถานะ: เลือกสถานะที่ต้องการแสดง (ค่าจะถูกบันทึกไว้)</div>
        <div class="flex items-center gap-3 text-sm">
          <label class="inline-flex items-center gap-2"><input type="checkbox" id="adminFilterPending" /> <span>กำลังดำเนินการ</span></label>
          <label class="inline-flex items-center gap-2"><input type="checkbox" id="adminFilterAccepted" /> <span>สำเร็จ</span></label>
          <label class="inline-flex items-center gap-2"><input type="checkbox" id="adminFilterRejected" /> <span>ไม่สำเร็จ</span></label>
          <button id="adminFilterApply" class="ml-4 bg-indigo-600 text-white text-sm px-3 py-1 rounded-md">ปรับใช้</button>
          <button id="adminFilterReset" class="ml-2 bg-slate-100 text-slate-700 text-sm px-3 py-1 rounded-md">รีเซ็ต</button>
        </div>
      </div>
      <div class="orders-scroll">
        <div id="adminOrdersList" class="text-sm"></div>
      </div>
    </div>`;
  document.body.appendChild(adminOrdersModal);
  // close handler
  document.getElementById('closeAdminOrders')?.addEventListener('click', ()=>{ document.getElementById('adminOrdersModal')?.classList.remove('active'); });
  adminOrdersModal.addEventListener('click', (e)=>{ if(e.target===adminOrdersModal) adminOrdersModal.classList.remove('active'); });

  // Admin Credit Modal (open from header)
  const adminCreditModal = document.createElement('div');
  adminCreditModal.className = 'modal'; adminCreditModal.id = 'adminCreditModal'; adminCreditModal.setAttribute('aria-hidden','true');
  adminCreditModal.innerHTML = `
    <div class="bg-white rounded-xl shadow-lg max-w-md w-full p-6 relative">
      <button id="closeAdminCredit" class="absolute right-3 top-3 text-slate-400 hover:text-slate-600 text-lg" aria-label="Close">&times;</button>
      <h3 class="text-xl font-bold mb-4 text-center">เพิ่มเครดิตให้ลูกค้า</h3>
      <div class="space-y-3 text-sm">
        <input id="creditEmail" type="email" placeholder="อีเมลลูกค้า" class="w-full border rounded p-2" />
        <input id="creditAmount" type="number" placeholder="จำนวนเครดิต (+เพิ่ม/-ลด)" class="w-full border rounded p-2" />
        <button id="addCreditBtn" class="w-full bg-emerald-600 text-white px-4 py-2 rounded-md">อัปเดตเครดิต</button>
        <div id="creditMsg" class="text-sm"></div>
      </div>
    </div>`;
  document.body.appendChild(adminCreditModal);
  document.getElementById('closeAdminCredit')?.addEventListener('click', ()=>{ document.getElementById('adminCreditModal')?.classList.remove('active'); });
  adminCreditModal.addEventListener('click',(e)=>{ if(e.target===adminCreditModal) adminCreditModal.classList.remove('active'); });

  // Admin Product Modal (open from header) - enhanced with product management
  const adminProductModal = document.createElement('div');
  adminProductModal.className = 'modal overflow-y-auto'; adminProductModal.id = 'adminProductModal'; adminProductModal.setAttribute('aria-hidden','true');
  adminProductModal.innerHTML = `
    <div class="bg-white rounded-xl shadow-lg max-w-6xl w-full max-h-[90vh] relative flex flex-col">
      <button id="closeAdminProduct" class="absolute right-3 top-3 text-slate-400 hover:text-slate-600 text-lg" aria-label="Close">&times;</button>
      <div class="p-6 overflow-y-auto flex-1 space-y-6">
        <h3 class="text-xl font-bold">จัดการสินค้า</h3>

        <div class="space-y-3 text-sm">
          <h4 class="font-semibold">เพิ่มสินค้าใหม่</h4>
          <div class="flex flex-wrap gap-3">
            <input id="pProgram" type="text" placeholder="โปรแกรม" class="border rounded p-2 min-w-[12rem] flex-1" />
            <input id="pImage" type="text" placeholder="ลิงก์รูปภาพ" class="border rounded p-2 min-w-[12rem] flex-1" />
            <div class="grid gap-2 w-full sm:grid-cols-2">
              <input id="pName" type="text" placeholder="แพ็กเกจ / ชื่อ (เพิ่มรายการเดียว)" class="border rounded p-2" />
              <input id="pPrice" type="number" placeholder="ราคา (เครดิต)" class="border rounded p-2" />
            </div>
            <textarea id="pBulkLines" rows="3" placeholder="6 เดือน, 1200
12 เดือน, 2200" class="border rounded p-2 w-full"></textarea>
            <p class="text-xs text-slate-500 w-full">เพิ่มหลายรายการ: กรอกแพ็กเกจกับราคา (คั่นด้วยเครื่องหมาย , หรือ |) ทีละบรรทัด</p>
            <div class="flex flex-wrap items-center gap-3 w-full">
              <label class="inline-flex items-center gap-2"><input id="pReqEmail" type="checkbox" /> ต้องการอีเมล</label>
              <label class="inline-flex items-center gap-2"><input id="pReqPassword" type="checkbox" /> ต้องการรหัสผ่าน</label>
              <label class="inline-flex items-center gap-2"><input id="pReqUsername" type="checkbox" /> ต้องการ Username</label>
              <label class="inline-flex items-center gap-2"><input id="pReqSN" type="checkbox" /> ต้องการ SN</label>
              <label class="inline-flex items-center gap-2"><input id="pReqIMEI" type="checkbox" /> ต้องการ IMEI</label>
              <button id="addProductBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-md">เพิ่มสินค้า</button>
            </div>
          </div>
          <div id="productMsg" class="text-sm"></div>
        </div>

        <div id="productsArea" class="rounded-lg bg-white border p-4">
          <div class="flex flex-col gap-2 mb-3 md:flex-row md:items-center md:justify-between">
            <h4 class="font-semibold">รายการสินค้าในฐานข้อมูล</h4>
            <div class="flex flex-wrap items-center gap-3">
              <input id="adminProductSearch" type="search" placeholder="ค้นหาสินค้า โปรแกรม/แพ็กเกจ" class="border rounded px-3 py-2 text-sm w-full sm:w-72">
              <button id="btnRefreshProducts" class="bg-slate-100 text-slate-700 text-sm px-3 py-1 rounded-md">รีเฟรช</button>
            </div>
          </div>

          <div class="overflow-x-auto">
            <div class="max-h-[55vh] overflow-y-auto">
              <table id="productsTable" class="w-full text-sm border-collapse">
                <thead>
                  <tr class="text-left border-b">
                    <th class="p-2">เลือก</th>
                    <th class="p-2">โปรแกรม</th>
                    <th class="p-2">แพ็กเกจ / ชื่อ</th>
                    <th class="p-2">ราคา</th>
                    <th class="p-2">image</th>
                    <th class="p-2">email?</th>
                    <th class="p-2">password?</th>
                    <th class="p-2">username?</th>
                    <th class="p-2">sn?</th>
                    <th class="p-2">imei?</th>
                    <th class="p-2">จัดการ</th>
                  </tr>
                </thead>
                <tbody id="productsTbody" class="text-slate-700"></tbody>
              </table>
            </div>
          </div>

          <div class="mt-4 flex gap-3">
            <button id="btnBulkSave" class="bg-emerald-600 text-white px-3 py-2 rounded">Save selected</button>
            <button id="btnDeleteSelected" class="bg-red-600 text-white px-3 py-2 rounded">Delete selected</button>
            <div id="bulkMsg" class="text-sm text-slate-600 ml-3"></div>
          </div>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(adminProductModal);
  document.getElementById('closeAdminProduct')?.addEventListener('click', ()=>{ document.getElementById('adminProductModal')?.classList.remove('active'); });
  document.getElementById('adminProductSearch')?.addEventListener('input', (e)=>{ applyAdminProductFilter(e.target.value); });

  // Helper: persist/restore admin orders filter (exclude 'paid')
  const ADMIN_FILTER_KEY = 'adminOrdersFilter';
  function getSavedAdminFilter(){
    try{ const v = localStorage.getItem(ADMIN_FILTER_KEY); if(!v) return null; const arr = JSON.parse(v); return Array.isArray(arr)?arr: null; }catch{return null;}
  }
  function saveAdminFilter(arr){ try{ localStorage.setItem(ADMIN_FILTER_KEY, JSON.stringify(arr||[])); }catch{}
  }
  function readFilterUI(){
    const pending = !!document.getElementById('adminFilterPending')?.checked;
    const accepted = !!document.getElementById('adminFilterAccepted')?.checked;
    const rejected = !!document.getElementById('adminFilterRejected')?.checked;
    const out = [];
    if(pending) out.push('pending');
    if(accepted) out.push('accepted');
    if(rejected) out.push('rejected');
    return out;
  }
  function applyFilterToUI(arr){
    if(!Array.isArray(arr)) arr = ['pending','accepted','rejected'];
    document.getElementById('adminFilterPending').checked = arr.includes('pending');
    document.getElementById('adminFilterAccepted').checked = arr.includes('accepted');
    document.getElementById('adminFilterRejected').checked = arr.includes('rejected');
  }
  // wire apply/reset buttons
  document.getElementById('adminFilterApply')?.addEventListener('click', ()=>{
    const arr = readFilterUI(); saveAdminFilter(arr); listenOrdersForAdmin();
  });
  document.getElementById('adminFilterReset')?.addEventListener('click', ()=>{
    const defaults = ['pending','accepted','rejected']; applyFilterToUI(defaults); saveAdminFilter(defaults); listenOrdersForAdmin();
  });
  // when modal opens we'll populate UI from saved filter (see header click handler)

  // bind admin filter control (re-run listener when toggled)
  const adminShowPaidEl = document.getElementById('adminShowPaid');
  if(adminShowPaidEl) adminShowPaidEl.addEventListener('change', ()=> { listenOrdersForAdmin(); });

  // ----- Helpers -----
  // No longer need CSV-related headers
  const norm = s => (s??"").toString().trim();
  const nk   = s => norm(s).toLowerCase().replace(/\s+/g,"").replace(/[._-]/g,"");

  const currencyTH = v => {
    const n=Number(String(v).replace(/[^\d.]/g,""));
    return isNaN(n)?norm(v):n.toLocaleString("th-TH");
  };

  function buildLineNote(details = {}) {
    const parts = [];
    if(details.orderId) parts.push(`Order#: ${details.orderId}`);
    if(details.program) parts.push(`Program: ${details.program}`);
    if(details.email) parts.push(`Email: ${details.email}`);
    if(details.username) parts.push(`Username: ${details.username}`);
    if(details.sn) parts.push(`SN: ${details.sn}`);
    if(details.imei) parts.push(`IMEI: ${details.imei}`);
    if(details.password) parts.push(`Password: ${details.password}`);
    if(details.additional && Array.isArray(details.additional)){
      details.additional.filter(Boolean).forEach(txt => parts.push(txt));
    } else if(details.additional){
      parts.push(details.additional);
    }
    return parts.join(" | ");
  }

  async function notifyLineOrder(payload){
    try{
      const res = await fetch('/order',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(!res.ok){
        const text = await res.text();
        console.error('LINE notify failed', text);
      }
    }catch(err){
      console.error('LINE notify error', err);
    }
  }

  function toNumber(v){ const n=Number(String(v).replace(/[^\d.]/g,"")); return isNaN(n)?0:n; }

  function groupByProgram(items){
    const g={};
    for(const it of items){
      const k=norm(it.program)||"อื่น ๆ";
      if(!g[k]) g[k]=[];
      g[k].push(it);
    }
    return g;
  }

  // Parse duration from a package name into months (number). Returns Infinity when unknown.
  function parseDurationMonths(s){
    if(!s) return Infinity;
    const txt = (s||"").toString().toLowerCase();
    // match patterns like '3 เดือน', '12 เดือน', '2 ปี'
    const reMonth = /([0-9]+(?:\.[0-9]+)?)\s*(เดือน|month|m)/i;
    const reYear = /([0-9]+(?:\.[0-9]+)?)\s*(ปี|year|y)/i;
    const m = txt.match(reMonth);
    if(m && m[1]) return Number(m[1]);
    const y = txt.match(reYear);
    if(y && y[1]) return Number(y[1]) * 12;
    // try to find standalone numbers (e.g., '3M', '12M')
    const reNum = /([0-9]+)\s*(?:m|mo|mons)?\b/i;
    const n = txt.match(reNum);
    if(n && n[1]) return Number(n[1]);
    return Infinity;
  }

  function rowsToItems(rows){
    if(!rows.length) throw new Error("ไม่พบข้อมูล CSV");
    const headers=rows[0];
    const map=mapHeaders(headers);
    return rows.slice(1)
      .filter(r=>r.length && r.some(c=>norm(c)!==""))
      .map((r,idx)=>({
        id: `csv_${idx}`,
        source: 'csv',
        program: r[map.program]??"",
        pack: r[map.pack]??"",
        price: toNumber(r[map.price]??0),
        image: map.image!=null? norm(r[map.image]): "",
        requiresEmail: map.requiresemail!=null ? /^(1|true|yes|y)$/i.test(String(r[map.requiresemail])) : false,
        requiresUsername: map.requiresusername!=null ? /^(1|true|yes|y)$/i.test(String(r[map.requiresusername])) : false,
        requiresSN: map.requiressn!=null ? /^(1|true|yes|y)$/i.test(String(r[map.requiressn])) : false,
        requiresIMEI: map.requireimei!=null ? /^(1|true|yes|y)$/i.test(String(r[map.requireimei])) : false
        ,requiresPassword: map.requirespassword!=null ? /^(1|true|yes|y)$/i.test(String(r[map.requirespassword])) : false
      }))
      .filter(x=>norm(x.program)&&norm(x.pack)&&x.price>0);
  }

  // ----- State -----
  const state = {
    currentUser: null, // auth user
    currentUserDoc: null, // user profile with credits
    isAdmin: false,
    products: [], // firestore products
    pendingOrder: null, // order in modal
    userOrdersUnsub: null, // unsubscribe for user's order stream
    adminOrdersUnsub: null, // unsubscribe for admin orders stream
    productsUnsub: null, // unsubscribe for products real-time updates
    cart: [], // [{id, program, pack(name), price, image, requiresEmail, emailForProduct?}],
    admin: {
      selectedProducts: new Set(),
      editedProducts: new Map(),
      productRefs: new Map()
    }
  };
  // Action to resume after login (e.g. confirm cart)
  let AFTER_LOGIN_ACTION = null;
  // Selection state for main-page selection (does NOT add to cart yet)
  let SELECTED_IDS = new Set();
  let CURRENT_DETAIL_PRODUCT = null; // product shown in inline detail panel
  // Admin product table state
  let selectedProducts = new Set();
  let editedProducts = new Map();
  let productRefs = new Map();

  function cartKey(){ return CURRENT_USER? `cart_${CURRENT_USER.uid}`: 'cart_guest'; }
  function loadCart(){
    try{
      if(CURRENT_USER){
        // merge guest cart into user cart when logging in
        const guest = JSON.parse(localStorage.getItem('cart_guest')||'[]');
        const userKey = `cart_${CURRENT_USER.uid}`;
        const userCart = JSON.parse(localStorage.getItem(userKey)||'[]');
        // merge preserving order: userCart first, then guest (guest items were added before login)
        const merged = Array.isArray(userCart) ? userCart.slice() : [];
        if(Array.isArray(guest) && guest.length){
          merged.push(...guest);
        }
        CART = merged;
        localStorage.setItem(userKey, JSON.stringify(merged));
        // remove guest key to avoid duplicate merges next login
        localStorage.removeItem('cart_guest');
      } else {
        CART = JSON.parse(localStorage.getItem('cart_guest')||'[]');
      }
    }catch{
      CART = [];
    }
  }
  function saveCart(){ localStorage.setItem(cartKey(), JSON.stringify(CART)); updateCartCount(); }
  function updateCartCount(){
    const btn = document.getElementById('cartBtn');
    const count = CART.length;
    if(btn){ btn.textContent = `ตะกร้า (${count})`; }
  }

  function render(groups, filter=""){
    const q=nk(filter);
    groupsEl.innerHTML="";
    let total=0;

    Object.entries(groups).forEach(([program,items])=>{
      let keep = items.filter(p=>!q || nk(program).includes(q) || nk(p.pack).includes(q));
      if(!keep.length) return;
      // Sort packages within the same program by duration (months) when detectable.
      keep.sort((a,b)=>{
        const da = parseDurationMonths(a.pack);
        const db = parseDurationMonths(b.pack);
        if(isFinite(da) && isFinite(db) && da !== db) return da - db;
        // if durations equal or unknown, sort by price ascending then name
        const pa = Number(a.price)||0; const pb = Number(b.price)||0;
        if(pa !== pb) return pa - pb;
        return (a.pack||'').localeCompare(b.pack||'', 'th');
      });
      total+=keep.length;

      const card=document.createElement("div");
      card.className="card-hover bg-white rounded-2xl p-6 shadow";
      card.innerHTML=`
        <div class="flex items-center justify-between mb-4">
          <div>
            <h4 class="text-xl font-semibold">${program}</h4>
            <p class="text-sm text-slate-500">เลือกสินค้าและสั่งซื้อด้วยเครดิต</p>
          </div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3" data-body></div>`;
      const body=card.querySelector("[data-body]");

keep.forEach(p=>{
  const item=document.createElement("div");
  item.className="border rounded-lg p-4 flex flex-col items-center text-center gap-2";
  item.innerHTML=`
    ${p.image? `<img data-open="1" src="${p.image}" alt="${p.pack}" class="w-40 object-cover rounded-md border cursor-pointer" style="aspect-ratio: 800/550;" />` : ''}
    <div data-open="1" class="font-semibold cursor-pointer">${p.pack}</div>
    <div class="text-2xl font-extrabold mt-1">฿${currencyTH(p.price)}</div>
    <button class="bg-indigo-600 text-white text-sm px-3 py-1.5 rounded-md mt-2">ดูรายละเอียด</button>
  `;
  const open = ()=> openProductModal(p);
  item.querySelector('button').addEventListener('click', open);
  const clickable = item.querySelectorAll('[data-open]');
  clickable.forEach(el=> el.addEventListener('click', open));
  body.appendChild(item);
});

groupsEl.appendChild(card);
    });

    emptyEl.classList.toggle("hidden", total>0);
  }

  function formatProducts(items) {
    // Convert products to normalized shape
    return items.map(p => ({
      id: p.id,
      program: p.program||'อื่น ๆ',
      pack: p.name||p.pack||'สินค้า',
      price: Number(p.price)||0,
      image: p.image||'',
      requiresEmail: !!p.requiresEmail,
      requiresUsername: !!p.requiresUsername,
      requiresSN: !!p.requiresSN,
      requiresIMEI: !!p.requiresIMEI,
      requiresPassword: !!p.requiresPassword
    })).filter(x => x.price > 0);
  }

  // Show inline product detail panel on main page (does not add to cart by itself)
  function showProductDetail(p){
    CURRENT_DETAIL_PRODUCT = p;
    const panel = document.getElementById('productDetail');
    document.getElementById('detailImage').src = p.image||'';
    document.getElementById('detailImage').classList.toggle('hidden', !p.image);
    document.getElementById('detailProgram').textContent = p.program||'';
    document.getElementById('detailName').textContent = p.pack||p.name||'';
    document.getElementById('detailPrice').textContent = currencyTH(p.price||0);
    const fields = document.getElementById('detailFields');
    // build dynamic inputs depending on required fields (email, username, SN, IMEI)
    fields.innerHTML = '';
    const addField = (id,label,type='text')=>{
      const wrap = document.createElement('div');
      wrap.innerHTML = `<label class="text-sm">${label}</label><input id="${id}" type="${type}" class="w-full border rounded p-2 text-sm" />`;
      fields.appendChild(wrap);
    };
    if(p.requiresEmail) addField('detailEmail','Email','email');
    if(p.requiresUsername) addField('detailUsername','Username','text');
    if(p.requiresSN) addField('detailSN','SN / Serial Number','text');
    if(p.requiresIMEI) addField('detailIMEI','IMEI','text');
  if(p.requiresPassword) addField('detailPassword','รหัสผ่าน','password');
    document.getElementById('detailMsg').textContent = '';
    panel.classList.remove('hidden');
    // scroll into view
    try{ panel.scrollIntoView({behavior:'smooth', block:'center'}); }catch{}
  }

  function hideProductDetail(){
    CURRENT_DETAIL_PRODUCT = null;
    document.getElementById('productDetail').classList.add('hidden');
  }

  function toggleSelected(p, btn){
    const id = p.id || (p.pack + '|' + p.program);
    if(SELECTED_IDS.has(id)){
      SELECTED_IDS.delete(id);
      if(btn) { btn.textContent = 'เลือกสินค้า'; btn.classList.remove('bg-amber-600'); btn.classList.add('bg-indigo-600'); }
    } else {
      SELECTED_IDS.add(id);
      if(btn) { btn.textContent = 'เลือกแล้ว'; btn.classList.add('bg-amber-600'); btn.classList.remove('bg-indigo-600'); }
      // show details when selected from main page
      showProductDetail(p);
    }
  }

  // Called from inline detail 'เพิ่มในตะกร้า'
  function addToCartFromDetail(){
    const p = CURRENT_DETAIL_PRODUCT;
    const msgEl = document.getElementById('detailMsg'); msgEl.textContent=''; msgEl.className='text-sm text-red-600';
    if(!p){ msgEl.textContent = 'ไม่พบสินค้า'; return; }
    // collect dynamic details
    const details = {
      emailForProduct: document.getElementById('detailEmail')?.value?.trim()||'',
      usernameForProduct: document.getElementById('detailUsername')?.value?.trim()||'',
      snForProduct: document.getElementById('detailSN')?.value?.trim()||'',
      imeiForProduct: document.getElementById('detailIMEI')?.value?.trim()||'',
      passwordForProduct: document.getElementById('detailPassword')?.value?.trim()||''
    };
    if(p.requiresEmail && !details.emailForProduct){ msgEl.textContent = 'กรุณากรอกอีเมลสำหรับสินค้านี้'; return; }
    if(p.requiresUsername && !details.usernameForProduct){ msgEl.textContent = 'กรุณากรอก Username สำหรับสินค้านี้'; return; }
    if(p.requiresSN && !details.snForProduct){ msgEl.textContent = 'กรุณากรอก SN/Serial สำหรับสินค้านี้'; return; }
    if(p.requiresIMEI && !details.imeiForProduct){ msgEl.textContent = 'กรุณากรอก IMEI สำหรับสินค้านี้'; return; }
  if(p.requiresPassword && !details.passwordForProduct){ msgEl.textContent = 'กรุณากรอก รหัสผ่านสำหรับสินค้านี้'; return; }
    // Add to cart (will open login modal if user not logged in)
    addToCart(p, details);
    msgEl.classList.remove('text-red-600'); msgEl.classList.add('text-emerald-700');
    msgEl.textContent = 'เพิ่มลงตะกร้าแล้ว';
    // clear selection for that product
    const id = p.id || (p.pack + '|' + p.program);
    if(SELECTED_IDS.has(id)) SELECTED_IDS.delete(id);
    // hide detail after short delay
    setTimeout(()=>{ hideProductDetail(); }, 800);
  }

  async function setupFirestoreProducts() {
    const colRef = collection(db, 'products');
    return onSnapshot(colRef, (snap) => {
      FS_PRODUCTS = snap.docs.map(d => ({
        id: d.id,
        program: d.data().program || 'อื่น ๆ',
        pack: d.data().name || d.data().pack || 'สินค้า',
        price: Number(d.data().price) || 0,
        image: d.data().image || '',
        requiresEmail: !!d.data().requiresEmail,
        requiresUsername: !!d.data().requiresUsername,
        requiresSN: !!d.data().requiresSN,
        requiresIMEI: !!d.data().requiresIMEI,
        requiresPassword: !!d.data().requiresPassword
      })).filter(x => x.price > 0);
      render(groupByProgram(FS_PRODUCTS), searchEl?.value || "");
    });
  }

  function updateHeaderAuth(){
    const bal = CURRENT_USER_DOC?.credits || 0;
    // Rebuild header actions every time to avoid stale elements
    if(CURRENT_USER){
      headerRight.innerHTML = `
        <div class="flex items-center gap-3">
            <div id="userInfo" class="text-sm text-slate-700">${CURRENT_USER.email||''}</div>
            <div id="balanceInfo" class="text-sm font-semibold text-indigo-700">เครดิต: ${currencyTH(bal)}</div>
            <button id="topupBtn" class="bg-emerald-600 text-white text-sm px-3 py-2 rounded-md">เติมเครดิต</button>
            <button id="cartBtn" class="bg-indigo-50 text-indigo-700 text-sm px-3 py-2 rounded-md shadow">ตะกร้า (0)</button>
            <button id="historyBtn" class="bg-slate-100 text-slate-700 text-sm px-3 py-2 rounded-md shadow">ประวัติการสั่งซื้อ</button>
            <button id="adminOrdersBtn" class="bg-amber-100 text-amber-800 text-sm px-3 py-2 rounded-md shadow">คำสั่งซื้อ (Admin)</button>
            <button id="openAdminCreditBtn" class="bg-emerald-500 text-white text-sm px-3 py-2 rounded-md shadow">เติมเครดิตลูกค้า</button>
            <button id="openAdminProductBtn" class="bg-indigo-600 text-white text-sm px-3 py-2 rounded-md shadow">เพิ่มสินค้า</button>
            <button id="logoutBtn" class="bg-slate-200 text-slate-700 text-sm px-3 py-2 rounded-md shadow">ออกจากระบบ</button>
          </div>`;
      const topupBtn   = document.getElementById('topupBtn');
      const historyBtn = document.getElementById('historyBtn');
      const cartBtn    = document.getElementById('cartBtn');
      const logoutBtn  = document.getElementById('logoutBtn');
      const adminOrdersBtn = document.getElementById('adminOrdersBtn');
      const openAdminCreditBtn = document.getElementById('openAdminCreditBtn');
      const openAdminProductBtn = document.getElementById('openAdminProductBtn');
    if(topupBtn){ topupBtn.addEventListener('click', ()=>{ if(!CURRENT_USER){ openLoginModal(); return; } const tmodal = document.getElementById('topupModal'); if(tmodal) tmodal.classList.add('active'); }); }
    historyBtn.addEventListener('click', openHistoryModal);
    cartBtn.addEventListener('click', openCartModal);
    if(adminOrdersBtn){ adminOrdersBtn.addEventListener('click', ()=>{ 
      // open admin orders modal with previously saved filter (or defaults)
      try{ const saved = getSavedAdminFilter(); if(saved) applyFilterToUI(saved); else applyFilterToUI(['pending','accepted','rejected']); }catch{}
      document.getElementById('adminOrdersModal')?.classList.add('active'); 
      listenOrdersForAdmin(); 
    }); }
    if(openAdminCreditBtn){ openAdminCreditBtn.addEventListener('click', ()=>{ document.getElementById('adminCreditModal')?.classList.add('active'); }); }
    if(openAdminProductBtn){ openAdminProductBtn.addEventListener('click', ()=>{ document.getElementById('adminProductModal')?.classList.add('active'); }); }
      updateCartCount();
      logoutBtn.addEventListener('click', async ()=>{
        try{ await signOut(auth); } finally { CURRENT_USER=null; CURRENT_USER_DOC=null; IS_ADMIN=false; updateHeaderAuth(); }
      });
    }else{
      // show cart to guests as well so they can inspect what they added
      headerRight.innerHTML = `
        <div class="flex items-center gap-3">
          <div id="userInfo" class="text-sm text-slate-700 hidden"></div>
          <div id="balanceInfo" class="text-sm font-semibold text-indigo-700 hidden"></div>
          <button id="cartBtn" class="bg-indigo-50 text-indigo-700 text-sm px-3 py-2 rounded-md shadow">ตะกร้า (0)</button>
          <button id="registerBtn" class="bg-emerald-600 text-white text-sm px-4 py-2 rounded-md shadow">สมัครสมาชิก</button>
          <button id="loginBtn" class="bg-indigo-600 text-white text-sm px-4 py-2 rounded-md shadow">เข้าสู่ระบบ</button>
        </div>`;
      const registerBtn = document.getElementById('registerBtn');
      const loginBtn    = document.getElementById('loginBtn');
      const cartBtn     = document.getElementById('cartBtn');
      registerBtn.addEventListener('click', openRegModal);
      loginBtn.addEventListener('click', openLoginModal);
      cartBtn.addEventListener('click', openCartModal);
      updateCartCount();
    }
  // adminSection was removed from the main page — no inline admin panel to toggle
  }

  async function ensureUserProfile(u){
    const ref = doc(db,'users',u.uid);
    const snap = await getDoc(ref);
    if(!snap.exists()){
      const rawEmail = (u.email||'');
      await setDoc(ref,{
        email: rawEmail,
        emailLower: rawEmail.toLowerCase(),
        credits: 0,
        createdAt: serverTimestamp()
      });
      return (await getDoc(ref)).data();
    }
    return snap.data();
  }

  async function bootstrapFirestoreAfterSignup(u){
    try{
      const cfgRef = doc(db,'config','app');
      const cfg = await getDoc(cfgRef);
      if(!cfg.exists()){
        await setDoc(cfgRef,{
          initializedAt: serverTimestamp(),
          initializedBy: (u.email||'').toLowerCase()
        });
        // Optional: seed an example product so the DB is ready
        try{
          await addDoc(collection(db,'products'),{
            program: 'ตัวอย่าง',
            name: 'สินค้าแรก',
            price: 1,
            image: '',
            requiresEmail: false,
            createdAt: serverTimestamp()
          });
        }catch{}
      }
    }catch(e){ console.warn('bootstrap error', e?.message||e); }
  }

  function openRegModal(){ regModal.classList.add('active'); }
  function closeRegModal(){ regModal.classList.remove('active'); }
  function openLoginModal(){ loginModal.classList.add('active'); }
  function closeLoginModal(){ loginModal.classList.remove('active'); }

  function openOrderModal(product){
    if(!CURRENT_USER){
      // save pending single-product order so after login user can continue purchase
      PENDING_ORDER = product;
      AFTER_LOGIN_ACTION = { action: 'singleOrder' };
      openLoginModal();
      return;
    }
    PENDING_ORDER = product;
    const bal = CURRENT_USER_DOC?.credits || 0;
    const can = bal >= Number(product.price||0);
    document.getElementById('orderSummary').innerHTML = `
      <div>สินค้า: <strong>${product.pack}</strong></div>
      <div>ราคา: <strong>${currencyTH(product.price)}</strong> เครดิต</div>
      <div>เครดิตคงเหลือ: <strong>${currencyTH(bal)}</strong></div>
      <div class="${can? 'text-emerald-600':'text-red-600'}">${can? 'สามารถสั่งซื้อได้':'เครดิตไม่เพียงพอ'}</div>`;
    document.getElementById('orderEmailBlock').classList.toggle('hidden', !product.requiresEmail);
    document.getElementById('orderEmailInput').value = '';
    document.getElementById('orderPasswordBlock').classList.toggle('hidden', !product.requiresPassword);
    document.getElementById('orderPasswordInput').value = '';
    document.getElementById('orderMsg').textContent='';
    orderModal.classList.add('active');
  }
  function closeOrder(){ orderModal.classList.remove('active'); PENDING_ORDER=null; }
  function openHistoryModal(){
    if(!CURRENT_USER){ openLoginModal(); return; }
    const list = document.getElementById('ordersTbody');
    if(list) list.innerHTML = '<tr><td colspan="5" class="p-4 text-slate-500">กำลังโหลด...</td></tr>';
    historyModal.classList.add('active');
    // Fetch once in case snapshot hasn't arrived yet
    try {
      const qref = query(collection(db,'orders'), where('userId','==', CURRENT_USER.uid));
      getDocs(qref).then(snap=>{
        const rows = snap.docs.map(d=>({id:d.id, ...d.data()}));
        renderUserHistory(rows);
        // (removed top-up button from history modal; top-up handled via separate UI)
      });
    } catch {}
  }
  function closeHistoryModal(){ historyModal.classList.remove('active'); }

  async function placeOrder(){
    if(!PENDING_ORDER||!CURRENT_USER) return;
    const uref = doc(db,'users',CURRENT_USER.uid);
    const usnap = await getDoc(uref);
    const profile = usnap.data();
    const bal = profile?.credits||0;
    const price = Number(PENDING_ORDER.price||0);
    const emailForProduct = document.getElementById('orderEmailInput').value.trim();
    const passwordForProduct = document.getElementById('orderPasswordInput')?.value?.trim()||'';
    if(PENDING_ORDER.requiresEmail && !emailForProduct){
      document.getElementById('orderMsg').textContent = 'กรุณากรอกอีเมลสำหรับสินค้านี้';
      return;
    }
    if(PENDING_ORDER.requiresPassword && !passwordForProduct){
      document.getElementById('orderMsg').textContent = 'กรุณากรอกรหัสผ่านสำหรับสินค้านี้';
      return;
    }
    if(bal < price){
      document.getElementById('orderMsg').textContent = 'เครดิตไม่เพียงพอ';
      return;
    }
    const orderRef = await addDoc(collection(db,'orders'),{
      userId: CURRENT_USER.uid,
      userEmail: (CURRENT_USER.email||'').toLowerCase(),
      status: 'pending',
      product: {
        id: PENDING_ORDER.id,
        name: PENDING_ORDER.pack,
        program: PENDING_ORDER.program,
        price: price,
        image: PENDING_ORDER.image||'',
        requiresEmail: !!PENDING_ORDER.requiresEmail,
        source: PENDING_ORDER.source||'firestore'
      },
      emailForProduct: emailForProduct||'',
      passwordForProduct: passwordForProduct||'',
      createdAt: serverTimestamp()
    });
    const lineName = CURRENT_USER?.email || CURRENT_USER_DOC?.email || 'customer';
    const lineNote = buildLineNote({
      orderId: orderRef.id,
      program: PENDING_ORDER.program,
      email: emailForProduct || CURRENT_USER?.email || '',
      password: passwordForProduct
    });
    notifyLineOrder({
      name: lineName,
      product: PENDING_ORDER.pack,
      qty: 1,
      total: currencyTH(price),
      note: lineNote
    });
    document.getElementById('orderMsg').classList.remove('text-red-600');
    document.getElementById('orderMsg').classList.add('text-emerald-700');
    document.getElementById('orderMsg').textContent = 'ส่งคำสั่งซื้อแล้ว กำลังรอผู้ดูแลยืนยัน';
    setTimeout(closeOrder, 1000);
  }

  function listenOrdersForAdmin(){
    const listEl = document.getElementById('adminOrdersList') || document.getElementById('ordersList');
    if(!IS_ADMIN){ listEl.innerHTML=''; return; }
    // unsubscribe previous admin listener if present
    try{ if(typeof ADMIN_ORDERS_UNSUB === 'function'){ ADMIN_ORDERS_UNSUB(); ADMIN_ORDERS_UNSUB = null; } }catch{}
    // Determine statuses to query based on admin checkbox (include paid only if checked)
    // read statuses from saved filter (modal) or fallback to previous adminShowPaid checkbox
    let saved = getSavedAdminFilter();
    let statuses = null;
    if(saved && Array.isArray(saved) && saved.length>0){ statuses = saved; }
    else {
      const showPaid = !!document.getElementById('adminShowPaid')?.checked;
      statuses = showPaid ? ['pending','accepted','rejected','paid'] : ['pending','accepted','rejected'];
    }
    const qref = query(collection(db,'orders'), where('status','in', statuses));
    ADMIN_ORDERS_UNSUB = onSnapshot(qref, (snap)=>{
      listEl.innerHTML = '';
      if(!snap.docs.length){
        listEl.innerHTML = '<div class="text-slate-500 p-2">ไม่มีคำสั่งซื้อที่กำลังดำเนินการ / สำเร็จ / ไม่สำเร็จ</div>';
        return;
      }
      // build table header
      const table = document.createElement('table');
      table.className = 'w-full text-sm border-collapse';
      table.innerHTML = `
        <thead>
          <tr class="text-left border-b">
            <th class="p-2">สินค้า</th>
            <th class="p-2">ราคา</th>
            <th class="p-2">ลูกค้า</th>
            <th class="p-2">สถานะ</th>
            <th class="p-2">วันที่</th>
            <th class="p-2">Order Reply</th>
            <th class="p-2">จัดการ</th>
          </tr>
        </thead>`;
      const tbody = document.createElement('tbody');
      tbody.className = 'text-slate-700';

      snap.docs.forEach(d=>{
        const data = d.data();
        const status = (data.status||'').toString();
        let statusLabel = status;
        let statusClass = 'bg-slate-100 text-slate-700';
        if(status === 'pending'){ statusLabel = 'กำลังดำเนินการ'; statusClass = 'bg-amber-200 text-amber-800'; }
        else if(status === 'accepted'){ statusLabel = 'สำเร็จ'; statusClass = 'bg-emerald-200 text-emerald-800'; }
        else if(status === 'rejected'){ statusLabel = 'ไม่สำเร็จ'; statusClass = 'bg-red-200 text-red-800'; }
        else if(status === 'paid'){ statusLabel = 'ชำระแล้ว'; statusClass = 'bg-sky-100 text-sky-800'; }

        const prodName = data.product?.name || data.pack || data.name || '-';
        const prodPrice = Number(data.product?.price || data.price || 0);
        const ts = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString('th-TH') : (data.createdAt? String(data.createdAt): '');
        const reply = data.reply || data.orderReply || data.adminMessage || data.resultMessage || data.message || data.note || '';

        const tr = document.createElement('tr');
        tr.className = 'border-b';
        tr.innerHTML = `
          <td class="p-2 align-top">${escapeHtml(prodName)}</td>
          <td class="p-2 align-top">${currencyTH(prodPrice)}</td>
          <td class="p-2 align-top">${escapeHtml(data.userEmail||data.userId)}</td>
          <td class="p-2 align-top"><span class="px-2 py-1 rounded ${statusClass} text-sm">${escapeHtml(statusLabel)}</span></td>
          <td class="p-2 align-top">${escapeHtml(ts)}</td>
          <td class="p-2 align-top"><div class="text-sm">${escapeHtml(reply)}</div></td>
          <td class="p-2 align-top">
            <div class="flex flex-col gap-2">
              <textarea data-reply-id="${d.id}" class="w-full border rounded p-1 text-sm" rows="2" placeholder="Order Reply">${escapeHtml(reply)}</textarea>
              <div class="flex gap-2">
                <button data-accept-id="${d.id}" class="bg-emerald-600 text-white text-xs px-2 py-1 rounded">Accept</button>
                <button data-reject-id="${d.id}" class="bg-red-500 text-white text-xs px-2 py-1 rounded">Reject</button>
              </div>
              <div data-msg-id="${d.id}" class="text-sm"></div>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      listEl.appendChild(table);

      // attach listeners
      listEl.querySelectorAll('[data-accept-id]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-accept-id');
          const replyBox = listEl.querySelector(`[data-reply-id="${id}"]`);
          const msgEl = listEl.querySelector(`[data-msg-id="${id}"]`);
          msgEl.textContent = 'กำลังบันทึก...'; btn.disabled = true;
          try{
            const docSnap = await getDoc(doc(db,'orders',id));
            const data = docSnap.data();
            await adminAcceptOrder(id, data, replyBox.value.trim());
            msgEl.className = 'text-emerald-700'; msgEl.textContent = 'บันทึกแล้ว';
          }catch(err){ console.error(err); msgEl.className='text-red-600'; msgEl.textContent = err.message||'ล้มเหลว'; }
          finally{ btn.disabled=false; setTimeout(()=> msgEl.textContent='',2000); }
        });
      });

      listEl.querySelectorAll('[data-reject-id]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-reject-id');
          const replyBox = listEl.querySelector(`[data-reply-id="${id}"]`);
          const msgEl = listEl.querySelector(`[data-msg-id="${id}"]`);
          msgEl.textContent = 'กำลังบันทึก...'; btn.disabled = true;
          try{
            await adminRejectOrder(id, replyBox.value.trim());
            msgEl.className = 'text-emerald-700'; msgEl.textContent = 'บันทึกแล้ว';
          }catch(err){ console.error(err); msgEl.className='text-red-600'; msgEl.textContent = err.message||'ล้มเหลว'; }
          finally{ btn.disabled=false; setTimeout(()=> msgEl.textContent='',2000); }
        });
      });
    }, async (err)=>{
      console.error('orders listener error', err);
      listEl.innerHTML = `<div class="text-red-600 p-2">เกิดข้อผิดพลาดในการอ่านคำสั่งซื้อ: ${err.message}</div>`;
    });
  }

  async function adminAcceptOrder(orderId, data, reply){
    // Accept order: do NOT deduct credits here (credits already deducted at order creation).
    // Just update order status and optional reply/time.
    const oref = doc(db,'orders',orderId);
    const payload = { status: 'accepted', acceptedAt: serverTimestamp() };
    if(reply) payload.reply = reply;
    await updateDoc(oref, payload);
  }

  async function adminRejectOrder(orderId, reply){
    const oref = doc(db,'orders',orderId);
    // Refund credits to user and mark order refunded atomically to avoid double refunds
    await runTransaction(db, async (tx) => {
      const osnap = await tx.get(oref);
      if(!osnap.exists()) throw new Error('ไม่พบคำสั่งซื้อ');
      const odata = osnap.data();
      if(odata.refunded) {
        // already refunded, just update status/reply if needed
        const payload = { status: 'rejected', rejectedAt: serverTimestamp() };
        if(reply) payload.reply = reply;
        tx.update(oref, payload);
        return;
      }
      const uid = odata.userId;
      const price = Number(odata.product?.price || 0);
      const uref = doc(db,'users', uid);
      const usnap = await tx.get(uref);
      if(!usnap.exists()) throw new Error('ไม่พบข้อมูลผู้ใช้ที่จะคืนเครดิต');
      const currentCredits = Number(usnap.data()?.credits || 0);
      // update user credits and order doc
      tx.update(uref, { credits: currentCredits + price });
      const payload = { status: 'rejected', rejectedAt: serverTimestamp(), refunded: true, refundedAt: serverTimestamp() };
      if(reply) payload.reply = reply;
      tx.update(oref, payload);
    });
  }

  async function addCreditsByEmail(email, amount){
    const qref = query(collection(db,'users'), where('emailLower','==', (email||'').toLowerCase()));
    const snap = await getDocs(qref);
    if(snap.empty) throw new Error('ไม่พบผู้ใช้ตามอีเมล');
    const d = snap.docs[0];
    await updateDoc(doc(db,'users',d.id),{ credits: increment(Number(amount)||0) });
  }

  async function addProductFS(p){
    await addDoc(collection(db,'products'),{
      program: norm(p.program),
      name: norm(p.name),
      price: Number(p.price)||0,
      image: norm(p.image||''),
      requiresEmail: !!p.requiresEmail,
      requiresPassword: !!p.requiresPassword,
      requiresUsername: !!p.requiresUsername,
      requiresSN: !!p.requiresSN,
      requiresIMEI: !!p.requiresIMEI,
      createdAt: serverTimestamp()
    });
  }

  // ----- Cart functions -----
  function addToCart(p, details={}){
    const item = {
      id: p.id,
      source: p.source||'firestore',
      program: p.program,
      name: p.pack||p.name,
      price: Number(p.price)||0,
      image: p.image||'',
      requiresEmail: !!p.requiresEmail,
      requiresUsername: !!p.requiresUsername,
      requiresSN: !!p.requiresSN,
      requiresIMEI: !!p.requiresIMEI,
      emailForProduct: details.emailForProduct||'',
      usernameForProduct: details.usernameForProduct||'',
      snForProduct: details.snForProduct||'',
      imeiForProduct: details.imeiForProduct||'',
      passwordForProduct: details.passwordForProduct||''
    };
    CART.push(item);
    saveCart();
    openCartModal();
  }

  function openCartModal(){
    // allow guests to open and inspect cart; require login only at confirmation
    renderCart();
    cartModal.classList.add('active');
  }
  function closeCartModal(){ cartModal.classList.remove('active'); }

  let PRODUCT_SELECTED = null;
  function openProductModal(p){
    // allow viewing product modal even when not logged in
    PRODUCT_SELECTED = p;
    document.getElementById('pdImage').src = p.image||'';
    document.getElementById('pdImage').classList.toggle('hidden', !p.image);
    document.getElementById('pdProgram').textContent = p.program||'';
    document.getElementById('pdName').textContent = p.pack||p.name||'';
    document.getElementById('pdPrice').textContent = currencyTH(p.price||0);
    const fields = document.getElementById('pdFields');
    fields.innerHTML='';
    const addField = (id,label,type='text')=>{
      const wrap=document.createElement('div');
      wrap.innerHTML = `<label class="text-sm">${label}</label><input id="${id}" type="${type}" class="w-full border rounded p-2 text-sm" />`;
      fields.appendChild(wrap);
    };
    if(p.requiresEmail) addField('pdEmail','Email');
    if(p.requiresUsername) addField('pdUsername','Username');
    if(p.requiresSN) addField('pdSN','SN / Serial Number');
    if(p.requiresIMEI) addField('pdIMEI','IMEI');
    if(p.requiresPassword) addField('pdPassword','รหัสผ่าน','password');
    document.getElementById('pdMsg').textContent='';
    productModal.classList.add('active');
  }
  function closeProductModal(){ productModal.classList.remove('active'); PRODUCT_SELECTED=null; }

  function renderCart(){
    const list = document.getElementById('cartList');
    const totalEl = document.getElementById('cartTotal');
    const msg = document.getElementById('cartMsg');
    msg.textContent=''; msg.className='mt-2 text-sm';
    if(!CART.length){ list.innerHTML = '<div class="text-slate-500">ตะกร้าว่าง</div>'; totalEl.textContent='0'; updateCartCount(); return; }
    list.innerHTML='';
    let sum=0;
    CART.forEach((it,idx)=>{
      sum += Number(it.price)||0;
      const row=document.createElement('div');
      row.className='border rounded p-3 flex gap-3 items-start';
      row.innerHTML = `
        ${it.image? `<img src="${it.image}" class="w-12 h-12 rounded object-cover border" />`:''}
        <div class="flex-1">
          <div class="font-semibold">${it.name} <span class="text-slate-500">• ${currencyTH(it.price)} เครดิต</span></div>
          ${it.requiresEmail? `<div class="mt-2"><input data-email-index="${idx}" type="email" value="${it.emailForProduct||''}" placeholder="อีเมลสำหรับสินค้านี้" class="w-full border rounded p-2 text-sm" /></div>`:''}
          ${it.requiresUsername? `<div class="mt-2"><input data-username-index="${idx}" type="text" value="${it.usernameForProduct||''}" placeholder="Username" class="w-full border rounded p-2 text-sm" /></div>`:''}
          ${it.requiresSN? `<div class="mt-2"><input data-sn-index="${idx}" type="text" value="${it.snForProduct||''}" placeholder="SN / Serial" class="w-full border rounded p-2 text-sm" /></div>`:''}
          ${it.requiresIMEI? `<div class="mt-2"><input data-imei-index="${idx}" type="text" value="${it.imeiForProduct||''}" placeholder="IMEI" class="w-full border rounded p-2 text-sm" /></div>`:''}
          ${it.requiresPassword? `<div class="mt-2"><input data-password-index="${idx}" type="password" value="${it.passwordForProduct||''}" placeholder="รหัสผ่านสำหรับสินค้านี้" class="w-full border rounded p-2 text-sm" /></div>`:''}
        </div>
        <button data-remove-index="${idx}" class="text-red-600 text-sm">ลบ</button>`;
      list.appendChild(row);
    });
    totalEl.textContent = currencyTH(sum);
    // bind events
    list.querySelectorAll('[data-remove-index]').forEach(btn=>{
      btn.addEventListener('click', e=>{
        const i = Number(e.currentTarget.getAttribute('data-remove-index'));
        CART.splice(i,1); saveCart(); renderCart();
      });
    });
    list.querySelectorAll('[data-email-index]').forEach(inp=>{
      inp.addEventListener('input', e=>{
        const i = Number(e.currentTarget.getAttribute('data-email-index'));
        CART[i].emailForProduct = e.currentTarget.value;
        saveCart();
      });
    });
    list.querySelectorAll('[data-username-index]').forEach(inp=>{
      inp.addEventListener('input', e=>{
        const i = Number(e.currentTarget.getAttribute('data-username-index'));
        CART[i].usernameForProduct = e.currentTarget.value;
        saveCart();
      });
    });
    list.querySelectorAll('[data-sn-index]').forEach(inp=>{
      inp.addEventListener('input', e=>{
        const i = Number(e.currentTarget.getAttribute('data-sn-index'));
        CART[i].snForProduct = e.currentTarget.value;
        saveCart();
      });
    });
    list.querySelectorAll('[data-imei-index]').forEach(inp=>{
      inp.addEventListener('input', e=>{
        const i = Number(e.currentTarget.getAttribute('data-imei-index'));
        CART[i].imeiForProduct = e.currentTarget.value;
        saveCart();
      });
    });
    list.querySelectorAll('[data-password-index]').forEach(inp=>{
      inp.addEventListener('input', e=>{
        const i = Number(e.currentTarget.getAttribute('data-password-index'));
        CART[i].passwordForProduct = e.currentTarget.value;
        saveCart();
      });
    });
  }

  // ปุ่มยืนยันการสั่งซื้อจากตะกร้า: ตรวจสอบการล็อกอิน, ฟิลด์ที่ต้องกรอก, เครดิต แล้วสร้างคำสั่งซื้อ
  async function confirmCartOrders(){
    const msg = document.getElementById('cartMsg'); msg.textContent=''; msg.className='mt-2 text-sm';
    if(!CURRENT_USER){
      // require login; after login return user to the cart so they can explicitly confirm
      AFTER_LOGIN_ACTION = { action: 'openCart' };
      openLoginModal();
      return;
    }
    if(!CART.length){ msg.classList.add('text-slate-500'); msg.textContent = 'ตะกร้าว่าง'; return; }
    // validate required fields for each item
    for(let i=0;i<CART.length;i++){
      const it = CART[i];
      if(it.requiresEmail && !it.emailForProduct){ msg.classList.add('text-red-600'); msg.textContent = `กรุณากรอกอีเมลสำหรับ: ${it.name}`; return; }
      if(it.requiresUsername && !it.usernameForProduct){ msg.classList.add('text-red-600'); msg.textContent = `กรุณากรอก Username สำหรับ: ${it.name}`; return; }
      if(it.requiresSN && !it.snForProduct){ msg.classList.add('text-red-600'); msg.textContent = `กรุณากรอก SN/Serial สำหรับ: ${it.name}`; return; }
      if(it.requiresIMEI && !it.imeiForProduct){ msg.classList.add('text-red-600'); msg.textContent = `กรุณากรอก IMEI สำหรับ: ${it.name}`; return; }
      if(it.requiresPassword && !it.passwordForProduct){ msg.classList.add('text-red-600'); msg.textContent = `กรุณากรอก รหัสผ่านสำหรับ: ${it.name}`; return; }
    }
    const total = CART.reduce((s,it)=> s + Number(it.price||0), 0);
    const lineOrders = CART.map(it => ({
      product: it.name,
      program: it.program,
      price: Number(it.price)||0,
      email: it.emailForProduct || CURRENT_USER?.email || '',
      username: it.usernameForProduct || '',
      sn: it.snForProduct || '',
      imei: it.imeiForProduct || '',
      password: it.passwordForProduct || ''
    }));
    const lineName = CURRENT_USER?.email || CURRENT_USER_DOC?.email || 'customer';
    try{
      // Transaction: deduct user credits and create paid orders atomically
      await runTransaction(db, async (tx)=>{
        const uref = doc(db,'users',CURRENT_USER.uid);
        const usnap = await tx.get(uref);
        const bal = (usnap.data()?.credits) || 0;
        if(bal < total) throw new Error('เครดิตไม่เพียงพอ');
        tx.update(uref, { credits: bal - total });
        const ocol = collection(db,'orders');
        for(let idx=0; idx<CART.length; idx++){
          const it = CART[idx];
          const oref = doc(ocol);
          if(lineOrders[idx]) lineOrders[idx].orderId = oref.id;
          tx.set(oref, {
            userId: CURRENT_USER.uid,
            userEmail: (CURRENT_USER.email||'').toLowerCase(),
            status: 'pending',
            product: {
              id: it.id,
              name: it.name,
              program: it.program,
              price: Number(it.price)||0,
              image: it.image||'',
              requiresEmail: !!it.requiresEmail,
              requiresUsername: !!it.requiresUsername,
              requiresSN: !!it.requiresSN,
              requiresIMEI: !!it.requiresIMEI,
              source: it.source||'firestore'
            },
            emailForProduct: it.emailForProduct||'',
            usernameForProduct: it.usernameForProduct||'',
            snForProduct: it.snForProduct||'',
            imeiForProduct: it.imeiForProduct||'',
            passwordForProduct: it.passwordForProduct||'',
            createdAt: serverTimestamp()
          });
        }
      });
      lineOrders.forEach(item => {
        const note = buildLineNote(item);
        notifyLineOrder({
          name: lineName,
          product: item.product,
          qty: 1,
          total: currencyTH(item.price),
          note
        });
      });
      // update local state and UI
      if(!CURRENT_USER_DOC) CURRENT_USER_DOC = { credits: 0 };
      CURRENT_USER_DOC.credits = (CURRENT_USER_DOC.credits || 0) - total;
      CART = []; saveCart(); renderCart(); updateHeaderAuth();
      msg.classList.add('text-emerald-700'); msg.textContent = 'สั่งซื้อสำเร็จ: หักเครดิตเรียบร้อยแล้ว';
      setTimeout(()=>{ closeCartModal(); }, 900);
    }catch(e){ msg.classList.add('text-red-600'); msg.textContent = e.message || 'เกิดข้อผิดพลาดในการทำรายการ'; }
  }

  document.getElementById('continueShopping')?.addEventListener('click', ()=>{ confirmCartOrders(); });

  // Buy now (immediate charge) from product modal
  document.getElementById('pdAddCart').addEventListener('click', ()=>{
    if(!PRODUCT_SELECTED){ return; }
    const msg = document.getElementById('pdMsg'); msg.textContent=''; msg.className='text-sm';
    const details = {
      emailForProduct: document.getElementById('pdEmail')?.value?.trim()||'',
      usernameForProduct: document.getElementById('pdUsername')?.value?.trim()||'',
      snForProduct: document.getElementById('pdSN')?.value?.trim()||'',
      imeiForProduct: document.getElementById('pdIMEI')?.value?.trim()||'',
      passwordForProduct: document.getElementById('pdPassword')?.value?.trim()||''
    };
    if(PRODUCT_SELECTED.requiresEmail && !details.emailForProduct){ msg.classList.add('text-red-600'); msg.textContent='กรุณากรอก Email'; return; }
    if(PRODUCT_SELECTED.requiresUsername && !details.usernameForProduct){ msg.classList.add('text-red-600'); msg.textContent='กรุณากรอก Username'; return; }
    if(PRODUCT_SELECTED.requiresSN && !details.snForProduct){ msg.classList.add('text-red-600'); msg.textContent='กรุณากรอก SN/Serial'; return; }
    if(PRODUCT_SELECTED.requiresIMEI && !details.imeiForProduct){ msg.classList.add('text-red-600'); msg.textContent='กรุณากรอก IMEI'; return; }
    if(PRODUCT_SELECTED.requiresPassword && !details.passwordForProduct){ msg.classList.add('text-red-600'); msg.textContent='กรุณากรอก รหัสผ่าน'; return; }
    addToCart(PRODUCT_SELECTED, details);
    closeProductModal();
  });

  // ----- Events -----
  searchEl.addEventListener("input", ()=>render(groupByProgram(FS_PRODUCTS), searchEl.value));
  contactBtn.addEventListener("click", ()=> modal.classList.add("active"));
  closeBtn.addEventListener("click", ()=> modal.classList.remove("active"));
  modal.addEventListener("click", (e)=>{ if(e.target===modal) modal.classList.remove("active"); });

  document.getElementById('registerBtn').addEventListener('click', openRegModal);
  document.getElementById('loginBtn').addEventListener('click', openLoginModal);
  document.getElementById('logoutBtn').addEventListener('click', async ()=>{
    try{ await signOut(auth); }
    finally{
      // อัปเดตปุ่มทันทีหลังออกจากระบบ
      CURRENT_USER = null; CURRENT_USER_DOC = null; IS_ADMIN = false;
      updateHeaderAuth();
    }
  });
  document.getElementById('closeReg').addEventListener('click', closeRegModal);
  regModal.addEventListener('click',(e)=>{ if(e.target===regModal) closeRegModal(); });
  document.getElementById('doRegister').addEventListener('click', async ()=>{
    const email = document.getElementById('authEmailR').value.trim();
    const pass = document.getElementById('authPassR').value;
    const pass2 = document.getElementById('authPass2R').value;
    const msg = document.getElementById('authMsgR'); msg.textContent=''; msg.className='text-sm';
    if(!email){ msg.textContent='กรุณากรอกอีเมล'; return; }
    if(!pass){ msg.textContent='กรุณากรอกรหัสผ่าน'; return; }
    if(pass !== pass2){ msg.textContent='รหัสผ่านไม่ตรงกัน'; return; }
    try{
      const cred = await createUserWithEmailAndPassword(auth,email,pass);
      // Create user profile in background; ignore failures here (rules may block)
      try { CURRENT_USER_DOC = await ensureUserProfile(cred.user); await bootstrapFirestoreAfterSignup(cred.user); updateHeaderAuth(); } catch(_) {}
      // Show success then leave registration
      msg.textContent = 'สมัครสมาชิกสำเร็จ';
      msg.classList.add('text-emerald-700');
      setTimeout(()=>{ closeRegModal(); }, 900);
    }catch(e){ msg.textContent = e.message; }
  });
  document.getElementById('closeLogin').addEventListener('click', closeLoginModal);
  loginModal.addEventListener('click',(e)=>{ if(e.target===loginModal) closeLoginModal(); });
  document.getElementById('doLogin').addEventListener('click', async ()=>{
    const email = document.getElementById('authEmailL').value.trim();
    const pass = document.getElementById('authPassL').value;
    const msg = document.getElementById('authMsgL'); msg.textContent='';
    try{
      const cred = await signInWithEmailAndPassword(auth,email,pass);
      // Close modal immediately on successful login
      closeLoginModal();
      // Ensure profile exists in background; ignore failures
      try { CURRENT_USER_DOC = await ensureUserProfile(cred.user); updateHeaderAuth(); } catch(_) {}
    }catch(e){ msg.textContent = e.message; }
  });

  // escape HTML to avoid injection when rendering arbitrary text
  function escapeHtml(str){
    if(!str && str !== 0) return '';
    return String(str)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');
  }

  function renderUserHistory(docs){
    const tbody = document.getElementById('ordersTbody');
    if(!tbody) return;
    if(!docs.length){ tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-slate-500">ยังไม่มีคำสั่งซื้อ</td></tr>'; return; }
    // sort by createdAt desc client-side
    docs.sort((a,b)=>{
      const ta = a.createdAt?.toMillis?.() || 0;
      const tb = b.createdAt?.toMillis?.() || 0;
      return tb - ta;
    });
    tbody.innerHTML = '';
    docs.forEach(p=>{
      const prodName = p.product?.name || p.pack || p.name || '';
      const prodPrice = p.product?.price ?? p.price ?? 0;
      const statusRaw = (p.status||'').toString();
      const ts = p.createdAt?.toDate ? p.createdAt.toDate().toLocaleString('th-TH') : (p.createdAt? String(p.createdAt): '');
      const reply = p.reply || p.orderReply || p.adminMessage || p.resultMessage || p.message || p.note || '';
      // map status to Thai label and color
      let statusLabel = statusRaw;
      let statusClass = 'bg-slate-100 text-slate-700';
      if(statusRaw === 'pending') { statusLabel = 'กำลังดำเนินการ'; statusClass = 'bg-amber-200 text-amber-800'; }
      else if(statusRaw === 'accepted') { statusLabel = 'สำเร็จ'; statusClass = 'bg-emerald-200 text-emerald-800'; }
      else if(statusRaw === 'rejected') { statusLabel = 'ไม่สำเร็จ'; statusClass = 'bg-red-200 text-red-800'; }
      else if(statusRaw === 'paid') { statusLabel = 'ชำระแล้ว'; statusClass = 'bg-sky-100 text-sky-800'; }

      const tr = document.createElement('tr');
      tr.className = 'border-b';
      tr.innerHTML = `
        <td class="p-2 align-top">${escapeHtml(prodName)}</td>
        <td class="p-2 align-top"><span class="px-2 py-1 rounded ${statusClass} text-sm">${escapeHtml(statusLabel)}</span></td>
        <td class="p-2 align-top">${currencyTH(prodPrice)}</td>
        <td class="p-2 align-top">${escapeHtml(ts)}</td>
        <td class="p-2 align-top">${escapeHtml(reply)}</td>
      `;
      tbody.appendChild(tr);
    });
  }
  function listenOrdersForUser(){
    if(USER_ORDERS_UNSUB){ USER_ORDERS_UNSUB(); USER_ORDERS_UNSUB=null; }
    if(!CURRENT_USER) return;
    const qref = query(collection(db,'orders'), where('userId','==', CURRENT_USER.uid));
    USER_ORDERS_UNSUB = onSnapshot(qref,(snap)=>{
      const rows = snap.docs.map(d=>({id:d.id, ...d.data()}));
      renderUserHistory(rows);
    },(err)=>{
      const tbody = document.getElementById('ordersTbody');
      if(tbody) tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-red-600">เกิดข้อผิดพลาด: ${err.message}</td></tr>`;
    });
  }
  document.getElementById('closeOrder').addEventListener('click', closeOrder);
  document.getElementById('cancelOrder').addEventListener('click', closeOrder);
  orderModal.addEventListener('click',(e)=>{ if(e.target===orderModal) closeOrder(); });
  document.getElementById('confirmOrder').addEventListener('click', placeOrder);
  document.getElementById('closeHistory').addEventListener('click', closeHistoryModal);
  historyModal.addEventListener('click',(e)=>{ if(e.target===historyModal) closeHistoryModal(); });
  document.getElementById('closeCart').addEventListener('click', ()=>{ cartModal.classList.remove('active'); });
  document.getElementById('closeProduct').addEventListener('click', closeProductModal);
  productModal.addEventListener('click',(e)=>{ if(e.target===productModal) closeProductModal(); });

  // Inline detail panel buttons
  document.getElementById('detailAddCart')?.addEventListener('click', addToCartFromDetail);
  document.getElementById('detailCancel')?.addEventListener('click', hideProductDetail);

  document.getElementById('addCreditBtn').addEventListener('click', async ()=>{
    const email = document.getElementById('creditEmail').value.trim();
    const amt = Number(document.getElementById('creditAmount').value||0);
    const el = document.getElementById('creditMsg'); el.textContent=''; el.className='text-sm';
    try{ await addCreditsByEmail(email, amt); el.classList.add('text-emerald-700'); el.textContent = 'อัปเดตเครดิตแล้ว'; }
    catch(e){ el.classList.add('text-red-600'); el.textContent = e.message; }
  });
  document.getElementById('addProductBtn').addEventListener('click', async ()=>{
    const program = document.getElementById('pProgram').value.trim();
    const image = document.getElementById('pImage').value.trim();
    const requiresEmail = document.getElementById('pReqEmail').checked;
    const requiresPassword = document.getElementById('pReqPassword')?.checked || false;
    const requiresUsername = document.getElementById('pReqUsername')?.checked || false;
    const requiresSN = document.getElementById('pReqSN')?.checked || false;
    const requiresIMEI = document.getElementById('pReqIMEI')?.checked || false;
    const singleName = document.getElementById('pName').value.trim();
    const singlePrice = document.getElementById('pPrice').value.trim();
    const bulkRaw = document.getElementById('pBulkLines')?.value || '';

    const messageEl = document.getElementById('productMsg');
    messageEl.textContent = '';
    messageEl.className = 'text-sm';

    try {
      if (!program) throw new Error('กรุณาระบุโปรแกรม');

      const entries = [];
      const pushEntry = (name, price, lineLabel = '') => {
        const trimmedName = (name || '').trim();
        if (!trimmedName) throw new Error(lineLabel ? `บรรทัดที่ ${lineLabel}: กรุณาระบุชื่อแพ็กเกจ` : 'กรุณาระบุชื่อแพ็กเกจ');
        const priceNumber = Number(String(price || '').replace(/[^\d.]/g, ''));
        if (!priceNumber || !isFinite(priceNumber)) {
          throw new Error(lineLabel ? `บรรทัดที่ ${lineLabel}: ราคาต้องเป็นตัวเลข` : 'กรุณาระบุราคาเป็นตัวเลข');
        }
        entries.push({
          program,
          name: trimmedName,
          price: priceNumber,
          image,
          requiresEmail,
          requiresPassword,
          requiresUsername,
          requiresSN,
          requiresIMEI
        });
      };

      if (bulkRaw.trim()) {
        const lines = bulkRaw.split(/\r?\n/);
        lines.forEach((line, idx) => {
          const raw = line.trim();
          if (!raw) return;
          let namePart = '';
          let pricePart = '';
          const splitByDelimiter = raw.split(/\s*[|,]\s*/);
          if (splitByDelimiter.length >= 2) {
            namePart = splitByDelimiter[0];
            pricePart = splitByDelimiter.slice(1).join(' ').trim();
          } else {
            const lastSpace = raw.lastIndexOf(' ');
            if (lastSpace > 0) {
              namePart = raw.slice(0, lastSpace).trim();
              pricePart = raw.slice(lastSpace + 1).trim();
            }
          }
          if (!namePart || !pricePart) {
            throw new Error(`รูปแบบบรรทัดที่ ${idx + 1} ไม่ถูกต้อง (ใช้รูปแบบ "แพ็กเกจ, ราคา")`);
          }
          pushEntry(namePart, pricePart, idx + 1);
        });
      }

      if (singleName || singlePrice) {
        if (!singleName || !singlePrice) {
          throw new Error('สำหรับการเพิ่มทีละรายการ กรุณากรอกทั้งแพ็กเกจและราคา');
        }
        pushEntry(singleName, singlePrice);
      }

      if (!entries.length) {
        throw new Error('กรุณากรอกแพ็กเกจและราคาอย่างน้อย 1 รายการ');
      }

      for (const entry of entries) {
        await addProductFS(entry);
      }

      document.getElementById('pName').value = '';
      document.getElementById('pPrice').value = '';
      if (document.getElementById('pBulkLines')) document.getElementById('pBulkLines').value = '';

      messageEl.classList.add('text-emerald-700');
      messageEl.textContent = entries.length > 1
        ? `เพิ่มสินค้าใหม่ ${entries.length} รายการเรียบร้อย`
        : 'เพิ่มสินค้าเรียบร้อย';
    } catch (e) {
      messageEl.classList.add('text-red-600');
      messageEl.textContent = e.message || 'ไม่สามารถเพิ่มสินค้าได้';
    }
  });

  // ----- Admin Functions -----
  function checkIsAdmin() {
    if (!IS_ADMIN) {
      console.warn('Access denied: Admin only');
      return false;
    }
    return true;
  }

  // Admin product table state
  let adminSelectedProducts = new Set();
  let adminEditedProducts = new Map();
  let adminProductRefs = new Map();
  let adminLastSnapshot = null;

  const showMessage = (id, msg, type = 'info') => {
    const el = document.getElementById(id);
    if(!el) return;
    el.innerHTML = msg;
    el.className = 'text-sm mt-2 ' + (type === 'error' ? 'text-red-500' : type === 'success' ? 'text-emerald-500' : 'text-slate-600');
  };

  // Clean up any existing product listeners
  function cleanupProductListeners() {
    if(PRODUCTS_UNSUB) { 
      try { PRODUCTS_UNSUB(); } catch(e) { console.error('Error cleaning up products listener:', e); }
      PRODUCTS_UNSUB = null;
    }
    adminSelectedProducts.clear();
    adminEditedProducts.clear();
    adminProductRefs.clear();
  }

  function applyAdminProductFilter(term = '') {
    const normalized = nk(term);
    const rows = document.querySelectorAll('#productsTbody tr');
    rows.forEach(row => {
      const program = nk(row.dataset.program || '');
      const name = nk(row.dataset.name || '');
      const pack = nk(row.dataset.pack || '');
      const match = !normalized || program.includes(normalized) || name.includes(normalized) || pack.includes(normalized);
      row.classList.toggle('hidden', !match);
    });
  }

  // Set up product table with real-time updates
  async function setupProductTable() {
    if(!checkIsAdmin()) return;
    const tbody = document.getElementById('productsTbody');
    if(!tbody) return;
    
    // Clean up any existing listeners first
    cleanupProductListeners();
    tbody.innerHTML = '';

    const unsubscribe = onSnapshot(collection(db, 'products'), (snapshot) => {
      tbody.innerHTML = '';
      adminProductRefs.clear();

      const docs = [];
      snapshot.forEach(doc => docs.push(doc));

      docs.sort((a, b) => {
        const dataA = a.data() || {};
        const dataB = b.data() || {};
        const programA = String(dataA.program || '');
        const programB = String(dataB.program || '');
        const programCompare = programA.localeCompare(programB, 'th', { sensitivity: 'base' });
        if (programCompare !== 0) return programCompare;
        const nameA = String(dataA.name || dataA.pack || '');
        const nameB = String(dataB.name || dataB.pack || '');
        return nameA.localeCompare(nameB, 'th', { sensitivity: 'base' });
      });

      docs.forEach(doc => {
        const data = doc.data() || {};
        adminProductRefs.set(doc.id, doc.ref);
        const isEdited = adminEditedProducts.has(doc.id);
        const tr = document.createElement('tr');
        tr.className = 'border-b' + (isEdited ? ' bg-amber-50' : '');
        tr.id = 'tr-' + doc.id;
        tr.dataset.program = String(data.program || '');
        tr.dataset.name = String(data.name || data.pack || '');
        tr.dataset.pack = String(data.pack || '');
        tr.innerHTML = `
          <td class="p-2"><input type="checkbox" class="product-select" data-id="${doc.id}" ${adminSelectedProducts.has(doc.id) ? 'checked' : ''}></td>
          <td class="p-2"><input type="text" class="border rounded px-2 py-1 w-full" value="${data.program ?? ''}" data-field="program"></td>
          <td class="p-2"><input type="text" class="border rounded px-2 py-1 w-full" value="${data.name ?? ''}" data-field="name"></td>
          <td class="p-2"><input type="number" class="border rounded px-2 py-1 w-20" value="${data.price ?? ''}" data-field="price"></td>
          <td class="p-2"><input type="text" class="border rounded px-2 py-1 w-full" value="${data.image ?? ''}" data-field="image"></td>
          <td class="p-2"><input type="checkbox" data-field="requiresEmail" ${data.requiresEmail ? 'checked' : ''}></td>
          <td class="p-2"><input type="checkbox" data-field="requiresPassword" ${data.requiresPassword ? 'checked' : ''}></td>
          <td class="p-2"><input type="checkbox" data-field="requiresUsername" ${data.requiresUsername ? 'checked' : ''}></td>
          <td class="p-2"><input type="checkbox" data-field="requiresSN" ${data.requiresSN ? 'checked' : ''}></td>
          <td class="p-2"><input type="checkbox" data-field="requiresIMEI" ${data.requiresIMEI ? 'checked' : ''}></td>
          <td class="p-2">
            <button class="bg-emerald-600 text-white px-2 py-1 rounded text-xs save-row" data-id="${doc.id}">Save</button>
            <button class="bg-red-600 text-white px-2 py-1 rounded text-xs delete-row" data-id="${doc.id}">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);

        const inputs = tr.querySelectorAll('input:not(.product-select)');
        inputs.forEach(input => {
          input.addEventListener('change', () => {
            if (!adminEditedProducts.has(doc.id)) adminEditedProducts.set(doc.id, new Set());
            adminEditedProducts.get(doc.id).add(input.dataset.field);
            tr.classList.add('bg-amber-50');
          });
        });
      });

      // Wire up Save/Delete buttons
      document.querySelectorAll('.save-row').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          const tr = document.getElementById('tr-' + id);
          if (!adminEditedProducts.has(id)) return;
          
          const updates = {};
          adminEditedProducts.get(id).forEach(field => {
            const input = tr.querySelector(`input[data-field="${field}"]`);
            if (field === 'price') updates[field] = parseInt(input.value) || 0;
            else if (field.startsWith('requires')) updates[field] = input.checked;
            else updates[field] = input.value.trim();
          });

          try {
            await updateDoc(adminProductRefs.get(id), updates);
            adminEditedProducts.delete(id);
            tr.classList.remove('bg-amber-50');
            showMessage('bulkMsg', 'บันทึกการเปลี่ยนแปลงเรียบร้อย', 'success');
          } catch (e) {
            showMessage('bulkMsg', 'Error: ' + e.message, 'error');
          }
        });
      });

      document.querySelectorAll('.delete-row').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!confirm('ยืนยันการลบสินค้านี้?')) return;
          const id = btn.dataset.id;
          try {
            await deleteDoc(adminProductRefs.get(id));
            document.getElementById('tr-' + id)?.remove();
            adminEditedProducts.delete(id);
            adminSelectedProducts.delete(id);
            showMessage('bulkMsg', 'ลบรายการเรียบร้อย', 'success');
          } catch (e) {
            showMessage('bulkMsg', 'Error: ' + e.message, 'error');
          }
        });
      });

      document.querySelectorAll('.product-select').forEach(cb => {
        cb.addEventListener('change', () => {
          if (cb.checked) adminSelectedProducts.add(cb.dataset.id);
          else adminSelectedProducts.delete(cb.dataset.id);
        });
      });
      const searchEl = document.getElementById('adminProductSearch');
      applyAdminProductFilter(searchEl ? searchEl.value : '');
    });

    return unsubscribe;
  }

  // Wire up admin product management
  const wireProductManagement = () => {
    const openAdminProductBtn = document.getElementById('openAdminProductBtn');
    const modal = document.getElementById('adminProductModal');

    if (openAdminProductBtn) {
      openAdminProductBtn.addEventListener('click', async () => {
        if (!checkIsAdmin()) return;
        if (modal) {
          modal.classList.add('active');
          try {
            // store unsubscribe so cleanupProductListeners can stop it later
            PRODUCTS_UNSUB = await setupProductTable();
          } catch (error) {
            showMessage('bulkMsg', 'Error loading products: ' + error.message, 'error');
          }
        }
      });
    }

    // Clean up listeners when modal closes
    document.getElementById('closeAdminProduct')?.addEventListener('click', () => {
      modal?.classList.remove('active');
      cleanupProductListeners();
    });

    modal?.addEventListener('click', (e) => {
      if(e.target === modal) {
        modal.classList.remove('active');
        cleanupProductListeners();
      }
    });

    // bulk save/delete UI removed - single-row Save/Delete remain in each row

    // Refresh products button (manual)
    document.getElementById('btnRefreshProducts')?.addEventListener('click', async () => {
      if(!checkIsAdmin()) return;
      showMessage('bulkMsg', 'กำลังรีเฟรชรายการ...');
      try{
        // clean up previous listener and re-attach
        cleanupProductListeners();
        PRODUCTS_UNSUB = await setupProductTable();
        showMessage('bulkMsg', 'รีเฟรชเรียบร้อย', 'success');
      }catch(e){ showMessage('bulkMsg', 'Error: '+(e.message||e), 'error'); }
    });
  };

  // ----- Auth state -----
  onAuthStateChanged(auth, async (user)=>{
    CURRENT_USER = user||null;
    if(user){
      try {
        CURRENT_USER_DOC = await ensureUserProfile(user);
      } catch (e) {
        // Fall back to a minimal client state if rules temporarily block profile creation
        CURRENT_USER_DOC = { email: (user.email||'').toLowerCase(), credits: 0, isAdmin: false };
      }
      IS_ADMIN = !!CURRENT_USER_DOC?.isAdmin || ADMIN_EMAILS.includes((user.email||'').toLowerCase());
      listenOrdersForUser();
      // Wire up product management after login 
      wireProductManagement();
    }else{
      CURRENT_USER_DOC = null; IS_ADMIN = false;
      if(USER_ORDERS_UNSUB){ USER_ORDERS_UNSUB(); USER_ORDERS_UNSUB=null; }
      if(ADMIN_ORDERS_UNSUB){ ADMIN_ORDERS_UNSUB(); ADMIN_ORDERS_UNSUB = null; }
    }
    // load cart for current context (merge guest -> user when applicable)
    try{ loadCart(); } catch(e) { CART = []; }
    updateCartCount();
    updateHeaderAuth();
    if(IS_ADMIN) listenOrdersForAdmin();
    // If there was an action waiting for login, resume it now (but do not auto-confirm cart)
    if(CURRENT_USER && AFTER_LOGIN_ACTION){
      const act = AFTER_LOGIN_ACTION; AFTER_LOGIN_ACTION = null;
      try{
        if(act.action === 'openCart'){
          // open cart so user can explicitly confirm
          setTimeout(()=>{ openCartModal(); }, 200);
        } else if(act.action === 'singleOrder'){
          setTimeout(()=>{ openOrderModal(PENDING_ORDER); }, 200);
        }
      }catch(e){ console.error('resume after login failed', e); }
    }
  });

  // ----- Init -----
  (async () => {
    try {
      // Set up Firestore listener
      PRODUCTS_UNSUB = await setupFirestoreProducts();
      
      // Initialize cart
      try { 
        loadCart(); 
        updateCartCount(); 
      } catch(err) {
        console.error('Cart init error:', err);
      }
      
      // Update status
      statusEl.textContent = "อัปเดตล่าสุด: " + new Date().toLocaleString("th-TH");
    } catch(e) {
      statusEl.innerHTML = `<span class="text-red-600">เกิดข้อผิดพลาด:</span> ${e.message}`;
      console.error(e);
    }
  })();
  </script>
</body>
</html>
