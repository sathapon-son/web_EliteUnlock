<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Elite Unlock — โปรแกรมปลดล็อคมือถือ (ของแท้ ราคาคุ้ม เปิดไว)</title>
  <meta name="description" content="ขายโปรแกรมปลดล็อคมือถือของแท้ Unlocktool, TSM TOOL PRO ฯลฯ ราคาเป็นมิตร เปิดใช้งานรวดเร็ว มีรับประกัน และดูแลหลังการขายจริง">

  <!-- Favicon / App Icons -->
  <link rel="icon" type="image/png" sizes="32x32" href="/logo.png?v=1">
  <link rel="shortcut icon" href="/logo.png?v=1" type="image/png">
  <link rel="apple-touch-icon" href="/logo.png?v=1">
  <meta name="theme-color" content="#4f46e5">
  
  <!-- Open Graph / Social -->
  <meta property="og:title" content="Elite Unlock — โปรแกรมปลดล็อคมือถือ">
  <meta property="og:description" content="ของแท้ 100% • เปิดใช้งานรวดเร็ว • ราคาคุ้มค่า">
  <meta property="og:image" content="logo.png">
  <meta property="og:type" content="website">

  <script src="https://cdn.tailwindcss.com?v=3.3.5"></script>
  <!-- หากใช้งานจริง ควรติดตั้ง Tailwind ผ่าน npm และ build แทนการใช้ CDN -->
  <style>
    .card-hover{transition:.25s ease}
    .card-hover:hover{transform:translateY(-5px);box-shadow:0 15px 30px rgba(0,0,0,.08)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:50}
    .modal.active{display:flex}

    /* Make Login / Register / Forgot modals scrollable when their content
       is taller than the viewport. We target the inner white dialog box so
       header/footer stay visible and body content scrolls. */
    #regModal .relative > .bg-white,
    #loginModal .relative > .bg-white,
    #forgotModal .relative > .bg-white {
      max-height: calc(85vh - 2rem);
      overflow-y: auto;
      overflow-x: hidden;
      padding-right: .75rem; /* allow space for scrollbar */
      -webkit-overflow-scrolling: touch;
      box-sizing: border-box;
    }

    /* Ensure containers used as flex children can shrink and allow scrolling */
    #regModal .relative, #loginModal .relative, #forgotModal .relative { min-height: 0; }

    /* Thin custom scrollbar for these auth modals (WebKit + Firefox) */
    #regModal .relative > .bg-white::-webkit-scrollbar,
    #loginModal .relative > .bg-white::-webkit-scrollbar,
    #forgotModal .relative > .bg-white::-webkit-scrollbar { width: 8px; height: 8px; }
    #regModal .relative > .bg-white::-webkit-scrollbar-track,
    #loginModal .relative > .bg-white::-webkit-scrollbar-track,
    #forgotModal .relative > .bg-white::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 6px; }
    #regModal .relative > .bg-white::-webkit-scrollbar-thumb,
    #loginModal .relative > .bg-white::-webkit-scrollbar-thumb,
    #forgotModal .relative > .bg-white::-webkit-scrollbar-thumb {
      background-color: #cbd5e1; border: 2px solid #f1f5f9; border-radius: 20px;
    }
    #regModal .relative > .bg-white::-webkit-scrollbar-thumb:hover,
    #loginModal .relative > .bg-white::-webkit-scrollbar-thumb:hover,
    #forgotModal .relative > .bg-white::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }

    /* Firefox scrollbar color */
    #regModal .relative > .bg-white,
    #loginModal .relative > .bg-white,
    #forgotModal .relative > .bg-white { scrollbar-width: thin; scrollbar-color: #cbd5e1 #f1f5f9; }
    .badge{display:inline-flex;align-items:center;gap:.5rem;padding:.4rem .7rem;border-radius:.6rem;font-size:.8rem}
    #adminOrdersModal .orders-scroll{max-height:70vh;overflow-y:auto;padding-right:.75rem;}
    /* Make product detail modal scrollable when content exceeds viewport */
    #productModal > div { max-height: 80vh; overflow-y: auto; padding-right: .75rem; }
    /* Allow long inline product detail instructions to scroll */
    #detailInstructionsWrap { max-height: 60vh; overflow-y: auto; padding-right: .5rem; }

    /* Custom scrollbar styles */
    .custom-scrollbar {
      scrollbar-width: thin;
      scrollbar-color: #cbd5e1 #f1f5f9;
      overflow: auto;
    }
    
    .custom-scrollbar::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f5f9;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border: 2px solid #f1f5f9;
      border-radius: 20px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background-color: #94a3b8;
    }
    
    .custom-scrollbar::-webkit-scrollbar-corner {
      background: #f1f5f9;
    }

    /* Ensure flex containers with overflow work properly */
    .custom-scrollbar.overflow-auto {
      min-height: 0;
      min-width: 0;
    }

    /* Apply custom scrollbar to topup modal */
    #topupModal .overflow-y-auto {
      scrollbar-width: thin;
      scrollbar-color: #cbd5e1 #f1f5f9;
    }
    
    #topupModal .overflow-y-auto::-webkit-scrollbar {
      width: 8px;
    }
    
    #topupModal .overflow-y-auto::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }
    
    #topupModal .overflow-y-auto::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border-radius: 4px;
      border: 2px solid #f1f5f9;
    }
    
    #topupModal .overflow-y-auto::-webkit-scrollbar-thumb:hover {
      background-color: #94a3b8;
    }
    /* ✅ ทำให้บริเวณสองคอลัมน์ใน AdminCreditModal มีสกรอลล์รวมอันเดียว */
    #adminCreditModal .single-scroll {
      overflow-y: auto !important;
      overflow-x: hidden !important;
      scrollbar-width: thin;
      scrollbar-color: #cbd5e1 #f1f5f9;
      /* ตัวคอนเทนต์ modal สูง 90vh อยู่แล้ว (ตาม h-[90vh]) ให้ส่วนนี้กินพื้นที่ที่เหลือ */
      height: 100%;
      padding-right: .75rem;
    }

    #adminCreditModal .single-scroll::-webkit-scrollbar { width: 8px; }
    #adminCreditModal .single-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
    #adminCreditModal .single-scroll::-webkit-scrollbar-thumb {
      background-color: #cbd5e1; border: 2px solid #f1f5f9; border-radius: 20px;
    }
    #adminCreditModal .single-scroll::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }

    /* Program filter dropdown - handle long text */
    #programFilter {
      max-width: 100%;
      width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-size: 14px;
      line-height: 1.6;
    }

    #programFilter option {
      padding: 8px 10px;
      line-height: 1.6;
      background: white;
      color: #1e293b;
      font-size: 14px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
  </style>
</head>

<body class="bg-gradient-to-b from-slate-50 to-slate-100 text-slate-800 antialiased">
  <!-- Header -->
  <header class="max-w-6xl mx-auto px-6 py-6 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <!-- ใช้โลโก้ -->
      <img src="logo.png" alt="Elite Unlock Logo" class="w-10 h-10 rounded-lg object-contain bg-white shadow" />
      <div>
        <h1 class="text-2xl font-semibold"><a href="/" class="hover:underline">Elite Unlock — โปรแกรมปลดล็อคมือถือ</a></h1>
        <p class="text-sm text-slate-600">
          ของแท้ 100% • เปิดใช้งานรวดเร็ว • ราคาคุ้มค่ากว่า • มีดูแลหลังการขายจริง
        </p>
      </div>
    </div>
    
  </header>

  <main class="max-w-6xl mx-auto px-6 pb-16">
    <!-- Hero badges -->
    <section class="mb-6">
      <div class="rounded-2xl p-6 bg-white shadow">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <h2 class="text-2xl md:text-3xl font-extrabold">ปลดล็อคอย่างมั่นใจ — ของแท้ ราคาเป็นมิตร เปิดไว</h2>
            <p class="text-slate-600 mt-1">
              คีย์/ไลเซนส์แท้สำหรับ Unlocktool, TSM TOOL PRO และเครื่องมือยอดนิยมอื่น ๆ เน้นความคุ้มค่า พร้อมคำแนะนำเบื้องต้น และรับประกันการเปิดใช้งานตามเงื่อนไข
            </p>
            <p class="mt-2 inline-block bg-gradient-to-r from-pink-500 to-red-500 text-white 
            font-bold px-4 py-1.5 rounded-xl shadow-lg animate-pulse">
              🏷️ ลดราคา ถึง 21/11/68
            </p>
          </div>
          <div class="flex flex-wrap gap-2">
            <span class="badge bg-emerald-50 text-emerald-700">✔ รับประกันเปิดใช้งาน</span>
            <span class="badge bg-sky-50 text-sky-700">⏱ เปิดไว</span>
            <span class="badge bg-amber-50 text-amber-700">฿ ราคาเป็นมิตร</span>
            <span class="badge bg-violet-50 text-violet-700">🛟 ซัพพอร์ตหลังการขาย</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Product Detail (inline on main page) -->
    <section id="productDetail" class="mb-10 hidden">
      <div class="rounded-2xl p-6 bg-white shadow">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
          <div>
            <img id="detailImage" src="" alt="" class="w-full rounded-md border bg-slate-50 object-cover" style="aspect-ratio: 800/550;" />
          </div>
          <div class="space-y-3">
            <div class="text-slate-500" id="detailProgram"></div>
            <h3 id="detailName" class="text-2xl font-bold"></h3>
            <div class="text-2xl font-extrabold text-indigo-700">฿<span id="detailPrice">0</span></div>
            <div id="detailInstructionsWrap" class="space-y-2 text-sm text-slate-600 hidden">
              <h4 class="font-semibold text-slate-700">รายละเอียดสินค้า</h4>
              <div id="detailInstructions" class="space-y-1 leading-relaxed"></div>
            </div>
            <div id="detailFields" class="space-y-2"></div>
            <div class="flex gap-2">
              <button id="detailAddCart" class="bg-indigo-600 text-white px-4 py-2 rounded-md">เพิ่มในตะกร้า</button>
              <button id="detailCancel" class="bg-slate-200 text-slate-700 px-4 py-2 rounded-md">ยกเลิก</button>
            </div>
            <div id="detailMsg" class="text-sm text-red-600"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Search & Program Filter -->
    <section class="mb-4">
      <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div class="flex flex-col md:flex-row gap-3 w-full">
          <!-- Program Dropdown Filter -->
          <div class="relative flex-1 md:flex-none md:max-w-xs">
            <select id="programFilter" class="appearance-none w-full p-3 pr-10 rounded-lg border bg-white shadow-sm outline-none focus:ring-2 focus:ring-indigo-500 text-sm whitespace-normal overflow-hidden text-ellipsis">
              <option value="">📦 ทุกโปรแกรม</option>
            </select>
            <svg class="w-4 h-4 text-slate-600 absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
            </svg>
          </div>
          <!-- Search Input -->
          <div class="relative w-full md:w-80">
            <!-- Hidden dummy fields: browsers will often autofill credentials into the first username/password inputs they find.
                 These off-screen inputs are present to absorb autofill so the visible search input isn't populated. -->
            <div style="position: absolute; left: -9999px; top: -9999px; width: 1px; height: 1px; overflow: hidden;" aria-hidden="true">
              <input type="text" name="fake_username" autocomplete="username" tabindex="-1">
              <input type="password" name="fake_password" autocomplete="current-password" tabindex="-1">
            </div>

            <!-- autocomplete="search" and a non-username name help prevent Chrome autofill from treating this as a username field -->
            <input id="searchInput" type="search" name="search_query" inputmode="search" autocomplete="search" autocapitalize="none" autocorrect="off" spellcheck="false" aria-label="ค้นหา" placeholder="ตัวอย่าง: (เช่น Unlocktool, AMT, TSM)" class="w-full p-3 pl-10 rounded-lg border bg-white shadow-sm outline-none focus:ring-2 focus:ring-indigo-500">
            <svg class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.3-4.3M10 18a8 8 0 100-16 8 8 0 000 16z"/>
            </svg>
          </div>
        </div>
        <div class="flex items-center gap-2 self-start whitespace-nowrap">
          <span class="text-sm text-slate-500 hidden md:inline whitespace-nowrap">มุมมอง:</span>
          <button id="viewListBtn" class="px-3 py-2 rounded-md border border-slate-200 text-sm bg-white shadow-sm">รายชื่อ</button>
          <button id="viewTableBtn" class="px-3 py-2 rounded-md border border-slate-200 text-sm bg-white shadow-sm">ตาราง</button>
        </div>
      </div>
      <p id="status" class="text-sm text-slate-600 mt-2">กำลังโหลดข้อมูลสินค้า...</p>
    </section>

    <!-- Packages (cards grouped) -->
    <section id="pricing" class="mb-10">
      <!-- เปลี่ยนหัวข้อเป็น "แพ็กเกจ" -->
      <h3 class="text-2xl font-bold mb-4">แพ็กเกจ</h3>
      <div id="groups" class="grid gap-6 md:grid-cols-2"></div>
      <p id="emptyState" class="hidden text-sm text-slate-500 mt-4">ไม่พบรายการที่ตรงกับคำค้นหา</p>
    </section>

    <!-- Trust sections -->
    <section class="mb-10 grid md:grid-cols-3 gap-4">
      <div class="p-5 rounded-2xl bg-white shadow">
        <h4 class="font-bold text-lg mb-2">ทำไมลูกค้าเลือกเรา</h4>
        <ul class="text-sm space-y-2 text-slate-700">
          <li>• ไลเซนส์แท้ ตรวจสอบได้</li>
          <li>• ราคาเป็นมิตร คุ้มค่าการใช้งานระยะยาว</li>
          <li>• เปิดใช้งานรวดเร็ว ตามคิว ไม่ดองงาน</li>
          <li>• ติดต่อได้จริง หลายช่องทาง</li>
          <li class="text-indigo-600 font-medium">• ฟรี! อัพเกรดเป็นตัวแทน เมื่อสะสมเครดิตครบ 4,500 เครดิต รับราคาพิเศษทันที</li>
        </ul>
      </div>
      <div class="p-5 rounded-2xl bg-white shadow">
        <h4 class="font-bold text-lg mb-2">การรับประกัน & นโยบาย</h4>
        <ul class="text-sm space-y-2 text-slate-700">
          <li>• รับประกันการเปิดใช้งานตามเงื่อนไข</li>
          <li>• เปิดไม่สำเร็จภายใต้ขั้นตอนที่แนะนำ — ดูแลแก้ไข/คืนเงินตามเงื่อนไข</li>
          <!-- เอาออก: ออกหลักฐานการชำระ/ใบเสร็จได้ -->
          <!-- เอาออก: เก็บข้อมูลลูกค้าเพื่อออกหลักฐานเท่านั้น -->
          <li>• โปร่งใส ชี้แจงค่าใช้จ่ายก่อนทำรายการ</li>
        </ul>
      </div>
      <!-- เอาออกทั้งบล็อกรีวิวจากผู้ใช้งาน -->
      <div class="p-5 rounded-2xl bg-white shadow">
        <h4 class="font-bold text-lg mb-2">คำถามที่พบบ่อย</h4>
        <div class="text-sm text-slate-700 space-y-2">
          <div><span class="font-semibold">Q:</span> เปิดใช้งานใช้เวลานานไหม?<br><span class="text-slate-700">A:</span> โดยทั่วไปเปิดภายในคิวงาน หากข้อมูลพร้อมจะรวดเร็ว</div>
          <div><span class="font-semibold">Q:</span> ราคาทำไมถูก?<br><span class="text-slate-700">A:</span> เราโฟกัสราคาเป็นมิตรและปริมาณออเดอร์ เพื่อให้ลูกค้าเข้าถึงของแท้ได้ง่าย</div>
        </div>
      </div>
    </section>

    
  </main>

  

  <footer class="max-w-6xl mx-auto px-6 py-6 text-sm text-slate-500 text-center">
    © 2025 Elite Unlock · ของแท้ ราคาเป็นมิตร เปิดไว · โทร 062-607-2670 · LINE: @825lhqmj
  </footer>

  
  <script type="module">
  // ----- Global Variables -----
  let CURRENT_USER = null;
  let CURRENT_USER_DOC = null;
  let IS_ADMIN = false;
  let IS_AGENT = false;
  let FS_PRODUCTS = [];
  let PENDING_ORDER = null;
  let USER_ORDERS_UNSUB = null;
  let ADMIN_ORDERS_UNSUB = null;
  let PRODUCTS_UNSUB = null;
  let CREDIT_REQUESTS_UNSUB = null;
  let CART = [];
  let PENDING_RESET_CODE = null;
  let PENDING_RESET_EMAIL = "";

  // ----- Activity Timeout Variables -----
  const ACTIVITY_STORAGE_KEY = 'lastActivityTime';
  let ACTIVITY_TIMEOUT = null;
  let LAST_ACTIVITY = Date.now();
  const TIMEOUT_DURATION =   45 * 60 * 1000; // 45 minutes

  const SECURITY_QUESTIONS = [
    { value: "first_pet", label: "สัตว์เลี้ยงตัวแรกของคุณชื่ออะไร?" },
    { value: "birth_city", label: "คุณเกิดที่จังหวัดอะไร?" },
    { value: "favorite_food", label: "อาหารจานโปรดของคุณคืออะไร?" },
    { value: "best_friend", label: "ชื่อเล่นเพื่อนสนิทของคุณคืออะไร?" }
  ];
  const SECURITY_OPTIONS_HTML = SECURITY_QUESTIONS.map(q => `<option value="${q.value}">${q.label}</option>`).join("");

  async function hashAnswer(answer){
    if(!answer && answer !== 0) return '';
    const normalized = String(answer).trim().toLowerCase();
    try{
      const buffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(normalized));
      return Array.from(new Uint8Array(buffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }catch(_){
      try{ return btoa(normalized); }catch(__){ return normalized; }
    }
  }

  async function computeSecurityDocId(email){
    const emailLower = (email||'').trim().toLowerCase();
    if(!emailLower) return '';
    try{
      const hashed = await hashAnswer(emailLower);
      const safe = (hashed||'').replace(/[^a-z0-9]/gi,'');
      return safe || emailLower.replace(/[^a-z0-9]/gi,'');
    }catch(_){
      return emailLower.replace(/[^a-z0-9]/gi,'');
    }
  }

  async function upsertSecurityQA(email, questionKey, answerHash, ownerUid = (auth?.currentUser?.uid||'')){
    if(!email || !questionKey || !answerHash || !ownerUid) return;
    const emailLower = (email||'').trim().toLowerCase();
    const docId = await computeSecurityDocId(emailLower);
    if(!docId) return;
    try{
      await setDoc(doc(db,'userSecurity', docId),{
        emailLower,
        ownerUid,
        questionKey,
        answerHash,
        updatedAt: serverTimestamp()
      },{ merge:true });
    }catch(e){ console.warn('security QA store failed', e?.message||e); }
  }

  const PRODUCT_VIEW_KEY = 'productViewMode';
  const VIEW_MODES = { LIST: 'list', TABLE: 'table' };
  let PRODUCT_VIEW_MODE = VIEW_MODES.LIST;
  try{
    const savedView = localStorage.getItem(PRODUCT_VIEW_KEY);
    if(savedView && Object.values(VIEW_MODES).includes(savedView)) PRODUCT_VIEW_MODE = savedView;
  }catch(_){ PRODUCT_VIEW_MODE = VIEW_MODES.LIST; }

  // Program Filter State
  const PROGRAM_FILTER_KEY = 'selectedProgram';
  // Do not persist selected program across page reloads; always default to all programs
  let SELECTED_PROGRAM = '';

  function updateProgramDropdown() {
    const filterEl = document.getElementById('programFilter');
    if (!filterEl || !FS_PRODUCTS.length) return;
    
    // Get unique programs sorted A-Z
    const programs = Array.from(new Set(FS_PRODUCTS.map(p => p.program || 'อื่น ๆ')))
      .sort((a, b) => a.localeCompare(b, 'th'));
    
    // Check if there are any discounted products
    const hasDiscounted = FS_PRODUCTS.some(p => (p.pack || '').includes('ลดราคา') || (p.program || '').includes('ลดราคา'));
    
    // Build options (keep current value)
    const currentValue = filterEl.value;
    filterEl.innerHTML = '<option value="">📦 ทุกโปรแกรม</option>';
    
    // Add discount option if there are discounted products
    if(hasDiscounted) {
      const discOpt = document.createElement('option');
      discOpt.value = '__DISCOUNT__';
      discOpt.textContent = '🏷️ลดราคา';
      filterEl.appendChild(discOpt);
    }
    
    programs.forEach(prog => {
      const opt = document.createElement('option');
      opt.value = prog;
      // Truncate long program names to ~50 characters
      const displayName = prog.length > 50 ? prog.substring(0, 47) + '...' : prog;
      opt.textContent = displayName;
      opt.title = prog; // Show full name on hover
      filterEl.appendChild(opt);
    });
    
    // Restore selected program (if still exists)
    if(SELECTED_PROGRAM && (programs.includes(SELECTED_PROGRAM) || SELECTED_PROGRAM === '__DISCOUNT__')){
      filterEl.value = SELECTED_PROGRAM;
    } else if(currentValue && (programs.includes(currentValue) || currentValue === '__DISCOUNT__')){
      filterEl.value = currentValue;
    } else {
      filterEl.value = '';
      SELECTED_PROGRAM = '';
    }
  }

  function updateViewToggleUI(){
    const listBtn = document.getElementById('viewListBtn');
    const tableBtn = document.getElementById('viewTableBtn');
    const listActive = PRODUCT_VIEW_MODE === VIEW_MODES.LIST;
    const tableActive = PRODUCT_VIEW_MODE === VIEW_MODES.TABLE;
    if(listBtn){
      listBtn.classList.toggle('bg-indigo-600', listActive);
      listBtn.classList.toggle('text-white', listActive);
      listBtn.classList.toggle('border-indigo-600', listActive);
      listBtn.classList.toggle('bg-white', !listActive);
      listBtn.classList.toggle('text-slate-700', !listActive);
      listBtn.classList.toggle('border-slate-200', !listActive);
    }
    if(tableBtn){
      tableBtn.classList.toggle('bg-indigo-600', tableActive);
      tableBtn.classList.toggle('text-white', tableActive);
      tableBtn.classList.toggle('border-indigo-600', tableActive);
      tableBtn.classList.toggle('bg-white', !tableActive);
      tableBtn.classList.toggle('text-slate-700', !tableActive);
      tableBtn.classList.toggle('border-slate-200', !tableActive);
    }
  }

  function setProductViewMode(mode){
    if(!Object.values(VIEW_MODES).includes(mode)) return;
    if(PRODUCT_VIEW_MODE === mode){ updateViewToggleUI(); return; }
    PRODUCT_VIEW_MODE = mode;
    try{ localStorage.setItem(PRODUCT_VIEW_KEY, mode); }catch(_){ }
    updateViewToggleUI();
    const filtered = filterProductsByProgram(FS_PRODUCTS, SELECTED_PROGRAM);
    render(groupByProgram(filtered), searchEl?.value || "");
  }

  function filterProductsByProgram(products, program) {
    if (!program) return products;

    // กรณีเลือกเฉพาะของลดราคา
    if (program === '__DISCOUNT__') {
      return products.filter(p =>
        (p.pack || '').includes('ลดราคา') ||
        (p.program || '').includes('ลดราคา')
      );
    }

    const normalizedProgram = program.toLowerCase();

    return products.filter(p => {
      const prog = (p.program || 'อื่น ๆ');
      const packText = (p.pack || '').toLowerCase();

      // ตรงโปรแกรมเดิมอยู่แล้ว ก็แสดงตามปกติ
      if (prog === program) return true;

      // ✅ กรณีพิเศษ: ถ้าเป็นกลุ่ม Digital Tool Rent (เช่า)
      // แต่ข้อความใน pack พูดถึงโปรแกรมที่เลือก (เช่น Android Multi Tool (AMT))
      // ให้ดึงมาแสดงด้วย
      if (prog === 'Digital Tool Rent (เช่า)' && packText.includes(normalizedProgram)) {
        return true;
      }

      return false;
    });
  }


  function onProgramFilterChange() {
    const filterEl = document.getElementById('programFilter');
    if(!filterEl) return;
    SELECTED_PROGRAM = filterEl.value || '';
    const filtered = filterProductsByProgram(FS_PRODUCTS, SELECTED_PROGRAM);
    // Program filter works independently - resets search
    render(groupByProgram(filtered), "");
  }

  // ----- Firebase Configuration -----
  const firebaseConfig = {
    apiKey: "AIzaSyAvZLhir8UvnBsb0NuK5r6y73TfoclBC-4",
    authDomain: "eliteunlock-c194e.firebaseapp.com",
    projectId: "eliteunlock-c194e",
    storageBucket: "eliteunlock-c194e.firebasestorage.app",
    messagingSenderId: "12192434961",
    appId: "1:12192434961:web:ad7cff07c16e81e34fdab0",
    measurementId: "G-FFR5YG8S8J"
  };

  // Cloudinary (unsigned upload preset)
  const CLOUD_NAME = "dj3ylqec8";
  const UPLOAD_PRESET = "slip_unsigned";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import {
    getAuth, onAuthStateChanged,
    createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
    sendPasswordResetEmail, confirmPasswordReset, verifyPasswordResetCode,
    getIdTokenResult
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc,
    query, where, getDocs, onSnapshot, serverTimestamp, increment,
    runTransaction, deleteDoc, orderBy, limit
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
  import { getAnalytics, isSupported } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-analytics.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  // Optional: Analytics (non-blocking)
  const canUseAnalytics = typeof window !== 'undefined' && window.location && window.location.protocol.startsWith('http');
  if(canUseAnalytics){
    try { 
      // Wrap analytics initialization in a safe try-catch
      const initAnalytics = async () => {
        const supported = await isSupported().catch(() => false);
        if (supported) {
          try {
            getAnalytics(app);
          } catch (err) {
            console.warn('Analytics init failed:', err?.message || err);
          }
        }
      };
      initAnalytics().catch(e => console.warn('Analytics check failed:', e?.message || e));
    } catch(e){ 
      console.warn('Analytics setup failed:', e?.message || e); 
    }
  }

  // Upload image to Firebase Storage and return URL
  async function uploadImageToStorage(file, folder = 'slips') {
    if (!file || !(file instanceof File)) throw new Error('Invalid file');
    if (!file.type.startsWith('image/')) throw new Error('File must be an image');

    // ✅ Limit file size (5MB)
    const maxSize = 2 * 1024 * 1024;
    if (file.size > maxSize) {
      throw new Error('ขนาดไฟล์ใหญ่เกินไป (จำกัด 2MB)');
    }

    if (!CURRENT_USER?.email) throw new Error('กรุณาเข้าสู่ระบบก่อนอัปโหลดรูป');
    
    try {
      // Debug auth info
      console.log('Current User:', CURRENT_USER);
      console.log('User Email:', CURRENT_USER.email);
      const token = await CURRENT_USER.getIdToken();
      console.log('Auth Token:', token);
      
      const storage = getStorage(app);
      const fileExt = file.name.split('.').pop().toLowerCase();
      
      // Create sanitized email folder name (replace all . with _)
      const emailFolder = CURRENT_USER.email.toLowerCase().replaceAll('.', '_');
      
      // Create date folder name in format YYYY-MM-DD
      const now = new Date();
      const dateFolder = now.toISOString().split('T')[0];
      
      // Create full path: slips/email/YYYY-MM-DD/timestamp_random.ext
      const fileName = `${folder}/${emailFolder}/${dateFolder}/${Date.now()}_${Math.random().toString(36).slice(2)}.${fileExt}`;
      console.log('Uploading to path:', fileName);
      
      const storageRef = ref(storage, fileName);
      
      // Upload file first
      const uploadResult = await uploadBytes(storageRef, file);
      console.log('Upload successful:', uploadResult);
      
      // Then get download URL
      const url = await getDownloadURL(storageRef);
      console.log('Got download URL:', url);
      
      return url;
    } catch (error) {
      console.error('Storage error:', error);
      if (error.code === 'storage/unauthorized') {
        throw new Error('ไม่สามารถเข้าถึงพื้นที่จัดเก็บได้ กรุณาลองเข้าสู่ระบบใหม่');
      }
      throw new Error('เกิดข้อผิดพลาดในการอัปโหลดรูป: ' + (error.message || 'Unknown error'));
    }
  }

  // Configure admin emails (edit to your admin accounts) or use isAdmin in user doc
  const ADMIN_EMAILS = [
    // "owner@example.com"
  ];

  // ----- Elements -----
  const groupsEl   = document.getElementById("groups");
  const statusEl   = document.getElementById("status");
  const emptyEl    = document.getElementById("emptyState");
  let searchEl     = document.getElementById("searchInput");
  // Prevent Chrome from autofilling saved login info into the search box.
  function resetSearchInputForAutofillGuard(node){
    if(!node) return node;
    const clone = node.cloneNode(true);
    clone.value = "";
    clone.setAttribute("autocomplete","off");
    clone.setAttribute("autocorrect","off");
    clone.setAttribute("autocapitalize","none");
    clone.setAttribute("spellcheck","false");
    if(!clone.getAttribute("name")) clone.setAttribute("name","site-search");
    node.replaceWith(clone);
    return clone;
  }

  function sanitizeSearchPrefill(){
    if(!searchEl) return;
    const params = new URLSearchParams(window.location.search);
    if(params.has("search") || params.has("q")) return;
    const value = (searchEl.value || "").trim();
    if(!value) return;
    const currentEmail = (CURRENT_USER?.email || "").toLowerCase();
    if(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value) || (currentEmail && value.toLowerCase() === currentEmail)){
      searchEl.value = "";
    }
  }

  searchEl = resetSearchInputForAutofillGuard(searchEl);
  try{ updateSidebar(); }catch(_){}
  sanitizeSearchPrefill();
  let searchAutofillChecks = 0;
  const searchAutofillGuard = searchEl ? setInterval(() => {
    if(document.activeElement === searchEl) return;
    searchAutofillChecks += 1;
    const before = searchEl.value;
    sanitizeSearchPrefill();
    if(!searchEl.value || before !== searchEl.value || searchAutofillChecks > 10){
      clearInterval(searchAutofillGuard);
    }
  }, 400) : null;
  if(searchEl){
    if(searchAutofillGuard !== null){
      searchEl.addEventListener("input", () => clearInterval(searchAutofillGuard), { once: true });
    }
    searchEl.addEventListener("focus", sanitizeSearchPrefill);
  }

  

// Auth UI bits (ย้ายไปอยู่ฝั่งขวารวมกับปุ่ม "ติดต่อ / สั่งซื้อ")
const header = document.querySelector('header');
header.classList.add('flex-wrap', 'gap-3'); // ให้พับบรรทัดได้ ป้องกันปุ่มล้น

// Create a nav wrapper that contains a mobile toggle and the right-side menu.
// The right-side menu is hidden on small screens and shown via the toggler.
const navWrapper = document.createElement('div');
navWrapper.className = 'flex items-center gap-3 ml-auto';

// Mobile toggle (hamburger) - visible only on small screens
const mobileToggle = document.createElement('button');
mobileToggle.type = 'button';
mobileToggle.className = 'md:hidden inline-flex items-center justify-center p-2 rounded-md text-slate-700 hover:bg-slate-100 mr-3';
mobileToggle.setAttribute('aria-expanded', 'false');
mobileToggle.setAttribute('aria-label', 'เปิดเมนู');
mobileToggle.innerHTML = `
  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
  </svg>`;

// Header right container: hidden on small, flex on md+
const headerRight = document.createElement('div');
headerRight.className = 'hidden md:flex items-center gap-3';

// assemble and append
navWrapper.appendChild(headerRight);
// place the mobile toggle at the start of the header (left side)
header.insertBefore(mobileToggle, header.firstChild);
header.appendChild(navWrapper);

// fill headerRight content (same buttons as before)
headerRight.innerHTML = `
  <div class="flex items-center gap-3">
    <div id="userInfo" class="text-sm text-slate-700 hidden"></div>
    <div id="balanceInfo" class="text-sm font-semibold text-indigo-700 hidden"></div>
    <button id="registerBtn" class="bg-emerald-600 text-white text-sm px-4 py-2 rounded-md shadow">สมัครสมาชิก</button>
    <button id="loginBtn" class="bg-indigo-600 text-white text-sm px-4 py-2 rounded-md shadow">เข้าสู่ระบบ</button>
    <button id="logoutBtn" class="bg-slate-200 text-slate-700 text-sm px-3 py-2 rounded-md shadow hidden">ออกจากระบบ</button>
  </div>
`;

// Toggle behavior: show/hide headerRight on small screens
// Create overlay and sidebar for mobile drawer
const mobileOverlay = document.createElement('div');
mobileOverlay.id = 'mobileOverlay';
mobileOverlay.className = 'hidden fixed inset-0 bg-black/60 z-40';
document.body.appendChild(mobileOverlay);

const mobileSidebar = document.createElement('aside');
mobileSidebar.id = 'mobileSidebar';
mobileSidebar.className = 'fixed left-0 top-0 h-full w-72 bg-slate-900 text-white z-50 transform -translate-x-full transition-transform duration-300 overflow-y-auto';
mobileSidebar.setAttribute('aria-hidden','true');
mobileSidebar.innerHTML = `
  <div class="p-4 border-b border-slate-800">
    <div class="flex items-center gap-3">
      <img src="logo.png" alt="logo" class="w-10 h-10 rounded bg-white/5" />
      <div class="flex-1">
        <div id="sbName" class="font-semibold">สวัสดี</div>
        <div id="sbEmail" class="text-xs text-slate-300"></div>
      </div>
      <button id="closeSidebar" class="text-slate-300 hover:text-white">✕</button>
    </div>
  </div>
  <nav class="p-3">
    <ul id="sbMenu" class="space-y-1 text-sm">
      <!-- Menu items populated by updateSidebar() -->
    </ul>
  </nav>
`;
document.body.appendChild(mobileSidebar);

function showMobileSidebar(){
  mobileOverlay.classList.remove('hidden');
  mobileSidebar.classList.remove('-translate-x-full');
  mobileSidebar.classList.add('translate-x-0');
  mobileSidebar.setAttribute('aria-hidden','false');
  mobileToggle.setAttribute('aria-expanded','true');
}

function hideMobileSidebar(){
  mobileOverlay.classList.add('hidden');
  mobileSidebar.classList.remove('translate-x-0');
  mobileSidebar.classList.add('-translate-x-full');
  mobileSidebar.setAttribute('aria-hidden','true');
  mobileToggle.setAttribute('aria-expanded','false');
}

mobileToggle.addEventListener('click', (e) => {
  // On small screens open the sidebar; on md+ the toggle is hidden by CSS so this will only run on mobile
  updateSidebar();
  showMobileSidebar();
});

mobileOverlay.addEventListener('click', hideMobileSidebar);
document.getElementById('closeSidebar')?.addEventListener('click', hideMobileSidebar);

// Populate sidebar menu based on current auth state; called from updateHeaderAuth
function updateSidebar(){
  const nameEl = document.getElementById('sbName');
  const emailEl = document.getElementById('sbEmail');
  const menu = document.getElementById('sbMenu');
  if(!menu) return;
  nameEl.textContent = CURRENT_USER?.displayName || 'สวัสดี';
  if(emailEl){
    const em = CURRENT_USER?.email || '';
    emailEl.textContent = em;
    emailEl.classList.toggle('hidden', !em);
  }
  // build menu HTML (use functions already defined for actions)
  const items = [];
  if(CURRENT_USER){
    items.push({ label: `เครดิต: ${currencyTH(CURRENT_USER_DOC?.credits||0)}`, action: null, cls: 'font-semibold text-indigo-300' });
    //items.push({ label: 'เติมเครดิต', action: ()=>{ hideMobileSidebar(); document.getElementById('topupModal') && showModalElement(document.getElementById('topupModal')); } });
    items.push({ label: 'เติมเครดิต', action: ()=>{ 
      hideMobileSidebar(); 
      const m = document.getElementById('topupModal');
      if (m) {
        showModalElement(m);
        updateUserCreditBalance();
        updateTotalTopupCredits();
        listenCreditRequests();
      }
    } });
        
    items.push({ label: 'ตะกร้า', action: ()=>{ hideMobileSidebar(); openCartModal(); } });
    items.push({ label: 'ประวัติการสั่งซื้อ', action: ()=>{ hideMobileSidebar(); openHistoryModal(); } });
    if(IS_ADMIN){
      items.push({ label: 'คำสั่งซื้อ (Admin)', action: ()=>{ hideMobileSidebar(); const ordersModal = document.getElementById('adminOrdersModal'); if(ordersModal){ const saved = getSavedAdminFilter(); if(saved) applyFilterToUI(saved); else applyFilterToUI(['pending','accepted','rejected']); showModalElement(ordersModal); listenOrdersForAdmin(); } } });
      items.push({ label: 'เติมเครดิตลูกค้า', action: ()=>{ hideMobileSidebar(); showModalElement(document.getElementById('adminCreditModal')); } });
      items.push({ label: 'เพิ่มสินค้า', action: ()=>{ hideMobileSidebar(); showModalElement(document.getElementById('adminProductModal')); } });
    }
    items.push({ label: 'ออกจากระบบ', action: async ()=>{ hideMobileSidebar(); await logoutWithConfirm(); } });
  } else {
    items.push({ label: 'สมัครสมาชิก', action: ()=>{ hideMobileSidebar(); openRegModal(); } });
    items.push({ label: 'เข้าสู่ระบบ', action: ()=>{ hideMobileSidebar(); openLoginModal(); } });
    items.push({ label: 'ตะกร้า', action: ()=>{ hideMobileSidebar(); openCartModal(); } });
  }
  // render
  menu.innerHTML = items.map((it,idx)=>{
    const cls = it.cls ? ` ${it.cls}` : 'text-slate-200 hover:bg-slate-800 rounded px-3 py-2 block';
    return `<li><a href="#" data-sb-idx="${idx}" class="w-full inline-block ${cls}">${escapeHtml(it.label)}</a></li>`;
  }).join('');
  // bind actions
  menu.querySelectorAll('[data-sb-idx]').forEach(el=>{
    el.addEventListener('click', (ev)=>{
      ev.preventDefault();
      const idx = Number(el.getAttribute('data-sb-idx'));
      const action = items[idx] && items[idx].action;
      if(typeof action === 'function') action();
    });
  });
}

// ✅ Register Modal
const regModal = document.createElement('div');
regModal.className = 'modal fixed inset-0 z-50 hidden items-center justify-center';
regModal.id = 'regModal';
regModal.setAttribute('aria-hidden','true');
regModal.setAttribute('role','dialog');
regModal.setAttribute('aria-modal','true');

regModal.innerHTML = `
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm"></div>

  <!-- Dialog -->
  <div class="relative mx-4 w-full max-w-md">
    <div class="bg-white rounded-2xl shadow-2xl ring-1 ring-slate-200">
      <!-- Header -->
      <div class="relative p-6 border-b border-slate-100">
        <div class="flex items-center justify-center gap-2">
          <div class="h-10 w-10 grid place-items-center rounded-xl bg-emerald-50 text-2xl">📝</div>
          <h3 class="text-xl font-bold text-slate-800">สมัครสมาชิก</h3>
        </div>
        <button id="closeReg"
                class="absolute right-3 top-3 inline-flex h-9 w-9 items-center justify-center rounded-full text-slate-400 hover:text-slate-700 hover:bg-slate-100 transition"
                aria-label="Close">✖</button>
      </div>

      <!-- Body -->
      <div class="p-6 space-y-4">
        <label class="block text-sm font-medium text-slate-700 mb-1">📧 อีเมล</label>
        <input id="authEmailR" type="email" placeholder="name@example.com"
               class="w-full border border-slate-300 rounded-lg p-2.5 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" />

        <label class="block text-sm font-medium text-slate-700 mt-2 mb-1">🔒 รหัสผ่าน</label>
        <div class="relative">
          <input id="authPassR" type="password" placeholder="อย่างน้อย 8 ตัวอักษร"
                 class="w-full border border-slate-300 rounded-lg p-2.5 pr-10 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" />
          <button type="button" id="togglePassR"
                  class="absolute inset-y-0 right-0 px-3 text-slate-400 hover:text-slate-700"
                  tabindex="-1" aria-label="Toggle password">👁️</button>
        </div>

        <label class="block text-sm font-medium text-slate-700 mt-2 mb-1">✅ ยืนยันรหัสผ่าน</label>
        <div class="relative">
          <input id="authPass2R" type="password" placeholder="พิมพ์รหัสผ่านอีกครั้ง"
                 class="w-full border border-slate-300 rounded-lg p-2.5 pr-10 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" />
          <button type="button" id="togglePass2R"
                  class="absolute inset-y-0 right-0 px-3 text-slate-400 hover:text-slate-700"
                  tabindex="-1" aria-label="Toggle confirm password">👁️</button>
        </div>

        <label class="block text-sm font-medium text-slate-700 mt-2 mb-1">🛡️ คำถามเพื่อความปลอดภัย</label>
        <select id="authQuestionR"
                class="w-full border border-slate-300 rounded-lg p-2.5 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
          <option value="">— เลือกคำถาม —</option>
          ${SECURITY_OPTIONS_HTML}
        </select>

        <label class="block text-sm font-medium text-slate-700 mt-2 mb-1">✍️ คำตอบ</label>
        <input id="authAnswerR" type="text" placeholder="ระบุคำตอบของคุณ"
               class="w-full border border-slate-300 rounded-lg p-2.5 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" />

        <div id="authMsgR" class="text-sm min-h-5 text-red-600"></div>

        <button id="doRegister"
                class="w-full bg-emerald-600 text-white px-4 py-2.5 rounded-lg font-medium shadow hover:bg-emerald-700 active:bg-emerald-800 transition">
          ✨ สมัครสมาชิก
        </button>

      </div>
    </div>
  </div>
`;

document.body.appendChild(regModal);

// 🧠 Toggle Password Visibility
const q = (sel) => regModal.querySelector(sel);
const toggle = (inputEl, btnEl) => {
  if (!inputEl || !btnEl) return;
  btnEl.addEventListener('click', () => {
    const isPwd = inputEl.type === 'password';
    inputEl.type = isPwd ? 'text' : 'password';
    btnEl.textContent = isPwd ? '🙈' : '👁️';
  });
};

toggle(q('#authPassR'),  q('#togglePassR'));
toggle(q('#authPass2R'), q('#togglePass2R'));


// ✅ Login Modal
const loginModal = document.createElement('div');
loginModal.className = 'modal fixed inset-0 z-50 hidden items-center justify-center';
loginModal.id = 'loginModal';
loginModal.setAttribute('aria-hidden','true');
loginModal.setAttribute('role','dialog');
loginModal.setAttribute('aria-modal','true');

loginModal.innerHTML = `
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm"></div>

  <!-- Dialog -->
  <div class="relative mx-4 w-full max-w-md">
    <div class="bg-white rounded-2xl shadow-2xl ring-1 ring-slate-200">
      <!-- Header -->
      <div class="relative p-6 border-b border-slate-100">
        <div class="flex items-center justify-center gap-2">
          <div class="h-10 w-10 grid place-items-center rounded-xl bg-indigo-50 text-2xl">🔐</div>
          <h3 class="text-xl font-bold text-slate-800">ลงชื่อเข้าใช้</h3>
        </div>
        <button id="closeLogin"
                class="absolute right-3 top-3 inline-flex h-9 w-9 items-center justify-center rounded-full text-slate-400 hover:text-slate-700 hover:bg-slate-100 transition"
                aria-label="Close">✖</button>
      </div>

      <!-- Body -->
      <div class="p-6 space-y-4">
        <label class="block text-sm font-medium text-slate-700 mb-1">📧 อีเมล</label>
        <input id="authEmailL" type="email" placeholder="name@example.com"
               class="w-full border border-slate-300 rounded-lg p-2.5 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />

        <label class="block text-sm font-medium text-slate-700 mt-2 mb-1">🔑 รหัสผ่าน</label>
        <div class="relative">
          <input id="authPassL" type="password" placeholder="กรอกรหัสผ่าน"
                 class="w-full border border-slate-300 rounded-lg p-2.5 pr-10 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
          <button type="button" id="togglePassL"
                  class="absolute inset-y-0 right-0 px-3 text-slate-400 hover:text-slate-700"
                  tabindex="-1" aria-label="Toggle password">👁️</button>
        </div>

        <div id="authMsgL" class="text-sm min-h-5 text-red-600"></div>

        <button id="doLogin"
                class="w-full bg-indigo-600 text-white px-4 py-2.5 rounded-lg font-medium shadow hover:bg-indigo-700 active:bg-indigo-800 transition">
          🚀 เข้าสู่ระบบ
        </button>

        <button id="openForgot" type="button"
                class="block w-full text-sm text-center text-indigo-600 hover:underline mt-2">
          ❓ ลืมรหัสผ่าน?
        </button>

      </div>
    </div>
  </div>
`;

document.body.appendChild(loginModal);

// 🧠 Toggle Password Visibility
const get = (sel) => loginModal.querySelector(sel);
const toggleView = (inputEl, btnEl) => {
  if (!inputEl || !btnEl) return;
  btnEl.addEventListener('click', () => {
    const isPwd = inputEl.type === 'password';
    inputEl.type = isPwd ? 'text' : 'password';
    btnEl.textContent = isPwd ? '🙈' : '👁️';
  });
};

toggleView(get('#authPassL'), get('#togglePassL'));


// ✅ Forgot Password Modal
const forgotModal = document.createElement('div');
forgotModal.className = 'modal fixed inset-0 z-50 hidden items-center justify-center';
forgotModal.id = 'forgotModal';
forgotModal.setAttribute('aria-hidden','true');
forgotModal.setAttribute('role','dialog');
forgotModal.setAttribute('aria-modal','true');

forgotModal.innerHTML = `
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm"></div>

  <!-- Dialog -->
  <div class="relative mx-4 w-full max-w-md">
    <div class="bg-white rounded-2xl shadow-2xl ring-1 ring-slate-200">
      <!-- Header -->
      <div class="relative p-6 border-b border-slate-100">
        <div class="flex items-center justify-center gap-2">
          <div class="h-10 w-10 grid place-items-center rounded-xl bg-emerald-50 text-2xl">🆘</div>
          <h3 class="text-xl font-bold text-slate-800">ลืมรหัสผ่าน</h3>
        </div>
        <button id="closeForgot"
                class="absolute right-3 top-3 inline-flex h-9 w-9 items-center justify-center rounded-full text-slate-400 hover:text-slate-700 hover:bg-slate-100 transition"
                aria-label="Close">✖</button>
      </div>

      <!-- Body -->
      <div class="p-6 space-y-4 text-sm text-slate-700">
        <p class="text-center">
          โปรดติดต่อเจ้าหน้าที่ผ่าน <span class="font-semibold text-slate-900">LINE @825lhqmj</span>
          เพื่อให้ช่วยรีเซ็ตรหัสผ่านให้คุณ 🙏
        </p>

        <div class="flex flex-col sm:flex-row gap-3">
          <a href="https://line.me/R/ti/p/@825lhqmj"
             target="_blank" rel="noopener"
             class="flex-1 inline-flex items-center justify-center gap-2 bg-green-500 hover:bg-green-600 text-white px-4 py-2.5 rounded-lg font-medium transition">
            💬 เปิด LINE
          </a>
          <button id="copyLineId"
                  class="flex-1 inline-flex items-center justify-center gap-2 bg-slate-900 hover:bg-slate-800 text-white px-4 py-2.5 rounded-lg font-medium transition">
            📋 คัดลอก LINE ID
          </button>
        </div>

        <div id="authMsgF" class="text-center text-xs text-slate-500">
          รองรับทุกวัน 07:30–23:00 น. ⏰
        </div>
      </div>
    </div>
  </div>
`;

document.body.appendChild(forgotModal);

// 🧠 Copy LINE ID helper
(() => {
  const btn = forgotModal.querySelector('#copyLineId');
  if (btn && navigator.clipboard) {
    btn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText('@825lhqmj');
        const msg = forgotModal.querySelector('#authMsgF');
        if (msg) {
          msg.textContent = 'คัดลอก LINE ID แล้ว ✔️ วางในแอป LINE ได้เลย';
          msg.className = 'text-center text-xs text-emerald-600';
          setTimeout(() => {
            msg.textContent = 'รองรับทุกวัน 07:30–23:00 น. ⏰';
            msg.className = 'text-center text-xs text-slate-500';
          }, 2500);
        }
      } catch (_) {
        const msg = forgotModal.querySelector('#authMsgF');
        if (msg) {
          msg.textContent = 'คัดลอกไม่สำเร็จ กรุณาคัดลอกเอง: @825lhqmj';
          msg.className = 'text-center text-xs text-red-600';
        }
      }
    });
  }
})();


  // Reset Password Modal
  const resetPasswordModal = document.createElement('div');
  resetPasswordModal.className = 'modal'; resetPasswordModal.id = 'resetPasswordModal'; resetPasswordModal.setAttribute('aria-hidden','true');
  resetPasswordModal.innerHTML = `
    <div class="bg-white rounded-xl shadow-lg max-w-md w-full p-6 relative">
      <button id="closeReset" class="absolute right-3 top-3 text-slate-400 hover:text-slate-600 text-lg" aria-label="Close">&times;</button>
      <h3 class="text-xl font-bold mb-4 text-center">ตั้งรหัสผ่านใหม่</h3>
      <p id="resetEmail" class="text-sm text-slate-500 text-center mb-2"></p>
      <div class="space-y-3">
        <input id="resetPass" type="password" placeholder="รหัสผ่านใหม่" class="w-full border rounded p-2" />
        <input id="resetPass2" type="password" placeholder="ยืนยันรหัสผ่านใหม่" class="w-full border rounded p-2" />
        <button id="doResetPassword" class="w-full bg-emerald-600 text-white px-4 py-2 rounded-md">บันทึกรหัสผ่านใหม่</button>
        <div id="resetMsg" class="text-sm text-red-600"></div>
      </div>
    </div>`;
  document.body.appendChild(resetPasswordModal);

  // Order Modal
  const orderModal = document.createElement('div');
  orderModal.className = 'modal'; orderModal.id = 'orderModal'; orderModal.setAttribute('aria-hidden','true');
  orderModal.innerHTML = `
    <div class="bg-white rounded-xl shadow-lg max-w-md w-full p-6 relative">
      <button id="closeOrder" class="absolute right-3 top-3 text-slate-400 hover:text-slate-600 text-lg" aria-label="Close">&times;</button>
      <h3 class="text-xl font-bold mb-4 text-center">ยืนยันการสั่งซื้อ</h3>
      <div id="orderSummary" class="text-sm text-slate-700 mb-3"></div>
      <div id="orderEmailBlock" class="space-y-2 hidden">
        <label class="text-sm">กรอกอีเมลสำหรับสินค้านี้</label>
        <input id="orderEmailInput" type="email" placeholder="อีเมลสำหรับใช้งานสินค้า" class="w-full border rounded p-2" />
      </div>
      <div id="orderUsernameBlock" class="space-y-2 hidden">
        <label class="text-sm">กรอก Username สำหรับสินค้านี้</label>
        <input id="orderUsernameInput" type="text" placeholder="Username สำหรับใช้งาน" class="w-full border rounded p-2" />
      </div>
      <div id="orderSNBlock" class="space-y-2 hidden">
        <label class="text-sm">กรอก SN / Serial สำหรับสินค้านี้</label>
        <input id="orderSNInput" type="text" placeholder="SN / Serial" class="w-full border rounded p-2" />
      </div>
      <div id="orderIMEIBlock" class="space-y-2 hidden">
        <label class="text-sm">กรอก IMEI สำหรับสินค้านี้</label>
        <input id="orderIMEIInput" type="text" placeholder="IMEI" class="w-full border rounded p-2" />
      </div>
      <div id="orderPasswordBlock" class="space-y-2 hidden">
        <label class="text-sm">รหัสผ่านสำหรับสินค้านี้</label>
        <input id="orderPasswordInput" type="password" placeholder="รหัสผ่านสำหรับสินค้านี้" class="w-full border rounded p-2" />
      </div>
      <div id="orderDetailsBlock" class="space-y-2 hidden">
        <label class="text-sm">รายละเอียดสำหรับการสั่งซื้อ</label>
        <textarea id="orderDetailsInput" rows="3" placeholder="กรุณากรอกรายละเอียดก่อนสั่งซื้อ" class="w-full border rounded p-2"></textarea>
      </div>
      <div class="flex gap-2 mt-4">
        <button id="confirmOrder" class="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-md">ยืนยันสั่งซื้อ</button>
        <button id="cancelOrder" class="flex-1 bg-slate-200 text-slate-700 px-4 py-2 rounded-md">ยกเลิก</button>
      </div>
      <div id="orderMsg" class="mt-2 text-sm text-red-600"></div>
    </div>`;
  document.body.appendChild(orderModal);

  // Order History Modal (for users)
  const historyModal = document.createElement('div');
  historyModal.className = 'modal'; historyModal.id = 'historyModal'; historyModal.setAttribute('aria-hidden','true');
  historyModal.innerHTML = `
    <div class="bg-white rounded-xl shadow-lg max-w-4xl w-full p-6 relative">
      <button id="closeHistory" class="absolute right-3 top-3 text-slate-400 hover:text-slate-600 text-lg" aria-label="Close">&times;</button>
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-bold mb-4">ประวัติการสั่งซื้อ</h3>
      </div>
      

      <div class="overflow-y-auto max-h-[70vh] pr-2" style="max-height:70vh;">
        <table id="ordersTable" class="w-full text-sm border-collapse">
          <thead>
            <tr class="text-left border-b">
              <th class="p-2">ชื่อโปรแกรม</th>
              <th class="p-2">สถานะ</th>
              <th class="p-2">เครดิต</th>
              <th class="p-2">วันที่</th>
              <th class="p-2">หมายเหตุ</th>
              <th class="p-2">Order Reply</th>
            </tr>
          </thead>
          <tbody id="ordersTbody" class="text-slate-700"></tbody>
        </table>
      </div>
    </div>`;
  document.body.appendChild(historyModal);

  // Top-up Modal (separate from history)
  const topupModal = document.createElement('div');
  topupModal.className = 'modal'; topupModal.id = 'topupModal'; topupModal.setAttribute('aria-hidden','true');
  topupModal.innerHTML = `
    <div class="bg-white rounded-xl shadow-lg max-w-md w-full p-6 relative max-h-[90vh] flex flex-col">
      <button id="closeTopup" class="absolute right-3 top-3 text-slate-400 hover:text-slate-600 text-lg" aria-label="Close">&times;</button>
      <h3 class="text-xl font-bold mb-4 text-center">เติมเครดิต</h3>
      <div class="space-y-4 flex-1 custom-scrollbar overflow-y-auto">
        
        <!-- Credit amount input -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">จำนวนเครดิตที่ต้องการเติม</label>
          <input type="number" id="topupAmount" class="w-full border rounded-md p-2" min="1" step="1" placeholder="ระบุจำนวนเครดิต" />
          <p class="text-xs text-gray-500 mt-1">1 เครดิต = 1 บาท</p>
        </div>

        <!-- File upload (custom Thai button) -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">แนบหลักฐานการโอนเงิน</label>

          <div class="flex items-center gap-3">
            <button id="selectProofBtn" type="button"
              class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md">
              📎 เลือกรูปภาพ
            </button>
            <span id="selectedFileName" class="text-sm text-gray-600">ยังไม่ได้เลือกไฟล์</span>
          </div>

          <!-- hidden real input -->
          <input type="file" id="topupProof" accept=".jpg,.jpeg,.png" style="display:none;" />

          <p class="text-xs text-gray-500 mt-1">
            รองรับไฟล์ JPG, PNG (ขนาดไม่เกิน 2 MB)
          </p>
        </div>

        <!-- Submit button -->
        <button id="submitTopup"
          class="w-full bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-md">
          ส่งคำขอเติมเครดิต
        </button>

        <!-- Status message -->
        <div id="topupMessage" class="text-sm text-center"></div>

        <!-- Bank info -->
        <div class="rounded-lg p-4 bg-amber-50 border space-y-2 text-center">
          <div class="font-medium">ช่องทางการชำระเงิน:</div>
          <div class="bg-white p-3 rounded">
            <div class="font-semibold">🏦 บัญชีธนาคาร กรุงไทย</div>
            <div class="text-lg my-1">💳 403-0-42658-1</div>
            <div>👤 สถาพร สอนสุภาพ</div>
          </div>
          <div class="flex items-center justify-center gap-4 p-2">
            <div class="text-center">
              <img src="LINE_QR.png" alt="LINE QR" class="w-32 h-32 border rounded mx-auto" />
              <div class="text-sm mt-1">LINE: @825lhqmj</div>
            </div>
          </div>
        </div>

        <!-- Promotion info -->
        <div class="rounded-lg p-4 bg-indigo-50 border-2 border-indigo-200 text-center">
          <div class="text-indigo-800 font-semibold mb-2">🌟 สิทธิพิเศษสำหรับลูกค้า</div>
          <div class="text-indigo-700 leading-relaxed">
            เมื่อสะสมเครดิตครบ 4,500 เครดิต<br/>
            รับสิทธิ์อัพเกรดเป็น ตัวแทน ทันที<br/>
            พร้อมส่วนลดราคาพิเศษ!
          </div>
        </div>

        <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-3 text-center mb-4">
          <div class="text-emerald-800 font-medium">🏆 เครดิตสะสมทั้งหมด</div>
          <div id="userTotalTopup" class="text-2xl font-bold text-emerald-700 mt-1">0 เครดิต</div>
        </div>

        <!-- Request history -->
        <div id="creditRequestHistory" class="space-y-4 mt-6">
          <div class="font-medium text-lg text-center">ประวัติคำขอเติมเครดิต</div>
          <div id="creditRequestsList" class="space-y-2">
            <!-- Credit requests will be inserted here -->
          </div>
        </div>
      </div>
    </div>
  `;
  // ✅ โค้ดผูกอีเวนต์ เลือกไฟล์ + ตรวจขนาด (อยู่นอก template literal)
  setTimeout(() => {
    const fileInput = document.getElementById('topupProof');
    const selectBtn = document.getElementById('selectProofBtn');
    const fileNameEl = document.getElementById('selectedFileName');

    if (!fileInput || !selectBtn) return; // กัน null

    // กดปุ่มแล้วเปิด dialog
    selectBtn.addEventListener('click', () => fileInput.click());

    // เมื่อเลือกไฟล์แล้ว
    fileInput.addEventListener('change', () => {
      if (!fileInput.files.length) {
        fileNameEl.textContent = 'ยังไม่ได้เลือกไฟล์';
        fileNameEl.classList.add('text-gray-600');
        return;
      }

      const file = fileInput.files[0];
      const maxSize = 2 * 1024 * 1024; // 2 MB limit

      if (file.size > maxSize) {
        alert('ขนาดไฟล์ใหญ่เกินไป (จำกัด 2 MB)');
        fileInput.value = '';
        fileNameEl.textContent = 'ยังไม่ได้เลือกไฟล์';
        fileNameEl.classList.add('text-gray-600');
        return;
      }

      // แสดงชื่อไฟล์
      fileNameEl.textContent = '📄 ' + file.name;
      fileNameEl.classList.remove('text-gray-600');
    });
  }, 0);

  document.body.appendChild(topupModal);

  // ✅ ฟังก์ชันอัปเดตเครดิตสะสมทั้งหมด (ของผู้ใช้ปัจจุบัน)
  async function updateUserCreditBalance() {
    if (!CURRENT_USER) return;
    try {
      const userDocRef = doc(db, "users", CURRENT_USER.uid);
      const snap = await getDoc(userDocRef);
      if (snap.exists()) {
        const data = snap.data();
        const credits = data.credits || 0;
        const totalEl = document.getElementById("userTotalTopup");
        if (totalEl) {
          totalEl.textContent = `${credits.toLocaleString("th-TH")} เครดิต`;
        }
      }
    } catch (err) {
      console.error("❌ อัปเดตเครดิตสะสมล้มเหลว:", err);
    }
  }

  // wire topup modal buttons
  document.getElementById('closeTopup')?.addEventListener('click', ()=>{ 
    const tm = document.getElementById('topupModal'); 
    if(tm) {
      hideModalElement(tm);
      // Reset form and message when closing
      const msgEl = document.getElementById('topupMessage');
      const amountInput = document.getElementById('topupAmount');
      const fileInput = document.getElementById('topupProof');
      if (msgEl) msgEl.textContent = '';
      if (amountInput) amountInput.value = '';
      if (fileInput) fileInput.value = '';
    } 
  });

  // Setup topup form submission
  document.getElementById('submitTopup')?.addEventListener('click', async () => {
    const msgEl = document.getElementById('topupMessage');
    msgEl.textContent = '';
    msgEl.className = 'text-sm text-center';

    try {
      if (!CURRENT_USER) {
        throw new Error('กรุณาเข้าสู่ระบบก่อนเติมเครดิต');
      }

      const amountInput = document.getElementById('topupAmount');
      const fileInput = document.getElementById('topupProof');
      
      const amount = Number(amountInput.value);
      if (!amount || amount < 1) {
        throw new Error('กรุณาระบุจำนวนเครดิตที่ต้องการเติม');
      }

      const file = fileInput.files[0];
      if (!file) {
        throw new Error('กรุณาแนบหลักฐานการโอนเงิน');
      }

      msgEl.textContent = 'กำลังอัปโหลดรูปภาพ...';
      const imageUrl = await uploadImageToStorage(file);

      msgEl.textContent = 'กำลังส่งคำขอ...';
      await submitCreditRequest(amount, imageUrl);

      msgEl.className = 'text-sm text-emerald-600 text-center';
      msgEl.textContent = 'ส่งคำขอเติมเครดิตเรียบร้อย กำลังรอการตรวจสอบ';

      // Clear form
      amountInput.value = '';
      fileInput.value = '';

      // Start listening for request updates
      listenCreditRequests();

    } catch (err) {
      msgEl.className = 'text-sm text-red-600 text-center';
      msgEl.textContent = err.message || 'เกิดข้อผิดพลาด';
    }
  });

// ✅ Cart Modal
const cartModal = document.createElement('div');
cartModal.className = 'modal fixed inset-0 z-50 hidden items-center justify-center';
cartModal.id = 'cartModal';
cartModal.setAttribute('aria-hidden','true');
cartModal.setAttribute('role','dialog');
cartModal.setAttribute('aria-modal','true');

cartModal.innerHTML = `
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm"></div>

  <!-- Dialog -->
  <div class="relative mx-4 w-full max-w-2xl">
    <div class="bg-white rounded-2xl shadow-2xl ring-1 ring-slate-200">
      <!-- Header -->
      <div class="relative p-6 border-b border-slate-100">
        <div class="flex items-center justify-center gap-2">
          <div class="h-10 w-10 grid place-items-center rounded-xl bg-indigo-50 text-2xl">🛒</div>
          <h3 class="text-xl font-bold text-slate-800">ตะกร้าสินค้า</h3>
        </div>
        <button id="closeCart"
                class="absolute right-3 top-3 inline-flex h-9 w-9 items-center justify-center rounded-full text-slate-400 hover:text-slate-700 hover:bg-slate-100 transition"
                aria-label="Close">✖</button>
      </div>

      <!-- Body -->
      <div class="p-6">
        <!-- รายการสินค้า -->
        <div id="cartList"
             class="space-y-3 max-h-[60vh] overflow-auto text-sm pr-1">
          <!-- เติมรายการจากสคริปต์ของคุณ -->
          <!-- ตัวอย่างสไตล์รายการที่แนะนำ:
          <div class="flex items-center justify-between gap-3 p-3 rounded-xl border border-slate-200 bg-slate-50/60">
            <div class="min-w-0">
              <div class="font-medium text-slate-800 truncate">ชื่อสินค้า</div>
              <div class="text-xs text-slate-500">แพ็ก / รายละเอียด</div>
            </div>
            <div class="flex items-center gap-2 shrink-0">
              <button class="h-8 w-8 grid place-items-center rounded-lg border hover:bg-slate-100">−</button>
              <span class="w-8 text-center">1</span>
              <button class="h-8 w-8 grid place-items-center rounded-lg border hover:bg-slate-100">＋</button>
              <button class="ml-2 h-8 px-3 rounded-lg bg-rose-50 text-rose-600 hover:bg-rose-100">🗑️</button>
            </div>
          </div>
          -->
        </div>

        <!-- สรุปยอด -->
        <div class="mt-5 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <div class="text-lg font-semibold text-slate-800">
            🧾 รวมทั้งหมด: <span id="cartTotal">0</span> เครดิต
          </div>
          <div class="flex items-center gap-3">
            <button id="continueShopping"
                    class="inline-flex items-center gap-2 px-4 py-2.5 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 active:bg-indigo-800 font-medium shadow transition">
              ✅ ยืนยันการสั่งซื้อ
            </button>
          </div>
        </div>

        <div id="cartMsg" class="mt-3 text-sm text-slate-600 min-h-5"></div>
      </div>
    </div>
  </div>
`;

document.body.appendChild(cartModal);

// (ออปชัน) ใส่ข้อความว่างเมื่อไม่มีสินค้าในตะกร้า
const cartListEl = cartModal.querySelector('#cartList');
if (cartListEl && cartListEl.children.length === 0) {
  const empty = document.createElement('div');
  empty.className = 'p-6 text-center text-slate-500';
  empty.innerHTML = 'ตะกร้ายังว่างเปล่า 🧺<br><span class="text-xs">เลือกสินค้าที่ต้องการแล้วกลับมาตรวจสอบที่นี่</span>';
  cartListEl.appendChild(empty);
}


  // Product Detail Modal (Buy Now)
  const productModal = document.createElement('div');
  productModal.className = 'modal'; productModal.id = 'productModal'; productModal.setAttribute('aria-hidden','true');
  productModal.innerHTML = `
    <div class="bg-white rounded-xl shadow-lg max-w-3xl w-full p-6 relative">
      <button id="closeProduct" class="absolute right-3 top-3 text-slate-400 hover:text-slate-600 text-lg" aria-label="Close">&times;</button>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="space-y-3">
          <img id="pdImage" src="" alt="" class="w-full object-cover rounded border bg-slate-50" style="aspect-ratio: 800/550;" />
          <div class="text-sm text-slate-500" id="pdProgram"></div>
        </div>
        <div class="space-y-3">
          <h3 class="text-2xl font-bold" id="pdName"></h3>
          <div class="text-2xl font-extrabold text-indigo-700" id="pdPriceWrap">
            <div id="pdPriceLabel"></div>
            <div>฿<span id="pdPrice">0</span></div>
          </div>
          <div id="pdInstructionsWrap" class="space-y-2 text-sm text-slate-600 hidden">
            <h4 class="font-semibold text-slate-700">รายละเอียดสินค้า</h4>
            <div id="pdInstructions" class="space-y-1 leading-relaxed"></div>
          </div>
          <div id="pdFields" class="space-y-2"></div>
          <div class="flex flex-col sm:flex-row gap-2">
            <button id="pdAddCart" class="w-full sm:flex-1 bg-indigo-600 text-white px-4 py-2 rounded-md">เพิ่มในตะกร้า</button>
            <button id="pdCancel" class="w-full sm:flex-1 bg-slate-200 text-slate-700 px-4 py-2 rounded-md">ปิด</button>
          </div>
          <div id="pdMsg" class="text-sm"></div>
        </div>
    </div>`;
  document.body.appendChild(productModal);

  // Admin UI was moved out of the main page and into modals/header buttons per request.

  // Admin Orders Modal (for pending orders) - opens as popup for easier management
  const adminOrdersModal = document.createElement('div');
  adminOrdersModal.className = 'modal'; adminOrdersModal.id = 'adminOrdersModal'; adminOrdersModal.setAttribute('aria-hidden','true');
  adminOrdersModal.innerHTML = `
    <div class="bg-white rounded-xl shadow-lg max-w-6xl w-full p-6 relative">
      <button id="closeAdminOrders" class="absolute right-3 top-3 text-slate-400 hover:text-slate-600 text-lg" aria-label="Close">&times;</button>
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-bold mb-4">คำสั่งซื้อ (Admin)</h3>
      </div>
      <div class="mb-4">
        <div class="text-sm text-slate-600 mb-2">ตัวกรองสถานะ: เลือกสถานะที่ต้องการแสดง (ค่าจะถูกบันทึกไว้)</div>
        <div class="flex items-center gap-3 text-sm">
          <label class="inline-flex items-center gap-2"><input type="checkbox" id="adminFilterPending" /> <span>กำลังดำเนินการ</span></label>
          <label class="inline-flex items-center gap-2"><input type="checkbox" id="adminFilterAccepted" /> <span>สำเร็จ</span></label>
          <label class="inline-flex items-center gap-2"><input type="checkbox" id="adminFilterRejected" /> <span>ไม่สำเร็จ</span></label>
          <button id="adminFilterApply" class="ml-4 bg-indigo-600 text-white text-sm px-3 py-1 rounded-md">ปรับใช้</button>
          <button id="adminFilterReset" class="ml-2 bg-slate-100 text-slate-700 text-sm px-3 py-1 rounded-md">รีเซ็ต</button>
        </div>
      </div>
      <div class="custom-scrollbar overflow-auto max-h-[60vh]">
        <div id="adminOrdersList" class="text-sm min-w-[800px]"></div>
      </div>
    </div>`;
  document.body.appendChild(adminOrdersModal);
  // close handler
  document.getElementById('closeAdminOrders')?.addEventListener('click', ()=>{ const ordersModal = document.getElementById('adminOrdersModal'); if(ordersModal) hideModalElement(ordersModal); });

  // Admin Credit Modal (open from header)
  const adminCreditModal = document.createElement('div');
  adminCreditModal.className = 'modal'; adminCreditModal.id = 'adminCreditModal'; adminCreditModal.setAttribute('aria-hidden','true');
  adminCreditModal.innerHTML = `
    <div class="bg-white rounded-xl shadow-lg max-w-4xl w-full p-6 relative flex flex-col h-[90vh] min-h-0">
      <button id="closeAdminCredit" class="absolute right-3 top-3 text-slate-400 hover:text-slate-600 text-lg" aria-label="Close">&times;</button>
      <h3 class="text-xl font-bold mb-4">จัดการเครดิต</h3>
      
      <!-- ✅ ห่อสองคอลัมน์ด้วย single-scroll (สกรอลล์รวม) -->
      <div class="flex-1 min-h-0">
        <div class="single-scroll h-full">
          <div class="flex flex-col md:flex-row gap-6">

            <!-- ซ้าย: เอา overflow ออก ใส่ min-h-0 -->
            <div class="flex-1 flex flex-col min-w-0 min-h-0">
              <div class="bg-white rounded-lg border p-4">
                <h4 class="font-semibold mb-3">เพิ่ม/ลดเครดิตโดยตรง</h4>
                <div class="space-y-3">
                  <input id="creditEmail" type="email" placeholder="อีเมลลูกค้า" class="w-full border rounded p-2" />
                  <input id="creditAmount" type="number" placeholder="จำนวนเครดิต (+เพิ่ม/-ลด)" class="w-full border rounded p-2" />
                  <button id="addCreditBtn" class="w-full bg-emerald-600 text-white px-4 py-2 rounded-md">อัปเดตเครดิต</button>
                  <div id="creditMsg" class="text-sm"></div>
                </div>
              </div>
            </div>

            <!-- ขวา: เอา overflow ออก ใส่ min-h-0 -->
            <div class="flex-1 flex flex-col min-w-0 min-h-0">
              <div class="bg-white rounded-lg border p-4">
                <h4 class="font-semibold mb-3">คำขอเติมเครดิต</h4>
                <div class="space-y-4" id="creditRequestsList">
                  <!-- ... รายการคำขอ ... -->
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

    </div>`;
  document.body.appendChild(adminCreditModal);
  document.getElementById('closeAdminCredit')?.addEventListener('click', ()=>{ const creditModal = document.getElementById('adminCreditModal'); if(creditModal) hideModalElement(creditModal); });

  // Admin Product Modal (open from header) - enhanced with product management
  const adminProductModal = document.createElement('div');
  adminProductModal.className = 'modal overflow-y-auto'; adminProductModal.id = 'adminProductModal'; adminProductModal.setAttribute('aria-hidden','true');
  adminProductModal.innerHTML = `
    <div class="bg-white rounded-xl shadow-lg max-w-6xl w-full max-h-[90vh] relative flex flex-col">
      <button id="closeAdminProduct" class="absolute right-3 top-3 text-slate-400 hover:text-slate-600 text-lg" aria-label="Close">&times;</button>
      <div class="p-6 overflow-y-auto flex-1 space-y-6">
        <h3 class="text-xl font-bold">จัดการสินค้า</h3>

        <div class="space-y-3 text-sm">
          <h4 class="font-semibold">เพิ่มสินค้าใหม่</h4>
          <div class="flex flex-wrap gap-3">
            <input id="pProgram" type="text" placeholder="โปรแกรม" class="border rounded p-2 min-w-[12rem] flex-1" />
            <input id="pImage" type="text" placeholder="ลิงก์รูปภาพ" class="border rounded p-2 min-w-[12rem] flex-1" />
            <div class="grid gap-2 w-full sm:grid-cols-3">
              <input id="pName" type="text" placeholder="แพ็กเกจ / ชื่อ (เพิ่มรายการเดียว)" class="border rounded p-2" />
              <input id="pPrice" type="number" placeholder="ราคา (เครดิต)" class="border rounded p-2" />
              <input id="pAgentPrice" type="number" placeholder="ราคาตัวแทน (optional)" class="border rounded p-2" />
            </div>
            <textarea id="pBulkLines" rows="3" placeholder="6 เดือน, 1200
12 เดือน, 2200" class="border rounded p-2 w-full"></textarea>
            <textarea id="pDetails" rows="3" placeholder="กรอกข้อความ" class="border rounded p-2 w-full"></textarea>
            <p class="text-xs text-slate-500 w-full">เพิ่มหลายรายการ: กรอกแพ็กเกจกับราคา (คั่นด้วยเครื่องหมาย , หรือ |) ทีละบรรทัด</p>
            <div class="flex flex-wrap items-center gap-3 w-full">
              <label class="inline-flex items-center gap-2"><input id="pReqEmail" type="checkbox" /> ต้องการอีเมล</label>
              <label class="inline-flex items-center gap-2"><input id="pReqPassword" type="checkbox" /> ต้องการรหัสผ่าน</label>
              <label class="inline-flex items-center gap-2"><input id="pReqUsername" type="checkbox" /> ต้องการ Username</label>
              <label class="inline-flex items-center gap-2"><input id="pReqSN" type="checkbox" /> ต้องการ SN</label>
              <label class="inline-flex items-center gap-2"><input id="pReqIMEI" type="checkbox" /> ต้องการ IMEI</label>
              <label class="inline-flex items-center gap-2"><input id="pReqDetails" type="checkbox" /> ต้องการรายละเอียดจากลูกค้า</label>
              <label class="inline-flex items-center gap-2"><input id="pTypeCredit" type="checkbox" /> เป็นสินค้าประเภทเครดิต</label>
              <button id="addProductBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-md">เพิ่มสินค้า</button>
            </div>
          </div>
          <div id="productMsg" class="text-sm"></div>
        </div>

        <div id="productsArea" class="rounded-lg bg-white border p-4">
          <div class="flex flex-col gap-2 mb-3 md:flex-row md:items-center md:justify-between">
            <h4 class="font-semibold">รายการสินค้าในฐานข้อมูล</h4>
            <div class="flex flex-wrap items-center gap-3">
              <input id="adminProductSearch" type="search" placeholder="ค้นหาสินค้า โปรแกรม/แพ็กเกจ" class="border rounded px-3 py-2 text-sm w-full sm:w-72">
              <button id="btnRefreshProducts" class="bg-slate-100 text-slate-700 text-sm px-3 py-1 rounded-md">รีเฟรช</button>
            </div>
          </div>

          <div class="custom-scrollbar overflow-auto max-h-[55vh]">
            <table id="productsTable" class="w-full text-sm border-collapse min-w-[1000px]">
                <thead>
                  <tr class="text-left border-b">
                    <th class="p-2">เลือก</th>
                    <th class="p-2">โปรแกรม</th>
                    <th class="p-2">แพ็กเกจ / ชื่อ</th>
                    <th class="p-2">ราคา</th>
                    <th class="p-2">ราคา (ตัวแทน)</th>
                    <th class="p-2">image</th>
                    <th class="p-2">email?</th>
                    <th class="p-2">password?</th>
                    <th class="p-2">username?</th>
                    <th class="p-2">sn?</th>
                    <th class="p-2">imei?</th>
                    <th class="p-2">ประเภท</th>
                    <th class="p-2">รายละเอียด</th>
                    <th class="p-2">จัดการ</th>
                  </tr>
                </thead>
                <tbody id="productsTbody" class="text-slate-700"></tbody>
              </table>
            </div>
          </div>

          <div class="mt-4 flex gap-3">
            <button id="btnBulkSave" class="bg-emerald-600 text-white px-3 py-2 rounded">Save selected</button>
            <button id="btnDeleteSelected" class="bg-red-600 text-white px-3 py-2 rounded">Delete selected</button>
            <div id="bulkMsg" class="text-sm text-slate-600 ml-3"></div>
          </div>
        </div>
        <div class="mt-6 flex justify-end">
          <button id="closeAdminProductFooter" class="bg-slate-200 text-slate-700 px-4 py-2 rounded-md">ปิด</button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(adminProductModal);
  document.getElementById('closeAdminProduct')?.addEventListener('click', ()=>{ const productModalEl = document.getElementById('adminProductModal'); if(productModalEl) hideModalElement(productModalEl); });
  document.getElementById('closeAdminProductFooter')?.addEventListener('click', ()=>{ const productModalEl = document.getElementById('adminProductModal'); if(productModalEl) hideModalElement(productModalEl); });
  document.getElementById('adminProductSearch')?.addEventListener('input', (e)=>{ applyAdminProductFilter(e.target.value); });

  // Helper: persist/restore admin orders filter (exclude 'paid')
  const ADMIN_FILTER_KEY = 'adminOrdersFilter';
  function getSavedAdminFilter(){
    try{ const v = localStorage.getItem(ADMIN_FILTER_KEY); if(!v) return null; const arr = JSON.parse(v); return Array.isArray(arr)?arr: null; }catch{return null;}
  }
  function saveAdminFilter(arr){ try{ localStorage.setItem(ADMIN_FILTER_KEY, JSON.stringify(arr||[])); }catch{}
  }
  function readFilterUI(){
    const pending = !!document.getElementById('adminFilterPending')?.checked;
    const accepted = !!document.getElementById('adminFilterAccepted')?.checked;
    const rejected = !!document.getElementById('adminFilterRejected')?.checked;
    const out = [];
    if(pending) out.push('pending');
    if(accepted) out.push('accepted');
    if(rejected) out.push('rejected');
    return out;
  }
  function applyFilterToUI(arr){
    if(!Array.isArray(arr)) arr = ['pending','accepted','rejected'];
    document.getElementById('adminFilterPending').checked = arr.includes('pending');
    document.getElementById('adminFilterAccepted').checked = arr.includes('accepted');
    document.getElementById('adminFilterRejected').checked = arr.includes('rejected');
  }
  // wire apply/reset buttons
  document.getElementById('adminFilterApply')?.addEventListener('click', ()=>{
    const arr = readFilterUI(); saveAdminFilter(arr); listenOrdersForAdmin();
  });
  document.getElementById('adminFilterReset')?.addEventListener('click', ()=>{
    const defaults = ['pending','accepted','rejected']; applyFilterToUI(defaults); saveAdminFilter(defaults); listenOrdersForAdmin();
  });
  // when modal opens we'll populate UI from saved filter (see header click handler)

  // bind admin filter control (re-run listener when toggled)
  const adminShowPaidEl = document.getElementById('adminShowPaid');
  if(adminShowPaidEl) adminShowPaidEl.addEventListener('change', ()=> { listenOrdersForAdmin(); });

  // ----- Helpers -----
  // No longer need CSV-related headers
  const norm = s => (s??"").toString().trim();
  const nk   = s => norm(s).toLowerCase().replace(/\s+/g,"").replace(/[._-]/g,"");
  // Normalize tokens for search: keep letters, numbers and Thai characters; remove punctuation
  const tokenNorm = s => (s??"").toString().trim().toLowerCase().replace(/[^0-9a-z\u0E00-\u0E7F]/g, "");

  const currencyTH = v => {
    const n=Number(String(v).replace(/[^\d.]/g,""));
    return isNaN(n)?norm(v):n.toLocaleString("th-TH");
  };

  // Convert newlines to <br> while preserving already-escaped HTML
  function nl2br(str){
    if(!str && str !== 0) return '';
    // Normalize CRLF and LF then replace with <br>
    return String(str).replace(/\r\n|\r|\n/g, '<br>');
  }

  // Agent pricing helpers
  function getEffectivePrice(p){
    const base = Number(p?.price) || 0;
    const agent = Number(p?.agentPrice) || 0;
    if(IS_AGENT && agent > 0) return agent;
    return base;
  }

  function priceHasAgentDiscount(p){
    const base = Number(p?.price) || 0;
    const agent = Number(p?.agentPrice) || 0;
    return IS_AGENT && agent > 0 && agent !== base;
  }

  function buildLineNote(details = {}) {
    const parts = [];
    if(details.orderId) parts.push(`Order#: ${details.orderId}`);
    if(details.program) parts.push(`Program: ${details.program}`);
    if(details.email) parts.push(`Email: ${details.email}`);
    if(details.username) parts.push(`Username: ${details.username}`);
    if(details.sn) parts.push(`SN: ${details.sn}`);
    if(details.imei) parts.push(`IMEI: ${details.imei}`);
    if(details.password) parts.push(`Password: ${details.password}`);
    if(details.additional && Array.isArray(details.additional)){
      details.additional.filter(Boolean).forEach(txt => parts.push(txt));
    } else if(details.additional){
      parts.push(details.additional);
    }
    return parts.join(" | ");
  }

  async function notifyLineOrder(payload){
    try{
      const res = await fetch('/order',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(!res.ok){
        const text = await res.text();
        console.error('LINE notify failed', text);
      }
    }catch(err){
      console.error('LINE notify error', err);
    }
  }

  function toNumber(v){ const n=Number(String(v).replace(/[^\d.]/g,"")); return isNaN(n)?0:n; }

  function groupByProgram(items){
    const g={};
    for(const it of items){
      const k=norm(it.program)||"อื่น ๆ";
      if(!g[k]) g[k]=[];
      g[k].push(it);
    }
    return g;
  }

  // Parse duration from a package name into months (number). Returns Infinity when unknown.
  function parseDurationMonths(s){
    if(!s) return Infinity;
    const txt = (s||"").toString().toLowerCase();
    // match patterns like '3 เดือน', '12 เดือน', '2 ปี'
    const reMonth = /([0-9]+(?:\.[0-9]+)?)\s*(เดือน|month|m)/i;
    const reYear = /([0-9]+(?:\.[0-9]+)?)\s*(ปี|year|y)/i;
    const m = txt.match(reMonth);
    if(m && m[1]) return Number(m[1]);
    const y = txt.match(reYear);
    if(y && y[1]) return Number(y[1]) * 12;
    // try to find standalone numbers (e.g., '3M', '12M')
    const reNum = /([0-9]+)\s*(?:m|mo|mons)?\b/i;
    const n = txt.match(reNum);
    if(n && n[1]) return Number(n[1]);
    return Infinity;
  }

  function rowsToItems(rows){
    if(!rows.length) throw new Error("ไม่พบข้อมูล CSV");
    const headers=rows[0];
    const map=mapHeaders(headers);
    return rows.slice(1)
      .filter(r=>r.length && r.some(c=>norm(c)!==""))
      .map((r,idx)=>({
        id: `csv_${idx}`,
        source: 'csv',
        program: r[map.program]??"",
        pack: r[map.pack]??"",
        price: toNumber(r[map.price]??0),
        image: map.image!=null? norm(r[map.image]): "",
        requiresEmail: map.requiresemail!=null ? /^(1|true|yes|y)$/i.test(String(r[map.requiresemail])) : false,
        requiresUsername: map.requiresusername!=null ? /^(1|true|yes|y)$/i.test(String(r[map.requiresusername])) : false,
        requiresSN: map.requiressn!=null ? /^(1|true|yes|y)$/i.test(String(r[map.requiressn])) : false,
        requiresIMEI: map.requireimei!=null ? /^(1|true|yes|y)$/i.test(String(r[map.requireimei])) : false
        ,requiresPassword: map.requirespassword!=null ? /^(1|true|yes|y)$/i.test(String(r[map.requirespassword])) : false
      }))
      .filter(x=>norm(x.program)&&norm(x.pack)&&x.price>0);
  }

  // ----- State -----
  const state = {
    currentUser: null, // auth user
    currentUserDoc: null, // user profile with credits
    isAdmin: false,
    products: [], // firestore products
    pendingOrder: null, // order in modal
    userOrdersUnsub: null, // unsubscribe for user's order stream
    adminOrdersUnsub: null, // unsubscribe for admin orders stream
    productsUnsub: null, // unsubscribe for products real-time updates
    cart: [], // [{id, program, pack(name), price, image, requiresEmail, emailForProduct?}],
    admin: {
      selectedProducts: new Set(),
      editedProducts: new Map(),
      productRefs: new Map()
    }
  };
  // Action to resume after login (e.g. confirm cart)
  let AFTER_LOGIN_ACTION = null;
  // Selection state for main-page selection (does NOT add to cart yet)
  let SELECTED_IDS = new Set();
  let CURRENT_DETAIL_PRODUCT = null; // product shown in inline detail panel
  // Admin product table state
  let selectedProducts = new Set();
  let editedProducts = new Map();
  let productRefs = new Map();

  function cartKey(){ return CURRENT_USER? `cart_${CURRENT_USER.uid}`: 'cart_guest'; }
  function loadCart(){
    try{
      if(CURRENT_USER){
        // merge guest cart into user cart when logging in
        const guest = JSON.parse(localStorage.getItem('cart_guest')||'[]');
        const userKey = `cart_${CURRENT_USER.uid}`;
        const userCart = JSON.parse(localStorage.getItem(userKey)||'[]');
        // merge preserving order: userCart first, then guest (guest items were added before login)
        const merged = Array.isArray(userCart) ? userCart.slice() : [];
        if(Array.isArray(guest) && guest.length){
          merged.push(...guest);
        }
        CART = merged;
        localStorage.setItem(userKey, JSON.stringify(merged));
        // remove guest key to avoid duplicate merges next login
        localStorage.removeItem('cart_guest');
      } else {
        CART = JSON.parse(localStorage.getItem('cart_guest')||'[]');
      }
    }catch{
      CART = [];
    }
  }
  function saveCart(){ localStorage.setItem(cartKey(), JSON.stringify(CART)); updateCartCount(); }
  function updateCartCount(){
    const btn = document.getElementById('cartBtn');
    const count = CART.length;
    if(btn){ btn.textContent = `ตะกร้า (${count})`; }
  }

  function render(groups, filter=""){
  // Tokenize search query and normalize each token. Empty tokens => show all.
  const tokens = (filter||"").toString().toLowerCase().split(/\s+/).map(t=>tokenNorm(t)).filter(Boolean);
    groupsEl.innerHTML = "";
    let total = 0;
    updateViewToggleUI();
    if(PRODUCT_VIEW_MODE === VIEW_MODES.TABLE){
      groupsEl.className = 'space-y-6';
    } else {
      groupsEl.className = 'grid gap-6 md:grid-cols-2';
    }

    Object.entries(groups).forEach(([program,items])=>{
      let keep;
      if(!tokens.length){
        keep = items.slice();
      } else {
        keep = items.filter(p=>{
          // build a searchable haystack from program, pack and details
          const hay = `${p.program||''} ${p.pack||''} ${p.details||''}`;
          const hayNorm = tokenNorm(hay);
          return tokens.every(tok => hayNorm.includes(tok));
        });
      }
      if(!keep.length) return;
      keep.sort((a,b)=>{
        const da = parseDurationMonths(a.pack);
        const db = parseDurationMonths(b.pack);
        if(isFinite(da) && isFinite(db) && da !== db) return da - db;
        const pa = Number(a.price)||0; const pb = Number(b.price)||0;
        if(pa !== pb) return pa - pb;
        return (a.pack||'').localeCompare(b.pack||'', 'th');
      });
      total += keep.length;

      if(PRODUCT_VIEW_MODE === VIEW_MODES.TABLE){
        const wrapper = document.createElement('div');
        wrapper.className = 'bg-white rounded-2xl shadow overflow-hidden';
        wrapper.innerHTML = `
          <div class="px-6 py-4 border-b">
            <h4 class="text-xl font-semibold">${program}</h4>

          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-200 text-sm">
              <thead class="bg-slate-50">
                <tr>
                  <th class="px-4 py-2 text-left font-semibold text-slate-600 w-1/2">แพ็กเกจ</th>
                  <th class="px-4 py-2 text-center font-semibold text-slate-600 w-28">ราคา</th>
                  <th class="px-4 py-2 text-center font-semibold text-slate-600 w-36">จัดการ</th>
                </tr>
              </thead>
              <tbody data-body class="bg-white divide-y divide-slate-100"></tbody>
            </table>
          </div>`;
        const body = wrapper.querySelector('[data-body]');
        keep.forEach(p=>{
          const row = document.createElement('tr');
          const displayPrice = getEffectivePrice(p);
          const showAgentBadge = priceHasAgentDiscount(p);
            row.innerHTML = `
              <td class="px-4 py-2">
                <div class="font-semibold text-slate-700 cursor-pointer pl-8" data-open="1">${p.pack}</div>
              </td>
              <td class="px-4 py-2 text-center text-slate-700 font-semibold whitespace-nowrap w-28">฿${currencyTH(displayPrice)}</td>
              <td class="px-4 py-2 text-center w-36">
                <button class="inline-flex items-center justify-center bg-indigo-600 text-white text-sm px-3 py-1.5 rounded-md mx-auto">ดูรายละเอียด</button>
              </td>`;
          const open = ()=> openProductModal(p);
          row.querySelectorAll('[data-open]').forEach(el=> el.addEventListener('click', open));
          row.querySelector('button').addEventListener('click', open);
          body.appendChild(row);
        });
        groupsEl.appendChild(wrapper);
      } else {
        const card = document.createElement('div');
        card.className = 'card-hover bg-white rounded-2xl p-6 shadow';
        card.innerHTML = `
          <div class="flex items-center justify-between mb-4">
            <div>
              <h4 class="text-xl font-semibold">${program}</h4>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3" data-body></div>`;
        const body = card.querySelector('[data-body]');
        keep.forEach(p=>{
          const item = document.createElement('div');
          item.className = 'border rounded-lg p-4 flex flex-col items-center text-center gap-2';
          const displayPrice = getEffectivePrice(p);
          const showAgentBadge = priceHasAgentDiscount(p);
          item.innerHTML = `
            ${p.image? `<img data-open="1" src="${p.image}" alt="${p.pack}" class="w-40 object-cover rounded-md border cursor-pointer" style="aspect-ratio: 800/550;" />` : ''}
            <div data-open="1" class="font-semibold cursor-pointer">${p.pack}</div>
            <div class="text-2xl font-extrabold mt-1">฿${currencyTH(displayPrice)}</div>
            <button class="bg-indigo-600 text-white text-sm px-3 py-1.5 rounded-md mt-2">ดูรายละเอียด</button>
          `;
          const open = ()=> openProductModal(p);
          item.querySelector('button').addEventListener('click', open);
          item.querySelectorAll('[data-open]').forEach(el=> el.addEventListener('click', open));
          body.appendChild(item);
        });
        groupsEl.appendChild(card);
      }
    });

    emptyEl.classList.toggle('hidden', total>0);
  }

  function formatProducts(items) {
    // Convert products to normalized shape
    return items.map(p => ({
      id: p.id,
      program: p.program||'อื่น ๆ',
      pack: p.name||p.pack||'สินค้า',
      price: Number(p.price)||0,
  agentPrice: Number(p.agentPrice)||0,
      image: p.image||'',
      requiresEmail: !!p.requiresEmail,
      requiresUsername: !!p.requiresUsername,
      requiresSN: !!p.requiresSN,
      requiresIMEI: !!p.requiresIMEI,
      requiresPassword: !!p.requiresPassword,
      details: p.details||''
  })).filter(x => (Number(x.price)||0) > 0 || (Number(x.agentPrice)||0) > 0);
  }

  function renderProductSteps(wrapperId, listId, details) {
    const wrap = document.getElementById(wrapperId);
    const list = document.getElementById(listId);
    if(!wrap || !list) return;
    // Keep admin-provided lines as-is (no automatic numbering). Convert URLs to clickable links
    const lines = String(details || '').split(/\r?\n/).map(line => line.trim()).filter(Boolean);
    if(!lines.length){
      wrap.classList.add('hidden');
      list.innerHTML = '';
      return;
    }
    wrap.classList.remove('hidden');
    // linkify helper: escape then replace URLs with anchors that open in new tab
    const linkify = (text) => {
      if(!text) return '';
      const escaped = escapeHtml(text);
      // Match http/https links
      return escaped.replace(/(https?:\/\/[^\s]+)/g, (m) => `<a href="${m}" target="_blank" rel="noopener" class="text-indigo-600 hover:underline">${m}</a>`);
    };
    // Render each line as a paragraph (preserves any leading numbering typed by admin)
    list.innerHTML = `<div class="space-y-1 text-sm leading-relaxed">${lines.map(l=> `<div>${linkify(l)}</div>`).join('')}</div>`;
  }

  // Show inline product detail panel on main page (does not add to cart by itself)
  function showProductDetail(p){
    CURRENT_DETAIL_PRODUCT = p;
    const panel = document.getElementById('productDetail');
    document.getElementById('detailImage').src = p.image||'';
    document.getElementById('detailImage').classList.toggle('hidden', !p.image);
    document.getElementById('detailProgram').textContent = p.program||'';
    document.getElementById('detailName').textContent = p.pack||p.name||'';
    
    // Set price display based on product type and agent pricing
    const displayPrice = getEffectivePrice(p);
    const isAgentDiscount = priceHasAgentDiscount(p);
    if(p.type === 'credit') {
      // price per credit
      document.getElementById('detailPrice').textContent = currencyTH(displayPrice||0);
      document.getElementById('detailPrice').parentElement.innerHTML = 
        `<div class="text-sm text-slate-600">ราคาต่อเครดิต</div>
         ฿<span id="detailPrice">${currencyTH(displayPrice||0)}</span>`;
    } else {
      document.getElementById('detailPrice').textContent = currencyTH(displayPrice||0);
      if(isAgentDiscount){
        const el = document.getElementById('detailPrice');
        el.insertAdjacentHTML('afterend', ' <span class="text-xs inline-block ml-2 bg-amber-100 text-amber-800 px-2 py-0.5 rounded">ราคาตัวแทน</span>');
      }
    }
    renderProductSteps('detailInstructionsWrap', 'detailInstructions', p.details);
    const fields = document.getElementById('detailFields');
    // build dynamic inputs depending on required fields (email, username, SN, IMEI)
    fields.innerHTML = '';

    const addField = (id,label,type='text')=>{
      const wrap = document.createElement('div');
      wrap.innerHTML = `<label class="text-sm">${label}</label><input id="${id}" type="${type}" class="w-full border rounded p-2 text-sm" />`;
      fields.appendChild(wrap);
    };
    
    // Add credit amount field for credit products
    if(p.type === 'credit') {
      const creditDiv = document.createElement('div');
      creditDiv.className = 'mb-4';
      creditDiv.innerHTML = `
        <label class="text-sm block">จำนวนเครดิต</label>
        <div class="flex gap-2 items-center">
          <input type="number" id="detailCredits" class="flex-1 border rounded p-2 text-sm" min="1" step="1" value="1">
          <span class="text-sm text-slate-600">เครดิต</span>
        </div>
      `;
      fields.appendChild(creditDiv);
      const credits = document.getElementById('detailCredits');
      if(credits) {
        // Auto-calculate price when credit amount changes
        credits.addEventListener('input', () => {
          const amount = Math.max(1, parseInt(credits.value) || 0);
          credits.value = amount;
          const pricePerCredit = Number(getEffectivePrice(p)) || 0;
          const total = amount * pricePerCredit;
          document.getElementById('detailPrice').textContent = currencyTH(total);
        });
      }
    }
    
    if(p.requiresEmail) addField('detailEmail','Email','email');
    if(p.requiresUsername) addField('detailUsername','Username','text');
    if(p.requiresSN) addField('detailSN','SN / Serial Number','text');
    if(p.requiresIMEI) addField('detailIMEI','IMEI','text');
    if(p.requiresPassword) addField('detailPassword','รหัสผ่าน','password');
    if(p.requiresDetails){
      const wrap = document.createElement('div');
      wrap.innerHTML = `<label class="text-sm">รายละเอียดสำหรับการสั่งซื้อ</label><textarea id="detailAdditional" rows="3" placeholder="กรุณากรอกรายละเอียดที่ต้องการให้ผู้ให้บริการทราบ" class="border rounded p-2 w-full"></textarea>`;
      fields.appendChild(wrap);
    }
    document.getElementById('detailMsg').textContent = '';
    panel.classList.remove('hidden');
    // scroll into view
    try{ panel.scrollIntoView({behavior:'smooth', block:'center'}); }catch{}
  }

  function hideProductDetail(){
    CURRENT_DETAIL_PRODUCT = null;
    document.getElementById('productDetail').classList.add('hidden');
  }

  function toggleSelected(p, btn){
    const id = p.id || (p.pack + '|' + p.program);
    if(SELECTED_IDS.has(id)){
      SELECTED_IDS.delete(id);
      if(btn) { btn.textContent = 'เลือกสินค้า'; btn.classList.remove('bg-amber-600'); btn.classList.add('bg-indigo-600'); }
    } else {
      SELECTED_IDS.add(id);
      if(btn) { btn.textContent = 'เลือกแล้ว'; btn.classList.add('bg-amber-600'); btn.classList.remove('bg-indigo-600'); }
      // show details when selected from main page
      showProductDetail(p);
    }
  }

  // Called from inline detail 'เพิ่มในตะกร้า'
  function addToCartFromDetail(){
    const p = CURRENT_DETAIL_PRODUCT;
    const msgEl = document.getElementById('detailMsg'); msgEl.textContent=''; msgEl.className='text-sm text-red-600';
    if(!p){ msgEl.textContent = 'ไม่พบสินค้า'; return; }
    
    // collect dynamic details
    const details = {
      emailForProduct: document.getElementById('detailEmail')?.value?.trim()||'',
      usernameForProduct: document.getElementById('detailUsername')?.value?.trim()||'',
      snForProduct: document.getElementById('detailSN')?.value?.trim()||'',
      imeiForProduct: document.getElementById('detailIMEI')?.value?.trim()||'',
      passwordForProduct: document.getElementById('detailPassword')?.value?.trim()||'',
      additionalDetails: document.getElementById('detailAdditional')?.value?.trim()||''
    };

    // Handle credit products
    if(p.type === 'credit') {
      const credits = document.getElementById('detailCredits');
      if(!credits || !credits.value) {
        msgEl.textContent = 'กรุณาระบุจำนวนเครดิต';
        return;
      }
      const amount = Math.max(1, parseInt(credits.value) || 0);
      if(amount < 1) {
        msgEl.textContent = 'จำนวนเครดิตต้องมากกว่า 0';
        return;
      }
      const pricePerCredit = Number(p.price) || 0;
      const total = amount * pricePerCredit;
      
      // Create a modified product object for the cart
      const creditProduct = {
        ...p,
        price: total,
        originalPrice: pricePerCredit,
        creditAmount: amount,
        pack: `${p.pack || p.name} (${amount} เครดิต)`
      };
      p = creditProduct;
    }
    if(p.requiresEmail && !details.emailForProduct){ msgEl.textContent = 'กรุณากรอกอีเมลสำหรับสินค้านี้'; return; }
    if(p.requiresUsername && !details.usernameForProduct){ msgEl.textContent = 'กรุณากรอก Username สำหรับสินค้านี้'; return; }
    if(p.requiresSN && !details.snForProduct){ msgEl.textContent = 'กรุณากรอก SN/Serial สำหรับสินค้านี้'; return; }
    if(p.requiresIMEI && !details.imeiForProduct){ msgEl.textContent = 'กรุณากรอก IMEI สำหรับสินค้านี้'; return; }
    if(p.requiresPassword && !details.passwordForProduct){ msgEl.textContent = 'กรุณากรอก รหัสผ่านสำหรับสินค้านี้'; return; }
    if(p.requiresDetails && !details.additionalDetails){ msgEl.textContent = 'กรุณากรอกรายละเอียดสำหรับสินค้านี้'; return; }
    // Add to cart (will open login modal if user not logged in)
    addToCart(p, details);
    msgEl.classList.remove('text-red-600'); msgEl.classList.add('text-emerald-700');
    msgEl.textContent = 'เพิ่มลงตะกร้าแล้ว';
    // clear selection for that product
    const id = p.id || (p.pack + '|' + p.program);
    if(SELECTED_IDS.has(id)) SELECTED_IDS.delete(id);
    // hide detail after short delay
    setTimeout(()=>{ hideProductDetail(); }, 800);
  }
  // ✅ ฟังก์ชันคำนวณเครดิตสะสมทั้งหมด (แก้ไขแล้ว)
  async function updateTotalTopupCredits() {
    if (!CURRENT_USER) {
      console.log('ไม่มีผู้ใช้ล็อกอิน');
      return;
    }

  try {
    console.log('กำลังคำนวณเครดิตสะสมสำหรับ:', CURRENT_USER.uid);
    
    const q = query(
      collection(db, 'creditRequests'),
      where('userId', '==', CURRENT_USER.uid),
      where('status', '==', 'approved')
    );

    const snap = await getDocs(q);
    let totalCredits = 0;
    
    console.log('พบคำขอเติมเครดิต:', snap.size, 'รายการ');
    
    snap.forEach(doc => {
      const data = doc.data();
      const amount = Number(data.amount || 0);
      totalCredits += amount;
      console.log('คำขอ:', doc.id, 'จำนวน:', amount, 'เครดิต');
    });

    const totalEl = document.getElementById('userTotalTopup');
    if (totalEl) {
      totalEl.textContent = `${totalCredits.toLocaleString('th-TH')} เครดิต`;
      console.log('อัปเดตเครดิตสะสมแล้ว:', totalCredits, 'เครดิต');
    } else {
      console.log('ไม่พบ element userTotalTopup');
    }
  } catch (err) {
    console.error('❌ อัปเดตเครดิตสะสมล้มเหลว:', err);
    const totalEl = document.getElementById('userTotalTopup');
    if (totalEl) totalEl.textContent = 'ไม่สามารถโหลดข้อมูล';
  }
}
  // ✅ เรียกใช้งานเมื่อเปิด modal เติมเครดิต
  document.getElementById('openTopupModal')?.addEventListener('click', () => {
    openModal('topupModal');
    updateUserCreditBalance();   // แสดงเครดิตคงเหลือ
    updateTotalTopupCredits();   // ✅ แสดงเครดิตสะสมทั้งหมด
  });


  async function setupFirestoreProducts() {
    const colRef = collection(db, 'products');
    return onSnapshot(colRef, (snap) => {
      FS_PRODUCTS = snap.docs.map(d => ({
        id: d.id,
        program: d.data().program || 'อื่น ๆ',
        pack: d.data().name || d.data().pack || 'สินค้า',
        price: Number(d.data().price) || 0,
        agentPrice: Number(d.data().agentPrice) || 0,
        image: d.data().image || '',
        requiresEmail: !!d.data().requiresEmail,
        requiresUsername: !!d.data().requiresUsername,
        requiresSN: !!d.data().requiresSN,
        requiresIMEI: !!d.data().requiresIMEI,
        requiresPassword: !!d.data().requiresPassword,
        requiresDetails: !!d.data().requiresDetails,
        details: d.data().details || '',
        // include type so UI can render credit-specific inputs (expects 'credit' or 'normal')
        // Fallbacks: read explicit `type`, then `isCredit` boolean, then heuristics (program/name contains 'เติมเครดิต')
        type: (function(){
          const data = d.data() || {};
          if(data.type) return data.type;
          if(data.isCredit) return 'credit';
          const combined = ((data.program||'') + ' ' + (data.name||'')).toLowerCase();
          if(combined.includes('เติมเครดิต')) return 'credit';
          return 'normal';
        })()
  })).filter(x => (Number(x.price) || 0) > 0 || (Number(x.agentPrice) || 0) > 0);
      updateProgramDropdown();
      render(groupByProgram(FS_PRODUCTS), searchEl?.value || "");
    });
  }

  async function performLogout(){
    try{ await signOut(auth); } finally { 
      CURRENT_USER=null; 
      CURRENT_USER_DOC=null; 
      IS_ADMIN=false; 
      updateHeaderAuth(); 
      sanitizeSearchPrefill();
      stopActivityMonitoring(); // ⭐ เพิ่มบรรทัดนี้
    }
  }
  // ----- Activity Monitoring Functions -----
  function resetActivityTimer() {
    // Skip timeout for admin users
    if (IS_ADMIN) {
      console.log('Admin user - timeout disabled');
      return false;
    }
    
    LAST_ACTIVITY = Date.now();
    
    // Save activity time to localStorage so it persists across page reloads
    try {
      localStorage.setItem(ACTIVITY_STORAGE_KEY, LAST_ACTIVITY.toString());
    } catch (e) {
      console.warn('Failed to save activity time to localStorage:', e);
    }
    
    if (ACTIVITY_TIMEOUT) {
      clearTimeout(ACTIVITY_TIMEOUT);
    }
    
    if (!CURRENT_USER) return;
    
    ACTIVITY_TIMEOUT = setTimeout(async () => {
      const timeSinceActivity = Date.now() - LAST_ACTIVITY;
      
      if (timeSinceActivity >= TIMEOUT_DURATION && CURRENT_USER) {
        console.log('Session timeout: logging out due to inactivity');
        await performLogout();
      }
    }, TIMEOUT_DURATION);
  }
  
  // Check if user has been inactive since last session
  function checkInactivityTimeout() {
    // Skip for admin users
    if (IS_ADMIN) {
      console.log('Admin user - timeout check disabled');
      return false;
    }
    
    if (!CURRENT_USER) return false;
    
    try {
      const lastActivityStr = localStorage.getItem(ACTIVITY_STORAGE_KEY);
      
      // ✅ ถ้าไม่มีข้อมูลเดิม แสดงว่าเพิ่ง login ใหม่ -> ไม่ควร timeout
      if (!lastActivityStr) {
        console.log('No previous activity found - fresh login, skipping timeout check');
        // บันทึก timestamp ปัจจุบันสำหรับ session ใหม่
        resetActivityTimer();
        return false;
      }
      
      const lastActivityTime = parseInt(lastActivityStr, 10);
      if (isNaN(lastActivityTime)) {
        console.log('Invalid activity timestamp, skipping timeout check');
        // บันทึก timestamp ใหม่
        resetActivityTimer();
        return false;
      }
      
      const timeSinceLastActivity = Date.now() - lastActivityTime;
      
      // ✅ ถ้าเวลาผ่านไปน้อยกว่า 10 วินาที แสดงว่าเพิ่ง login -> skip
      if (timeSinceLastActivity < 10000) {
        console.log('Recent activity detected (< 10s), skipping timeout check');
        // อัปเดต timestamp
        resetActivityTimer();
        return false;
      }
      
      if (timeSinceLastActivity >= TIMEOUT_DURATION) {
        console.log('Inactivity timeout detected after page reload. Time elapsed:', timeSinceLastActivity, 'ms');
        return true; // Timeout detected
      }
      
      // ไม่ timeout แต่ควรอัปเดต timestamp
      resetActivityTimer();
    } catch (e) {
      console.warn('Error checking inactivity timeout:', e);
      // กรณีเกิด error ให้ reset timer
      try { resetActivityTimer(); } catch(_) {}
    }
    
    return false;
  }


  function startActivityMonitoring() {
    // Skip for admin users
    if (IS_ADMIN) {
      console.log('Admin user - activity monitoring disabled');
      return; // Don't set up activity monitoring for admins
    }
    
    resetActivityTimer();
    
    const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
    
    let throttleTimer = null;
    const throttledReset = () => {
      if (!throttleTimer) {
        resetActivityTimer();
        throttleTimer = setTimeout(() => {
          throttleTimer = null;
        }, 1000);
      }
    };
    
    events.forEach(event => {
      document.addEventListener(event, throttledReset, { passive: true });
    });
  }

  function stopActivityMonitoring() {
    if (ACTIVITY_TIMEOUT) {
      clearTimeout(ACTIVITY_TIMEOUT);
      ACTIVITY_TIMEOUT = null;
    }
  }

  async function logoutWithConfirm(){
    if(!confirm("ต้องการออกจากระบบหรือไม่?")) return;
    await performLogout();
  }

  function updateHeaderAuth(){
    // Rebuild header actions every time to avoid stale elements and duplicated listeners.
    // We'll clear the container and recreate the buttons, then attach listeners.
    const bal = CURRENT_USER_DOC?.credits || 0;
    headerRight.innerHTML = '';

    if(CURRENT_USER){
      const container = document.createElement('div');
      container.className = 'flex items-center gap-3';

      const userInfo = document.createElement('div');
      userInfo.id = 'userInfo'; userInfo.className = 'text-sm text-slate-700'; 
      userInfo.innerHTML = IS_AGENT ? `<span class="font-bold bg-amber-100 text-amber-800 px-2 py-1 rounded-md">ตัวแทน</span> ${CURRENT_USER.email||''}` : (CURRENT_USER.email||'');
      const balanceInfo = document.createElement('div');
      balanceInfo.id = 'balanceInfo'; balanceInfo.className = 'text-sm font-semibold text-indigo-700'; balanceInfo.textContent = `เครดิต: ${currencyTH(bal)}`;

      const topupBtn = document.createElement('button'); topupBtn.id = 'topupBtn'; topupBtn.className = 'bg-emerald-600 text-white text-sm px-3 py-2 rounded-md'; topupBtn.textContent = 'เติมเครดิต';
      const cartBtn = document.createElement('button'); cartBtn.id = 'cartBtn'; cartBtn.className = 'bg-indigo-50 text-indigo-700 text-sm px-3 py-2 rounded-md shadow'; cartBtn.textContent = 'ตะกร้า (0)';
      const historyBtn = document.createElement('button'); historyBtn.id = 'historyBtn'; historyBtn.className = 'bg-slate-100 text-slate-700 text-sm px-3 py-2 rounded-md shadow'; historyBtn.textContent = 'ประวัติการสั่งซื้อ';
      const logoutBtn = document.createElement('button'); logoutBtn.id = 'logoutBtn'; logoutBtn.className = 'bg-slate-200 text-slate-700 text-sm px-3 py-2 rounded-md shadow'; logoutBtn.textContent = 'ออกจากระบบ';

      container.appendChild(userInfo);
      container.appendChild(balanceInfo);
      container.appendChild(topupBtn);
      container.appendChild(cartBtn);
      container.appendChild(historyBtn);

      // Admin-only buttons (only include when IS_ADMIN true)
      if(IS_ADMIN){
        const adminOrdersBtn = document.createElement('button'); adminOrdersBtn.id = 'adminOrdersBtn'; adminOrdersBtn.className = 'bg-amber-100 text-amber-800 text-sm px-3 py-2 rounded-md shadow'; adminOrdersBtn.textContent = 'คำสั่งซื้อ (Admin)';
        const openAdminCreditBtn = document.createElement('button'); openAdminCreditBtn.id = 'openAdminCreditBtn'; openAdminCreditBtn.className = 'bg-emerald-500 text-white text-sm px-3 py-2 rounded-md shadow'; openAdminCreditBtn.textContent = 'เติมเครดิตลูกค้า';
        const openAdminProductBtn = document.createElement('button'); openAdminProductBtn.id = 'openAdminProductBtn'; openAdminProductBtn.className = 'bg-indigo-600 text-white text-sm px-3 py-2 rounded-md shadow'; openAdminProductBtn.textContent = 'เพิ่มสินค้า';
        container.appendChild(adminOrdersBtn);
        container.appendChild(openAdminCreditBtn);
        container.appendChild(openAdminProductBtn);
      }

      container.appendChild(logoutBtn);
      headerRight.appendChild(container);

      

      // Attach listeners
      topupBtn.addEventListener('click', ()=>{ 
        if(!CURRENT_USER){ 
          openLoginModal(); 
          return; 
        } 
        const tmodal = document.getElementById('topupModal'); 
        if(tmodal) {
          showModalElement(tmodal);
          // แก้ไขส่วนนี้ - เพิ่มการอัปเดตเครดิตสะสม
          updateUserCreditBalance();   // แสดงเครดิตคงเหลือ
          updateTotalTopupCredits();   // ✅ แสดงเครดิตสะสมทั้งหมด
          // Show request history for current user
          const historyEl = document.getElementById('creditRequestHistory');
          if (historyEl) {
            historyEl.classList.remove('hidden');
            listenCreditRequests();
          }
        }
      });
      historyBtn.addEventListener('click', openHistoryModal);
      cartBtn.addEventListener('click', openCartModal);
      logoutBtn.addEventListener('click', logoutWithConfirm);
      if(IS_ADMIN){
        const adminOrdersBtnEl = document.getElementById('adminOrdersBtn');
        const openAdminCreditBtnEl = document.getElementById('openAdminCreditBtn');
        const openAdminProductBtnEl = document.getElementById('openAdminProductBtn');
        if(adminOrdersBtnEl){ adminOrdersBtnEl.addEventListener('click', ()=>{ try{ const saved = getSavedAdminFilter(); if(saved) applyFilterToUI(saved); else applyFilterToUI(['pending','accepted','rejected']); }catch{} const ordersModal = document.getElementById('adminOrdersModal'); showModalElement(ordersModal); listenOrdersForAdmin(); }); }
        if(openAdminCreditBtnEl){ openAdminCreditBtnEl.addEventListener('click', ()=>{ const creditModal = document.getElementById('adminCreditModal'); showModalElement(creditModal); }); }
        if(openAdminProductBtnEl){ openAdminProductBtnEl.addEventListener('click', ()=>{ const productModalEl = document.getElementById('adminProductModal'); showModalElement(productModalEl); }); }
      }
      updateCartCount();
    } else {
      // Guest view
      const container = document.createElement('div'); container.className = 'flex items-center gap-3';
      const cartBtn = document.createElement('button'); cartBtn.id = 'cartBtn'; cartBtn.className = 'bg-indigo-50 text-indigo-700 text-sm px-3 py-2 rounded-md shadow'; cartBtn.textContent = `ตะกร้า (${CART.length})`;
      const registerBtn = document.createElement('button'); registerBtn.id = 'registerBtn'; registerBtn.className = 'bg-emerald-600 text-white text-sm px-4 py-2 rounded-md shadow'; registerBtn.textContent = 'สมัครสมาชิก';
      const loginBtn = document.createElement('button'); loginBtn.id = 'loginBtn'; loginBtn.className = 'bg-indigo-600 text-white text-sm px-4 py-2 rounded-md shadow'; loginBtn.textContent = 'เข้าสู่ระบบ';
      container.appendChild(cartBtn); container.appendChild(registerBtn); container.appendChild(loginBtn);
      headerRight.appendChild(container);
      
      registerBtn.addEventListener('click', openRegModal);
      loginBtn.addEventListener('click', openLoginModal);
      cartBtn.addEventListener('click', openCartModal);
      updateCartCount();
    }
  sanitizeSearchPrefill();
  }

  async function ensureUserProfile(u){
    if(!u) return null;
    const ref = doc(db,'users',u.uid);
    try{
      const snap = await getDoc(ref);
      if(!snap.exists()){
        const rawEmail = (u.email||'');
        try{
          await setDoc(ref,{
            email: rawEmail,
            displayName: typeof u.displayName === 'string' ? u.displayName : '',
            credits: 0,
            createdAt: serverTimestamp()
          });
        }catch(e){
          // Could be permission rules preventing creation; log and continue
          console.warn('ensureUserProfile: failed to create user profile', e?.message||e);
        }
        // try to read it back (may still fail)
        try{ const newSnap = await getDoc(ref); return newSnap.exists()? newSnap.data() : null; }catch(e){ console.warn('ensureUserProfile: failed to read user profile after create', e?.message||e); return null; }
      }
      return snap.data();
    }catch(e){
      console.warn('ensureUserProfile: getDoc error', e?.message||e);
      return null;
    }
  }

  // Store last focused element before modal opens
  let lastFocusedElement = null;

  function showModalElement(el) {
    if (!el) return;
    
    // Store current focus
    lastFocusedElement = document.activeElement;
    
    // Show modal
    el.classList.add('active');
    
    // Set ARIA attributes
    el.removeAttribute('aria-hidden');
    el.setAttribute('role', 'dialog');
    el.setAttribute('aria-modal', 'true');
    
    // Get the modal content div (first child of modal)
    const modalContent = el.querySelector('div');
    if (modalContent) {
      modalContent.setAttribute('role', 'document');
    }
    
    // Find the first focusable element and focus it
    const focusable = el.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    if (focusable.length) {
      focusable[0].focus();
    }
    
    // Enable the modal
    el.removeAttribute('inert');
    
    // Make other content inert
    document.body.querySelectorAll('main, header, footer').forEach(section => {
      if (section !== el) {
        section.setAttribute('inert', '');
      }
    });

    // If admin opens the admin credit modal, start listening for credit requests
    try{
      if (el.id === 'adminCreditModal' && IS_ADMIN) {
        // start admin listener
        listenCreditRequests();
      }
      // If user opens topup modal, ensure their request history is listened to (some code already does this but keep as safety)
      if (el.id === 'topupModal' && !IS_ADMIN) {
        listenCreditRequests();
      }
    }catch(e){ console.warn('listenCreditRequests trigger failed', e?.message||e); }
  }

  function hideModalElement(el) {
    if (!el) return;
    
    // Hide modal
    el.classList.remove('active');
    
    // Reset ARIA attributes
    el.setAttribute('aria-hidden', 'true');
    el.removeAttribute('aria-modal');
    
    // Set modal inert
    el.setAttribute('inert', '');
    
    // Re-enable main content
    document.body.querySelectorAll('[inert]').forEach(section => {
      section.removeAttribute('inert');
    });
    
    // Restore focus
    if (lastFocusedElement) {
      lastFocusedElement.focus();
      lastFocusedElement = null;
    }
  }

  async function bootstrapFirestoreAfterSignup(u){
    try{
      const cfgRef = doc(db,'config','app');
      const cfg = await getDoc(cfgRef);
      if(!cfg.exists()){
        await setDoc(cfgRef,{
          initializedAt: serverTimestamp(),
          initializedBy: (u.email||'').toLowerCase()
        });
        // Optional: seed an example product so the DB is ready
        try{
          await addDoc(collection(db,'products'),{
            program: 'ตัวอย่าง',
            name: 'สินค้าแรก',
            price: 1,
            image: '',
            requiresEmail: false,
            createdAt: serverTimestamp()
          });
        }catch{}
      }
    }catch(e){ console.warn('bootstrap error', e?.message||e); }
  }

  function openRegModal(){ showModalElement(regModal); }
  function closeRegModal(){ hideModalElement(regModal); }
  function openLoginModal(){
    // reset login inputs and message to avoid stale success/error text
    try{
      const emailEl = document.getElementById('authEmailL');
      const passEl = document.getElementById('authPassL');
      const msgEl = document.getElementById('authMsgL');
      if(emailEl) emailEl.value = '';
      if(passEl) passEl.value = '';
      if(msgEl){ msgEl.textContent = ''; msgEl.className = 'text-sm text-red-600'; }
    }catch(_){ }
    showModalElement(loginModal);
  }
  function closeLoginModal(){
    try{
      const emailEl = document.getElementById('authEmailL');
      const passEl = document.getElementById('authPassL');
      const msgEl = document.getElementById('authMsgL');
      if(emailEl) emailEl.value = '';
      if(passEl) passEl.value = '';
      if(msgEl){ msgEl.textContent = ''; msgEl.className = 'text-sm text-red-600'; }
    }catch(_){ }
    hideModalElement(loginModal);
  }
  function openForgotModal(){ showModalElement(forgotModal); }

  function closeForgotModal(){ hideModalElement(forgotModal); }

  function openResetPasswordModal(email, code){
    PENDING_RESET_CODE = code || null;
    PENDING_RESET_EMAIL = email || '';
    const info = document.getElementById('resetEmail');
    if(info){ info.textContent = email ? `อีเมล: ${email}` : ''; }
    const pass1 = document.getElementById('resetPass');
    const pass2 = document.getElementById('resetPass2');
    if(pass1) pass1.value = '';
    if(pass2) pass2.value = '';
    const msg = document.getElementById('resetMsg');
    if(msg){ msg.textContent=''; msg.className='text-sm text-red-600'; }
    showModalElement(resetPasswordModal);
  }

  function closeResetPasswordModal(){
    hideModalElement(resetPasswordModal);
    PENDING_RESET_CODE = null;
    PENDING_RESET_EMAIL = "";
  }

  async function handleResetPassword(){
    const pass1 = document.getElementById('resetPass')?.value || '';
    const pass2 = document.getElementById('resetPass2')?.value || '';
    const msg = document.getElementById('resetMsg');
    if(msg){ msg.textContent=''; msg.className='text-sm text-red-600'; }
    if(!msg) return;
    if(!PENDING_RESET_CODE){ msg.textContent = 'ลิงก์รีเซ็ตไม่ถูกต้องหรือหมดอายุแล้ว'; return; }
    if(!pass1){ msg.textContent = 'กรุณากรอกรหัสผ่านใหม่'; return; }
    if(pass1.length < 6){ msg.textContent = 'รหัสผ่านใหม่ต้องมีอย่างน้อย 6 ตัวอักษร'; return; }
    if(pass1 !== pass2){ msg.textContent = 'รหัสผ่านใหม่ไม่ตรงกัน'; return; }
    try{
      await confirmPasswordReset(auth, PENDING_RESET_CODE, pass1);
      msg.classList.remove('text-red-600');
      msg.classList.add('text-emerald-700');
      msg.textContent = 'ตั้งรหัสผ่านใหม่เรียบร้อย';
      setTimeout(()=>{ closeResetPasswordModal(); openLoginModal(); }, 1500);
    }catch(e){
      msg.textContent = e?.message || 'ไม่สามารถตั้งรหัสผ่านใหม่ได้';
    }
  }


  function openOrderModal(product){
    if(!CURRENT_USER){
      // save pending single-product order so after login user can continue purchase
      PENDING_ORDER = product;
      AFTER_LOGIN_ACTION = { action: 'singleOrder' };
      openLoginModal();
      return;
    }
    PENDING_ORDER = product;
    const bal = CURRENT_USER_DOC?.credits || 0;
    const can = bal >= Number(product.price||0);
    document.getElementById('orderSummary').innerHTML = `
      <div>สินค้า: <strong>${product.pack}</strong></div>
      <div>ราคา: <strong>${currencyTH(product.price)}</strong> เครดิต</div>
      <div>เครดิตคงเหลือ: <strong>${currencyTH(bal)}</strong></div>
      <div class="${can? 'text-emerald-600':'text-red-600'}">${can? 'สามารถสั่งซื้อได้':'เครดิตไม่เพียงพอ'}</div>`;
    document.getElementById('orderEmailBlock').classList.toggle('hidden', !product.requiresEmail);
    document.getElementById('orderEmailInput').value = '';
    document.getElementById('orderPasswordBlock').classList.toggle('hidden', !product.requiresPassword);
    document.getElementById('orderPasswordInput').value = '';
    document.getElementById('orderUsernameBlock').classList.toggle('hidden', !product.requiresUsername);
    document.getElementById('orderUsernameInput').value = '';
    document.getElementById('orderSNBlock').classList.toggle('hidden', !product.requiresSN);
    document.getElementById('orderSNInput').value = '';
    document.getElementById('orderIMEIBlock').classList.toggle('hidden', !product.requiresIMEI);
    document.getElementById('orderIMEIInput').value = '';
    document.getElementById('orderDetailsBlock').classList.toggle('hidden', !product.requiresDetails);
    document.getElementById('orderDetailsInput').value = '';
    document.getElementById('orderMsg').textContent='';
    showModalElement(orderModal);
  }
  function closeOrder(){ hideModalElement(orderModal); PENDING_ORDER=null; }
  function openHistoryModal(){
    if(!CURRENT_USER){ openLoginModal(); return; }
    const list = document.getElementById('ordersTbody');
    if(list) list.innerHTML = '<tr><td colspan="5" class="p-4 text-slate-500">กำลังโหลด...</td></tr>';
    showModalElement(historyModal);
    // Fetch once in case snapshot hasn't arrived yet
    try {
      const qref = query(collection(db,'orders'), where('userId','==', CURRENT_USER.uid));
      getDocs(qref).then(snap=>{
        const rows = snap.docs.map(d=>({id:d.id, ...d.data()}));
        renderUserHistory(rows);
        // (removed top-up button from history modal; top-up handled via separate UI)
      });
    } catch {}
  }
  function closeHistoryModal(){ hideModalElement(historyModal); }

  async function placeOrder(){
    if(!PENDING_ORDER||!CURRENT_USER) return;
    const uref = doc(db,'users',CURRENT_USER.uid);
    const usnap = await getDoc(uref);
    const profile = usnap.data();
    const bal = profile?.credits||0;
    const price = Number(PENDING_ORDER.price||0);
    const emailForProduct = document.getElementById('orderEmailInput').value.trim();
    const passwordForProduct = document.getElementById('orderPasswordInput')?.value?.trim()||'';
    const usernameForProduct = document.getElementById('orderUsernameInput')?.value?.trim()||'';
    const snForProduct = document.getElementById('orderSNInput')?.value?.trim()||'';
    const imeiForProduct = document.getElementById('orderIMEIInput')?.value?.trim()||'';
    const additionalDetails = document.getElementById('orderDetailsInput')?.value?.trim()||'';
    if(PENDING_ORDER.requiresEmail && !emailForProduct){
      document.getElementById('orderMsg').textContent = 'กรุณากรอกอีเมลสำหรับสินค้านี้';
      return;
    }
    if(PENDING_ORDER.requiresPassword && !passwordForProduct){
      document.getElementById('orderMsg').textContent = 'กรุณากรอกรหัสผ่านสำหรับสินค้านี้';
      return;
    }
    if(PENDING_ORDER.requiresUsername && !usernameForProduct){ document.getElementById('orderMsg').textContent = 'กรุณากรอก Username สำหรับสินค้านี้'; return; }
    if(PENDING_ORDER.requiresSN && !snForProduct){ document.getElementById('orderMsg').textContent = 'กรุณากรอก SN/Serial สำหรับสินค้านี้'; return; }
    if(PENDING_ORDER.requiresIMEI && !imeiForProduct){ document.getElementById('orderMsg').textContent = 'กรุณากรอก IMEI สำหรับสิน้านี้'; return; }
    if(PENDING_ORDER.requiresDetails && !additionalDetails){ document.getElementById('orderMsg').textContent = 'กรุณากรอกรายละเอียดสำหรับสินค้านี้'; return; }
    if(bal < price){
      document.getElementById('orderMsg').textContent = 'เครดิตไม่เพียงพอ';
      return;
    }
    const orderRef = await addDoc(collection(db,'orders'),{
      userId: CURRENT_USER.uid,
      userEmail: (CURRENT_USER.email||'').toLowerCase(),
      status: 'pending',
      product: {
        id: PENDING_ORDER.id,
        name: PENDING_ORDER.pack,
        program: PENDING_ORDER.program,
        price: price,
        image: PENDING_ORDER.image||'',
        requiresEmail: !!PENDING_ORDER.requiresEmail,
        source: PENDING_ORDER.source||'firestore'
      },
      emailForProduct: emailForProduct||'',
      usernameForProduct: usernameForProduct||'',
      snForProduct: snForProduct||'',
      imeiForProduct: imeiForProduct||'',
      additionalDetails: additionalDetails||'',
      passwordForProduct: passwordForProduct||'',
      createdAt: serverTimestamp()
    });
    const lineName = CURRENT_USER?.email || CURRENT_USER_DOC?.email || 'customer';
    const lineNote = buildLineNote({
      orderId: orderRef.id,
      program: PENDING_ORDER.program,
      email: emailForProduct || CURRENT_USER?.email || '',
      username: usernameForProduct || '',
      sn: snForProduct || '',
      imei: imeiForProduct || '',
      password: passwordForProduct,
      additional: additionalDetails || ''
    });
    notifyLineOrder({
      name: lineName,
      product: PENDING_ORDER.pack,
      qty: 1,
      total: currencyTH(price),
      note: lineNote
    });
    document.getElementById('orderMsg').classList.remove('text-red-600');
    document.getElementById('orderMsg').classList.add('text-emerald-700');
    document.getElementById('orderMsg').textContent = 'ส่งคำสั่งซื้อแล้ว กำลังรอผู้ดูแลยืนยัน';
    setTimeout(closeOrder, 1000);
  }

  function listenOrdersForAdmin(){
    const listEl = document.getElementById('adminOrdersList') || document.getElementById('ordersList');
    if(!IS_ADMIN){ listEl.innerHTML=''; return; }
    // unsubscribe previous admin listener if present
    try{ if(typeof ADMIN_ORDERS_UNSUB === 'function'){ ADMIN_ORDERS_UNSUB(); ADMIN_ORDERS_UNSUB = null; } }catch{}
    // Determine statuses to query based on admin checkbox (include paid only if checked)
    // read statuses from saved filter (modal) or fallback to previous adminShowPaid checkbox
    let saved = getSavedAdminFilter();
    let statuses = null;
    if(saved && Array.isArray(saved) && saved.length>0){ statuses = saved; }
    else {
      const showPaid = !!document.getElementById('adminShowPaid')?.checked;
      statuses = showPaid ? ['pending','accepted','rejected','paid'] : ['pending','accepted','rejected'];
    }
    const qref = query(collection(db,'orders'), where('status','in', statuses));
    ADMIN_ORDERS_UNSUB = onSnapshot(qref, (snap)=>{
      listEl.innerHTML = '';
      if(!snap.docs.length){
        listEl.innerHTML = '<div class="text-slate-500 p-2">ไม่มีคำสั่งซื้อที่กำลังดำเนินการ / สำเร็จ / ไม่สำเร็จ</div>';
        return;
      }
      // build table header
      const table = document.createElement('table');
      table.className = 'w-full text-sm border-collapse';
      table.innerHTML = `
        <thead>
          <tr class="text-left border-b">
            <th class="p-2">สินค้า</th>
            <th class="p-2">ราคา</th>
            <th class="p-2">ลูกค้า</th>
            <th class="p-2">สถานะ</th>
            <th class="p-2">วันที่</th>
            <th class="p-2">หมายเหตุ</th>
            <th class="p-2">Order Reply</th>
            <th class="p-2">จัดการ</th>
          </tr>
        </thead>`;
      const tbody = document.createElement('tbody');
      tbody.className = 'text-slate-700';

      // sort snapshot docs by createdAt descending (newest first)
      const docs = Array.from(snap.docs || []);
      docs.sort((a,b)=>{
        const da = a?.data?.() || {};
        const db = b?.data?.() || {};
        const ta = da.createdAt && typeof da.createdAt.toMillis === 'function' ? da.createdAt.toMillis() : (da.createdAt ? Number(da.createdAt) : 0);
        const tb = db.createdAt && typeof db.createdAt.toMillis === 'function' ? db.createdAt.toMillis() : (db.createdAt ? Number(db.createdAt) : 0);
        return tb - ta; // newest first
      });
      docs.forEach(d=>{
        const data = d.data();
        const status = (data.status||'').toString();
        let statusLabel = status;
        let statusClass = 'bg-slate-100 text-slate-700';
        if(status === 'pending'){ statusLabel = 'กำลังดำเนินการ'; statusClass = 'bg-amber-200 text-amber-800'; }
        else if(status === 'accepted'){ statusLabel = 'สำเร็จ'; statusClass = 'bg-emerald-200 text-emerald-800'; }
        else if(status === 'rejected'){ statusLabel = 'ไม่สำเร็จ'; statusClass = 'bg-red-200 text-red-800'; }
        else if(status === 'paid'){ statusLabel = 'ชำระแล้ว'; statusClass = 'bg-sky-100 text-sky-800'; }

        const prodName = data.product?.name || data.pack || data.name || '-';
        const prodPrice = Number(data.product?.price || data.price || 0);
        const ts = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString('th-TH') : (data.createdAt? String(data.createdAt): '');
        const reply = data.reply || data.orderReply || data.adminMessage || data.resultMessage || data.message || data.note || '';
        const noteString = buildLineNote({
          email: data.emailForProduct || data.email || '',
          username: data.usernameForProduct || data.username || '',
          sn: data.snForProduct || data.sn || '',
          imei: data.imeiForProduct || data.imei || '',
          password: data.passwordForProduct || data.password || ''
        });
        const noteParts = noteString ? noteString.split('|').map(part => part.trim()).filter(Boolean) : [];
        const noteHtml = noteParts.length
          ? noteParts.map(part => `<div>${escapeHtml(part)}</div>`).join('')
          : '<span class="text-slate-400">-</span>';

        const tr = document.createElement('tr');
        tr.className = 'border-b';
        // Only show manage controls for pending orders
        let manageHtml = '';
        if(status === 'pending'){
          manageHtml = `
            <div class="flex flex-col gap-2">
              <textarea data-reply-id="${d.id}" class="w-full border rounded p-1 text-sm" rows="2" placeholder="Order Reply">${escapeHtml(reply)}</textarea>
              <div class="flex gap-2">
                <button data-accept-id="${d.id}" class="bg-emerald-600 text-white text-xs px-2 py-1 rounded">Accept</button>
                <button data-reject-id="${d.id}" class="bg-red-500 text-white text-xs px-2 py-1 rounded">Reject</button>
              </div>
              <div data-msg-id="${d.id}" class="text-sm"></div>
            </div>
          `;
        } else {
          // For accepted/rejected/paid orders do not show manage controls
          manageHtml = `<div class="text-sm text-slate-500">-</div>`;
        }

        tr.innerHTML = `
          <td class="p-2 align-top">${escapeHtml(prodName)}</td>
          <td class="p-2 align-top">${currencyTH(prodPrice)}</td>
          <td class="p-2 align-top">${escapeHtml(data.userEmail||data.userId)}</td>
          <td class="p-2 align-top"><span class="px-2 py-1 rounded ${statusClass} text-sm">${escapeHtml(statusLabel)}</span></td>
          <td class="p-2 align-top">${escapeHtml(ts)}</td>
          <td class="p-2 align-top">${noteHtml}</td>
          <td class="p-2 align-top"><div class="text-sm">${nl2br(escapeHtml(reply))}</div></td>
          <td class="p-2 align-top">${manageHtml}</td>
        `;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      listEl.appendChild(table);

      // attach listeners
      listEl.querySelectorAll('[data-accept-id]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-accept-id');
          const replyBox = listEl.querySelector(`[data-reply-id="${id}"]`);
          const msgEl = listEl.querySelector(`[data-msg-id="${id}"]`);
          msgEl.textContent = 'กำลังบันทึก...'; btn.disabled = true;
          try{
            const docSnap = await getDoc(doc(db,'orders',id));
            const data = docSnap.data();
            await adminAcceptOrder(id, data, replyBox.value.trim());
            msgEl.className = 'text-emerald-700'; msgEl.textContent = 'บันทึกแล้ว';
          }catch(err){ console.error(err); msgEl.className='text-red-600'; msgEl.textContent = err.message||'ล้มเหลว'; }
          finally{ btn.disabled=false; setTimeout(()=> msgEl.textContent='',2000); }
        });
      });

      listEl.querySelectorAll('[data-reject-id]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-reject-id');
          const replyBox = listEl.querySelector(`[data-reply-id="${id}"]`);
          const msgEl = listEl.querySelector(`[data-msg-id="${id}"]`);
          msgEl.textContent = 'กำลังบันทึก...'; btn.disabled = true;
          try{
            await adminRejectOrder(id, replyBox.value.trim());
            msgEl.className = 'text-emerald-700'; msgEl.textContent = 'บันทึกแล้ว';
          }catch(err){ console.error(err); msgEl.className='text-red-600'; msgEl.textContent = err.message||'ล้มเหลว'; }
          finally{ btn.disabled=false; setTimeout(()=> msgEl.textContent='',2000); }
        });
      });
    }, async (err)=>{
      console.error('orders listener error', err);
      listEl.innerHTML = `<div class="text-red-600 p-2">เกิดข้อผิดพลาดในการอ่านคำสั่งซื้อ: ${err.message}</div>`;
    });
  }

  async function queueOrderMail({ orderId, status, data = {}, reply = '' }){
    const customerEmail = ((data.userEmail || '')).trim();
    const productEmail = ((data.emailForProduct || '')).trim();
    const targetEmail = (status === 'rejected')
      ? (customerEmail || productEmail)
      : (productEmail || customerEmail);
    if(!targetEmail) throw new Error('ไม่พบอีเมลลูกค้าในคำสั่งซื้อ');

    const productName = data.product?.name || data.product?.program || data.pack || data.name || 'สินค้า';
    const qtyRaw = Number(data.quantity ?? data.qty ?? 1);
    const quantity = Number.isFinite(qtyRaw) && qtyRaw > 0 ? qtyRaw : 1;
    const price = Number(data.product?.price ?? data.price ?? 0);
    const totalText = currencyTH(price);
    const statusSuccess = status === 'accepted';

    const detailLines = [
      `หมายเลขคำสั่งซื้อ: ${String(orderId || '').trim() || '-'}`,
      `สินค้า: ${productName}`,
      `จำนวน: ${quantity}`,
      `ยอดรวม: ${totalText} บาท`
    ];

    if(productEmail && productEmail.toLowerCase() !== targetEmail.toLowerCase()){
      detailLines.push(`อีเมลสำหรับสินค้า: ${productEmail}`);
    }
    if(data.usernameForProduct) detailLines.push(`Username: ${data.usernameForProduct}`);
    if(data.passwordForProduct) detailLines.push(`Password: ${data.passwordForProduct}`);
    if(data.sn || data.snForProduct) detailLines.push(`SN: ${data.sn || data.snForProduct}`);
    if(data.imei || data.imeiForProduct) detailLines.push(`IMEI: ${data.imei || data.imeiForProduct}`);

    const noteCandidates = [data.note, data.orderNote, data.message, data.resultMessage, data.adminMessage];
    const extraNotes = Array.from(new Set(noteCandidates.map(v => (v ?? '').toString().trim()).filter(Boolean)));
    if(extraNotes.length){
      detailLines.push(`หมายเหตุ: ${extraNotes.join(' | ')}`);
    }

    // Handle admin reply with line breaks support
  if(reply){
    const replyLines = reply.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    if(replyLines.length > 0){
      detailLines.push(`ข้อความจากผู้ดูแล:`);
      // แยกแต่ละบรรทัดเป็นรายการย่อย (ไม่มี bullet หน้า)
      replyLines.forEach(line => {
        detailLines.push(`  ${line}`); // เยื้อง 2 ช่อง
      });
    }
  }
    const detailText = detailLines.map((line, idx) => {
      // ถ้าเป็นบรรทัดที่เยื้อง (ข้อความจากแอดมิน) ไม่ต้องใส่ bullet
      if(line.startsWith('  ')) {
        return line; // คืนค่าตามเดิม (มีการเยื้องอยู่แล้ว)
      }
      return `- ${line}`; // บรรทัดปกติใส่ bullet
    }).join('\n');

    const headerText = statusSuccess
      ? `ขอบคุณที่สั่งซื้อกับ Elite Unlock\nยอดรวม ${totalText} บาท ชำระเรียบร้อยแล้ว`
      : `ขออภัย คำสั่งซื้อของคุณไม่สามารถดำเนินการได้\nยอดรวม ${totalText} บาท ได้รับการคืนเครดิตเรียบร้อยแล้ว`;
    
    const textBody = `${headerText}\n\nรายละเอียดคำสั่งซื้อ\n${detailText}\n\n— Elite Unlock https://eliteunlock.shop/\nTel: 062-607-2670\nLine: @825lhqmj`;

    // ✅ สร้าง HTML Version (ใช้ <br> และ styling)
    const headingStatus = statusSuccess ? 'สำเร็จ' : 'ไม่สำเร็จ';
    
    const htmlList = detailLines.map((line, idx) => {
      // ถ้าเป็นหัวข้อ "ข้อความจากผู้ดูแล:"
      if(line === 'ข้อความจากผู้ดูแล:'){
        return `<li><strong>${escapeHtml(line)}</strong></li>`;
      }
      // ถ้าเป็นบรรทัดย่อยของข้อความแอดมิน (เยื้อง)
      if(line.startsWith('  ')){
        // ใช้ <div> แทน <li> และใส่ style เยื้อง + ขึ้นบรรทัดใหม่
        return `<div style="margin-left:20px; white-space:pre-wrap;">${escapeHtml(line.trim())}</div>`;
      }
      // บรรทัดปกติ
      return `<li>${escapeHtml(line)}</li>`;
    }).join('');

    const htmlBody = `<div style="font-family:sans-serif">
    <h3>ใบยืนยันคำสั่งซื้อ ${headingStatus}</h3>
    <p>${statusSuccess ? `ยอดรวม ${escapeHtml(totalText)} บาท ชำระเรียบร้อยแล้ว` : `ยอดรวม ${escapeHtml(totalText)} บาท ได้รับการคืนเครดิตเรียบร้อยแล้ว`}</p>
    <h4 style="margin-top:16px;">รายละเอียดคำสั่งซื้อ</h4>
    <ul style="padding-left:20px;margin:8px 0;">${htmlList}</ul>
    <p style="margin-top:16px;">Elite Unlock<br>Tel: 062-607-2670<br>Line: @825lhqmj</p>
  </div>`;

    await addDoc(collection(db,'mail'),{
      to: [targetEmail],
      from: 'Elite Unlock <eliteunlockshop@gmail.com>',
      replyTo: 'eliteunlockshop@gmail.com',
      message: {
        subject: statusSuccess ? 'คำสั่งซื้อ สินค้า สำเร็จ' : 'คำสั่งซื้อ สินค้า ไม่สำเร็จ',
        text: textBody,
        html: htmlBody
      },
      metadata: {
        orderId: String(orderId || ''),
        status,
        productName,
        total: price,
        queuedBy: 'admin-action'
      },
      createdAt: serverTimestamp()
    });
  }

  async function adminAcceptOrder(orderId, data, reply){
    const orderData = { ...(data || {}) };
    const needsMail = !orderData.mailAcceptedAt;
    if(needsMail){
      const targetEmail = ((orderData.emailForProduct || orderData.userEmail || '')).trim();
      if(!targetEmail) throw new Error('ไม่พบอีเมลลูกค้าในคำสั่งซื้อ');
    }
    const oref = doc(db,'orders',orderId);
    const payload = { status: 'accepted', acceptedAt: serverTimestamp() };
    if(reply) payload.reply = reply;
    await updateDoc(oref, payload);
    if(needsMail){
      orderData.status = 'accepted';
      orderData.reply = reply || orderData.reply || '';
      await queueOrderMail({ orderId, status: 'accepted', data: orderData, reply: orderData.reply });
      await updateDoc(oref, { mailAcceptedAt: serverTimestamp() });
    }
  }

  async function adminRejectOrder(orderId, reply){
    const oref = doc(db,'orders',orderId);
    let mailData = null;
    // Refund credits to user and mark order refunded atomically to avoid double refunds
    await runTransaction(db, async (tx) => {
      const osnap = await tx.get(oref);
      if(!osnap.exists()) throw new Error('ไม่พบคำสั่งซื้อ');
      const odata = osnap.data();
      const alreadyQueued = !!odata.mailRejectedAt;
      if(!alreadyQueued){
        const targetEmail = ((odata.emailForProduct || odata.userEmail || '')).trim();
        if(!targetEmail) throw new Error('ไม่พบอีเมลลูกค้าในคำสั่งซื้อ');
      }
      const payload = { status: 'rejected', rejectedAt: serverTimestamp() };
      if(reply) payload.reply = reply;
      if(odata.refunded){
        tx.update(oref, payload);
      }else{
        const uid = odata.userId;
        const price = Number(odata.product?.price || 0);
        const uref = doc(db,'users', uid);
        const usnap = await tx.get(uref);
        if(!usnap.exists()) throw new Error('ไม่พบผู้ใช้งานสำหรับคืนเครดิต');
        const currentCredits = Number(usnap.data()?.credits || 0);
        // update user credits and order doc
        tx.update(uref, { credits: currentCredits + price });
        payload.refunded = true;
        payload.refundedAt = serverTimestamp();
        tx.update(oref, payload);
      }
      if(!alreadyQueued){
        mailData = { ...odata, status: 'rejected', refunded: payload.refunded === true ? true : odata.refunded };
        mailData.reply = reply || odata.reply || '';
        if(payload.refundedAt) mailData.refundedAt = payload.refundedAt;
      }
    });
    if(mailData){
      await queueOrderMail({ orderId, status: 'rejected', data: mailData, reply: mailData.reply });
      await updateDoc(oref, { mailRejectedAt: serverTimestamp() });
    }
  }

  async function addCreditsByEmail(email, amount){
    const emailTrim = (email || '').trim();
    if(!emailTrim) throw new Error('กรุณากรอกอีเมล');
    const qref = query(collection(db,'users'), where('email','==', emailTrim));
    const snap = await getDocs(qref);
    if(snap.empty) throw new Error('ไม่พบผู้ใช้อีเมลนี้');
    const d = snap.docs[0];
    await updateDoc(doc(db,'users',d.id),{ credits: increment(Number(amount)||0) });
    // ตรวจสอบยอดสะสมและอัพเกรดตัวแทนถ้าครบ
    try{ await checkAndUpgradeAgent(d.id); }catch(e){ console.warn('auto-upgrade after addCreditsByEmail failed', e); }
  }

  async function submitCreditRequest(amount, proofImageUrl) {
    try {
      if (!CURRENT_USER) throw new Error('กรุณาเข้าสู่ระบบ');
      if (!amount || amount < 1) throw new Error('จำนวนเครดิตต้องมากกว่า 0');
      if (!proofImageUrl) throw new Error('กรุณาแนบหลักฐานการโอนเงิน');

      console.log('Submitting credit request:', { amount, proofImageUrl });

      // Create credit request only
      const requestRef = await addDoc(collection(db, 'creditRequests'), {
        userId: CURRENT_USER.uid,
        userEmail: CURRENT_USER.email,
        amount: Number(amount),
        status: 'pending',
        proofImageUrl: proofImageUrl,
        createdAt: serverTimestamp()
      });

      // Send LINE notification with explicit type:credit
      await notifyLineOrder({
        type: 'credit',
        name: CURRENT_USER.email, // send email as name for better visibility
        email: CURRENT_USER.email,
        amount: Number(amount),
        proofImageUrl: proofImageUrl
      });

      return requestRef.id;
  } catch (err) {
      console.error('Error submitting credit request:', err);
      throw err;
    }
  }

  async function confirmCreditRequest(requestId) {
    try {
      if (!IS_ADMIN) throw new Error('Unauthorized');
      
      const requestRef = doc(db, 'creditRequests', requestId);
      const requestSnap = await getDoc(requestRef);
      if (!requestSnap.exists()) throw new Error('ไม่พบคำขอเติมเครดิต');
    
      const data = requestSnap.data();
      if (data.status !== 'pending') throw new Error('คำขอนี้ถูกดำเนินการไปแล้ว');

      // Update credit request status
      await updateDoc(requestRef, {
        status: 'approved',
        approvedAt: serverTimestamp(),
        approvedBy: CURRENT_USER.email
      });

      // Add credits to user
      const userRef = doc(db, 'users', data.userId);
      await updateDoc(userRef, {
        credits: increment(data.amount)
      });
      
      // หลังจากเพิ่มเครดิตแล้ว ตรวจสอบยอดสะสมเพื่ออัพเกรดเป็นตัวแทนอัตโนมัติ
      try{
        await checkAndUpgradeAgent(data.userId);
      }catch(e){ console.warn('auto-upgrade after confirmCreditRequest failed', e); }
      // Send confirmation email to user
      await addDoc(collection(db, 'mail'), {
        to: [data.userEmail],
        from: 'Elite Unlock <noreply@eliteunlock.com>',
        message: {
          subject: 'เติมเครดิตสำเร็จ',
          html: `
            <div>
              <h3>เติมเครดิตสำเร็จ</h3>
              <p>เติมเครดิตจำนวน ${data.amount} เครดิต เข้าบัญชีของคุณเรียบร้อยแล้ว</p>
              <p>หากมีข้อสงสัยกรุณาติดต่อ Elite Unlock Tel: 062-607-2670 LINE: @825lhqmj</p>
            </div>
          `,
          text: `เติมเครดิตสำเร็จ\n\nเติมเครดิตจำนวน ${data.amount} เครดิต เข้าบัญชีของคุณเรียบร้อยแล้ว\n\nหากมีข้อสงสัยกรุณาติดต่อ Elite Unlock Tel: 062-607-2670 LINE: @825lhqmj`
        },
        createdAt: serverTimestamp()
      });

      return true;
    } catch (err) {
      console.error('Error confirming credit request:', err);
      throw err;
    }
  }

// ตรวจสอบยอดสะสมของผู้ใช้ และอัพเกรดเป็นตัวแทนถ้ายอดสะสมครบเงื่อนไข
  async function checkAndUpgradeAgent(userId) {
    try {
      if (!userId) return false;
      
      // ✅ ตรวจสอบสถานะปัจจุบันก่อน - ถ้าเป็นตัวแทนอยู่แล้วไม่ต้องทำอะไร
      const uref = doc(db, 'users', userId);
      const userSnap = await getDoc(uref);
      if (!userSnap.exists()) {
        console.log('checkAndUpgradeAgent: User document not found');
        return false;
      }
      
      const userData = userSnap.data();
      const isAlreadyAgent = userData.isAgent === true && (userData.role === 2 || Number(userData.role) === 2);
      
      if (isAlreadyAgent) {
        console.log('checkAndUpgradeAgent:', userId, 'already an agent, skipping upgrade');
        return false;
      }
      
      // รวมยอดเครดิตที่อนุมัติทั้งหมด (creditRequests.status == 'approved')
      const qref = query(
        collection(db, 'creditRequests'),
        where('userId', '==', userId),
        where('status', '==', 'approved')
      );
      const snap = await getDocs(qref);
      let total = 0;
      snap.forEach(s => { const d = s.data(); total += Number(d.amount || 0); });
      console.log('checkAndUpgradeAgent:', userId, 'totalApprovedCredits=', total);
      
      const THRESHOLD = 4500;
      if (total >= THRESHOLD) {
        try {
          // ✅ เปลี่ยนเป็นตัวแทน: isAgent = true และ role = 2
          await updateDoc(uref, { 
            isAgent: true, 
            role: 2,
            agentActivatedAt: serverTimestamp() 
          });
          console.log('✅ Upgraded user to agent:', userId);
        } catch(e){ 
          console.warn('Failed to mark user isAgent in profile', e); 
          return false;
        }

        // If current client user is the one upgraded, update client state immediately
        if (CURRENT_USER && CURRENT_USER.uid === userId) {
          CURRENT_USER_DOC = CURRENT_USER_DOC || {};
          CURRENT_USER_DOC.isAgent = true;
          CURRENT_USER_DOC.role = 2;
          IS_AGENT = true;
          updateHeaderAuth();
          render(groupByProgram(FS_PRODUCTS), searchEl?.value || "");
        }

        // Queue a polite notification email (non-blocking)
        try{
          const targetEmail = userData.email || '';
          if (targetEmail) {
            await addDoc(collection(db,'mail'),{
              to: [targetEmail],
              from: 'Elite Unlock <noreply@eliteunlock.com>',
              message: {
                subject: 'ยินดีด้วย — คุณได้รับการอัพเกรดเป็นตัวแทน',
                text: `ระบบตรวจพบว่ายอดสะสมเติมเครดิตของคุณครบ ${THRESHOLD} เครดิต\nยินดีด้วย คุณได้รับสิทธิ์อัพเกรดเป็นตัวแทนแล้ว สามารถใช้ราคาตัวแทนเมื่อสั่งซื้อสินค้าได้ทันที\n\nหากต้องการความช่วยเหลือ ติดต่อ LINE: @825lhqmj`,
                html: `<div style="font-family:sans-serif"><h3>ยินดีด้วย — คุณได้รับการอัพเกรดเป็นตัวแทน</h3><p>ระบบตรวจพบว่ายอดสะสมเติมเครดิตของคุณครบ <strong>${THRESHOLD} เครดิต</strong>.</p><p>คุณจะได้รับราคาตัวแทนเมื่อสั่งซื้อสินค้าโดยอัตโนมัติ หากมีคำถาม กรุณาติดต่อ LINE: @825lhqmj</p></div>`
              },
              metadata: { userId, triggeredBy: 'auto-upgrade' },
              createdAt: serverTimestamp()
            });
          }
        }catch(e){ console.warn('Unable to queue upgrade email', e); }

        return true;
      }
      return false;
    } catch (e) {
      console.error('checkAndUpgradeAgent error', e);
      return false;
    }
  }


  // แทนที่ของเดิมทั้งหมด
  function listenCreditRequests() {
    console.log('Starting listenCreditRequests');
    try {
      if (CREDIT_REQUESTS_UNSUB) {
        CREDIT_REQUESTS_UNSUB();
        CREDIT_REQUESTS_UNSUB = null;
      }

      if (!CURRENT_USER) {
        console.log('No user logged in, not listening for credit requests');
        return;
      }

      // หา list ของแต่ละ modal
      let adminListEl = null;
      const adminModal = document.getElementById('adminCreditModal');
      if (adminModal) adminListEl = adminModal.querySelector('#creditRequestsList');

      let userListEl = null;
      const topupModal = document.getElementById('topupModal');
      if (topupModal) {
        const historySection = topupModal.querySelector('#creditRequestHistory');
        if (historySection) userListEl = historySection.querySelector('#creditRequestsList');
      }

      // ✅ เลือกปลายทางตาม modal ที่เปิดอยู่จริง (class .active)
      const isAdminModalActive = !!adminModal && adminModal.classList.contains('active');
      const isTopupModalActive = !!topupModal && topupModal.classList.contains('active');

      let listEl = null;
      if (isAdminModalActive && adminListEl) {
        listEl = adminListEl;              // แสดงแบบมุมมองแอดมิน
      } else if (isTopupModalActive && userListEl) {
        listEl = userListEl;               // แสดงประวัติของ "ฉัน" (แอดมินก็เห็นของตัวเองในหน้านี้)
      } else {
        // fallback: ถ้าไม่ได้เปิด modal ใด ให้เลือกตามบริบทที่มีอยู่
        listEl = userListEl || adminListEl;
      }

      if (!listEl) {
        console.warn('Credit request list element not found for current view');
        return;
      }

      // Loading state
      listEl.innerHTML = '<div class="text-sm text-gray-500">กำลังโหลด...</div>';

      const creditRequestsRef = collection(db, 'creditRequests');
      const queryRef = query(
        creditRequestsRef,
        orderBy('createdAt', 'desc'),
        limit(100)
      );

      CREDIT_REQUESTS_UNSUB = onSnapshot(queryRef, (snap) => {
        listEl.innerHTML = '';
        if (snap.empty) {
          listEl.innerHTML = `<div class="text-sm text-gray-500">ไม่พบคำขอเติมเครดิต</div>`;
          return;
        }

        // ✅ กรองตามปลายทาง:
        // - ถ้าเขียนลง userList (หน้า topupModal): แสดงเฉพาะของ CURRENT_USER ทุกสถานะ
        // - ถ้าเขียนลง adminList: แสดงเฉพาะ pending ตามเดิม
        const isUserView = !!userListEl && listEl === userListEl;
        const docs = snap.docs.filter(d => {
          const data = d.data();
          if (isUserView) {
            return data.userId === CURRENT_USER.uid;  // ประวัติของฉัน (รวม approved/rejected)
          } else {
            return data.status === 'pending';         // มุมมองแอดมิน (pending)
          }
        });
        // ถ้าเป็นมุมมองผู้ใช้ ให้คำนวณยอดสะสมจากรายการอนุมัติ แล้วไปอัปเดตที่หน้าจอ
        if (!IS_ADMIN && listEl) {
          const totalApproved = docs.reduce((sum, d) => {
            const x = d.data();
            return sum + (x.status === 'approved' ? Number(x.amount || 0) : 0);
          }, 0);
          const totalEl = document.getElementById('userTotalTopup');
          if (totalEl) totalEl.textContent = `${totalApproved.toLocaleString('th-TH')} เครดิต`;
          updateTotalTopupCredits();
        }

        if (docs.length === 0) {
          listEl.innerHTML = `<div class="text-sm text-gray-500">ไม่พบคำขอเติมเครดิต</div>`;
          return;
        }

        docs.forEach((docSnap) => {
          const data = docSnap.data();
          const status = data.status || 'pending';
          let statusText = 'กำลังตรวจสอบ';
          let statusClass = 'bg-amber-100 text-amber-800 font-medium';
          if (status === 'approved') {
            statusText = 'อนุมัติแล้ว ✓';
            statusClass = 'bg-emerald-100 text-emerald-800 font-medium';
          } else if (status === 'rejected') {
            statusText = 'ปฏิเสธ ✗';
            statusClass = 'bg-red-100 text-red-800 font-medium';
          }
          const createdAt = data.createdAt?.toDate?.() || null;
          const dt = createdAt
            ? createdAt.toLocaleString('th-TH', { dateStyle: 'short', timeStyle: 'short' })
            : '-';

          listEl.insertAdjacentHTML('beforeend', `
            <div class="p-3 border rounded-md bg-white flex flex-col gap-2">
              <div class="flex items-center justify-between">
                <div class="font-medium">${data.userEmail || '-'}</div>
                <span class="px-2 py-0.5 rounded ${statusClass}">${statusText}</span>
              </div>
              <div class="text-sm text-slate-600">
                จำนวน: <span class="font-semibold">${Number(data.amount || 0).toLocaleString('th-TH')}</span> เครดิต
                · เวลา: ${dt}
              </div>
              ${data.proofImageUrl ? `
                <a href="${data.proofImageUrl}" target="_blank" rel="noopener" class="text-sm text-indigo-600 hover:underline">ดูสลิป</a>
              ` : ''}
              ${
                // ปุ่มสำหรับแอดมินเฉพาะในมุมมองแอดมิน และเฉพาะ pending
                (!isUserView && status === 'pending')
                  ? `<div class="flex gap-2 pt-2">
                      <button class="px-3 py-1 rounded bg-emerald-600 text-white text-sm"
                              data-approve="${docSnap.id}">อนุมัติ</button>
                      <button class="px-3 py-1 rounded bg-red-600 text-white text-sm"
                              data-reject="${docSnap.id}">ปฏิเสธ</button>
                    </div>`
                  : ''
              }
            </div>
          `);
        });

        // bind ปุ่มอนุมัติ/ปฏิเสธ เฉพาะใน admin view
        if (listEl === adminListEl) {
          listEl.querySelectorAll('[data-approve]').forEach(btn => {
            btn.addEventListener('click', async () => {
              try {
                await confirmCreditRequest(btn.getAttribute('data-approve'));
              } catch(e) { alert(e?.message || 'ผิดพลาด'); }
            });
          });
          listEl.querySelectorAll('[data-reject]').forEach(btn => {
            btn.addEventListener('click', async () => {
              try {
                await rejectCreditRequest(btn.getAttribute('data-reject'));
              } catch(e) { alert(e?.message || 'ผิดพลาด'); }
            });
          });
        }
      });
    } catch (err) {
      console.error('listenCreditRequests error', err);
    }
  }


  // Reject a credit request
  async function rejectCreditRequest(requestId) {
    try {
      if (!IS_ADMIN) throw new Error('Unauthorized');
      
      const requestRef = doc(db, 'creditRequests', requestId);
      const requestSnap = await getDoc(requestRef);
      if (!requestSnap.exists()) throw new Error('ไม่พบคำขอเติมเครดิต');
      
      const data = requestSnap.data();
      if (data.status !== 'pending') throw new Error('คำขอนี้ถูกดำเนินการไปแล้ว');

      // Update request status
      await updateDoc(requestRef, {
        status: 'rejected',
        rejectedAt: serverTimestamp(),
        rejectedBy: CURRENT_USER.email
      });

      // Send rejection email
      await addDoc(collection(db, 'mail'), {
        to: [data.userEmail],
        from: 'Elite Unlock <noreply@eliteunlock.com>',
        message: {
          subject: 'คำขอเติมเครดิตถูกปฏิเสธ',
          html: `
            <div>
              <h3>คำขอเติมเครดิตถูกปฏิเสธ</h3>
              <p>คำขอเติมเครดิตจำนวน ${data.amount} เครดิต ของคุณถูกปฏิเสธ</p>
              <p>กรุณาติดต่อ LINE: @825lhqmj เพื่อสอบถามข้อมูลเพิ่มเติม</p>
            </div>
          `,
          text: `คำขอเติมเครดิตถูกปฏิเสธ\n\nคำขอเติมเครดิตจำนวน ${data.amount} เครดิต ของคุณถูกปฏิเสธ\n\nกรุณาติดต่อ LINE: @825lhqmj เพื่อสอบถามข้อมูลเพิ่มเติม`
        },
        createdAt: serverTimestamp()
      });

      return true;
    } catch (err) {
      console.error('Error rejecting credit request:', err);
      throw err;
    }
  }

  async function addProductFS(p){
    await addDoc(collection(db,'products'),{
      program: norm(p.program),
      name: norm(p.name),
      price: Number(p.price)||0,
      agentPrice: Number(p.agentPrice)||0,
      image: norm(p.image||''),
      requiresEmail: !!p.requiresEmail,
      requiresPassword: !!p.requiresPassword,
      requiresUsername: !!p.requiresUsername,
      requiresSN: !!p.requiresSN,
      requiresIMEI: !!p.requiresIMEI,
      requiresDetails: !!p.requiresDetails,
      details: norm(p.details||''),
      // preserve explicit `type` when provided (admin UI sets `type`),
      // otherwise fall back to legacy `isCredit` boolean
      type: (p.type && String(p.type)) ? String(p.type) : (p.isCredit ? 'credit' : 'normal'),
      createdAt: serverTimestamp()
    });
  }

  // ----- Cart functions -----
  function addToCart(p, details={}){
    const item = {
      id: p.id,
      source: p.source||'firestore',
      program: p.program,
      name: p.pack||p.name,
      // For credit products we expect p.price to already be a total; otherwise compute effective price
      price: p.creditAmount ? Number(p.price)||0 : getEffectivePrice(p),
      image: p.image||'',
      requiresEmail: !!p.requiresEmail,
      requiresUsername: !!p.requiresUsername,
      requiresSN: !!p.requiresSN,
      requiresIMEI: !!p.requiresIMEI,
      requiresDetails: !!p.requiresDetails,
      emailForProduct: details.emailForProduct||'',
      usernameForProduct: details.usernameForProduct||'',
      snForProduct: details.snForProduct||'',
      imeiForProduct: details.imeiForProduct||'',
      passwordForProduct: details.passwordForProduct||''
      ,additionalDetails: details.additionalDetails||''
    };
    CART.push(item);
    saveCart();
    openCartModal();
  }

  function openCartModal(){
    // allow guests to open and inspect cart; require login only at confirmation
    renderCart();
    showModalElement(cartModal);
  }
  function closeCartModal(){ hideModalElement(cartModal); }

  let PRODUCT_SELECTED = null;
  function openProductModal(p){
    // allow viewing product modal even when not logged in
    PRODUCT_SELECTED = p;
    document.getElementById('pdImage').src = p.image||'';
    document.getElementById('pdImage').classList.toggle('hidden', !p.image);
    document.getElementById('pdProgram').textContent = p.program||'';
    document.getElementById('pdName').textContent = p.pack||p.name||'';
    
    // Set price display based on product type and agent pricing
    const priceLabel = document.getElementById('pdPriceLabel');
    const displayPrice = getEffectivePrice(p);
    const isAgentDiscount = priceHasAgentDiscount(p);
    if(p.type === 'credit') {
      priceLabel.textContent = 'ราคาต่อเครดิต';
    } else {
      priceLabel.textContent = 'ราคา';
    }
    document.getElementById('pdPrice').textContent = currencyTH(displayPrice||0);
    renderProductSteps('pdInstructionsWrap', 'pdInstructions', p.details);
    const fields = document.getElementById('pdFields');
    fields.innerHTML='';
    const addField = (id,label,type='text')=>{
      const wrap=document.createElement('div');
      wrap.innerHTML = `<label class="text-sm">${label}</label><input id="${id}" type="${type}" class="w-full border rounded p-2 text-sm" />`;
      fields.appendChild(wrap);
    };
    // If this product is a credit product, add credits input
    if(p.type === 'credit'){
      const creditWrap = document.createElement('div');
      creditWrap.className = 'mb-2';
      creditWrap.innerHTML = `
        <label class="text-sm">จำนวนเครดิต</label>
        <div class="flex gap-2 items-center">
          <input id="pdCredits" type="number" min="1" step="1" value="1" class="flex-1 border rounded p-2 text-sm" />
          <span class="text-sm text-slate-600">เครดิต</span>
        </div>
      `;
      fields.appendChild(creditWrap);
      // attach handler to auto-update total price display
      const updatePdPrice = () => {
        const creditsEl = document.getElementById('pdCredits');
        if(!creditsEl) return;
        const amount = Math.max(1, parseInt(creditsEl.value) || 0);
        creditsEl.value = amount;
        const pricePer = Number(getEffectivePrice(p)) || 0;
        const total = amount * pricePer;
        document.getElementById('pdPrice').textContent = currencyTH(total);
      };
      setTimeout(()=>{
        const creditsEl = document.getElementById('pdCredits');
        if(creditsEl){ creditsEl.addEventListener('input', updatePdPrice); }
      }, 0);
    }
    if(p.requiresEmail) addField('pdEmail','Email');
    if(p.requiresUsername) addField('pdUsername','Username');
    if(p.requiresSN) addField('pdSN','SN / Serial Number');
    if(p.requiresIMEI) addField('pdIMEI','IMEI');
    if(p.requiresPassword) addField('pdPassword','รหัสผ่าน','password');
    if(p.requiresDetails){
      const wrap = document.createElement('div');
      wrap.className = 'mt-2';
      wrap.innerHTML = `<label class="text-sm">รายละเอียดสำหรับผู้ให้บริการ (กรุณากรอกรายละเอียดก่อนสั่งซื้อ)</label><textarea id="pdDetails" rows="3" class="w-full border rounded p-2 text-sm" placeholder="กรอกรายละเอียดเช่น อีเมล, Username, SN, คำอธิบายเพิ่มเติม"></textarea>`;
      fields.appendChild(wrap);
    }
    document.getElementById('pdMsg').textContent='';
    showModalElement(productModal);
  }
  function closeProductModal(){ hideModalElement(productModal); PRODUCT_SELECTED=null; }

  function renderCart(){
    const list = document.getElementById('cartList');
    const totalEl = document.getElementById('cartTotal');
    const msg = document.getElementById('cartMsg');
    msg.textContent=''; msg.className='mt-2 text-sm';
    if(!CART.length){ list.innerHTML = '<div class="text-slate-500">ตะกร้าว่าง</div>'; totalEl.textContent='0'; updateCartCount(); return; }
    list.innerHTML='';
    let sum=0;
    CART.forEach((it,idx)=>{
      sum += Number(it.price)||0;
      const row=document.createElement('div');
      row.className='border rounded p-3 flex gap-3 items-start';
      row.innerHTML = `
        ${it.image? `<img src="${it.image}" class="w-12 h-12 rounded object-cover border" />`:''}
        <div class="flex-1">
          <div class="font-semibold">${it.name} <span class="text-slate-500">• ${currencyTH(it.price)} เครดิต</span></div>
          ${it.requiresEmail? `<div class="mt-2"><input data-email-index="${idx}" type="email" value="${it.emailForProduct||''}" placeholder="อีเมลสำหรับสินค้านี้" class="w-full border rounded p-2 text-sm" /></div>`:''}
          ${it.requiresUsername? `<div class="mt-2"><input data-username-index="${idx}" type="text" value="${it.usernameForProduct||''}" placeholder="Username" class="w-full border rounded p-2 text-sm" /></div>`:''}
          ${it.requiresSN? `<div class="mt-2"><input data-sn-index="${idx}" type="text" value="${it.snForProduct||''}" placeholder="SN / Serial" class="w-full border rounded p-2 text-sm" /></div>`:''}
          ${it.requiresIMEI? `<div class="mt-2"><input data-imei-index="${idx}" type="text" value="${it.imeiForProduct||''}" placeholder="IMEI" class="w-full border rounded p-2 text-sm" /></div>`:''}
          ${it.requiresPassword? `<div class="mt-2"><input data-password-index="${idx}" type="password" value="${it.passwordForProduct||''}" placeholder="รหัสผ่านสำหรับสินค้านี้" class="w-full border rounded p-2 text-sm" /></div>`:''}
          ${it.requiresDetails? `<div class="mt-2"><textarea data-details-index="${idx}" rows="3" placeholder="รายละเอียดสำหรับสินค้านี้" class="w-full border rounded p-2 text-sm">${it.additionalDetails||''}</textarea></div>` : ''}
        </div>
        <button data-remove-index="${idx}" class="text-red-600 text-sm">ลบ</button>`;
      list.appendChild(row);
    });
    totalEl.textContent = currencyTH(sum);
    // bind events
    list.querySelectorAll('[data-remove-index]').forEach(btn=>{
      btn.addEventListener('click', e=>{
        const i = Number(e.currentTarget.getAttribute('data-remove-index'));
        CART.splice(i,1); saveCart(); renderCart();
      });
    });
    list.querySelectorAll('[data-email-index]').forEach(inp=>{
      inp.addEventListener('input', e=>{
        const i = Number(e.currentTarget.getAttribute('data-email-index'));
        CART[i].emailForProduct = e.currentTarget.value;
        saveCart();
      });
    });
    list.querySelectorAll('[data-username-index]').forEach(inp=>{
      inp.addEventListener('input', e=>{
        const i = Number(e.currentTarget.getAttribute('data-username-index'));
        CART[i].usernameForProduct = e.currentTarget.value;
        saveCart();
      });
    });
    list.querySelectorAll('[data-sn-index]').forEach(inp=>{
      inp.addEventListener('input', e=>{
        const i = Number(e.currentTarget.getAttribute('data-sn-index'));
        CART[i].snForProduct = e.currentTarget.value;
        saveCart();
      });
    });
    list.querySelectorAll('[data-imei-index]').forEach(inp=>{
      inp.addEventListener('input', e=>{
        const i = Number(e.currentTarget.getAttribute('data-imei-index'));
        CART[i].imeiForProduct = e.currentTarget.value;
        saveCart();
      });
    });
    list.querySelectorAll('[data-password-index]').forEach(inp=>{
      inp.addEventListener('input', e=>{
        const i = Number(e.currentTarget.getAttribute('data-password-index'));
        CART[i].passwordForProduct = e.currentTarget.value;
        saveCart();
      });
    });
    list.querySelectorAll('[data-details-index]').forEach(inp=>{
      inp.addEventListener('input', e=>{
        const i = Number(e.currentTarget.getAttribute('data-details-index'));
        CART[i].additionalDetails = e.currentTarget.value;
        saveCart();
      });
    });
  }

  // ปุ่มยืนยันการสั่งซื้อจากตะกร้า: ตรวจสอบการล็อกอิน, ฟิลด์ที่ต้องกรอก, เครดิต แล้วสร้างคำสั่งซื้อ
  async function confirmCartOrders(){
    const msg = document.getElementById('cartMsg'); msg.textContent=''; msg.className='mt-2 text-sm';
    if(!CURRENT_USER){
      // หลังล็อกอินเสร็จ ให้เปิดตะกร้ากลับมา
      AFTER_LOGIN_ACTION = { action: 'openCart' };

      // ปิดตะกร้าก่อน เพื่อไม่ให้ทับโมดัลล็อกอิน
      hideModalElement(cartModal);

      // แล้วค่อยเปิดหน้าล็อกอิน
      openLoginModal();
      return;
    }

    if(!CART.length){ msg.classList.add('text-slate-500'); msg.textContent = 'ตะกร้าว่าง'; return; }
    // validate required fields for each item
    for(let i=0;i<CART.length;i++){
      const it = CART[i];
      if(it.requiresEmail && !it.emailForProduct){ msg.classList.add('text-red-600'); msg.textContent = `กรุณากรอกอีเมลสำหรับ: ${it.name}`; return; }
      if(it.requiresUsername && !it.usernameForProduct){ msg.classList.add('text-red-600'); msg.textContent = `กรุณากรอก Username สำหรับ: ${it.name}`; return; }
      if(it.requiresSN && !it.snForProduct){ msg.classList.add('text-red-600'); msg.textContent = `กรุณากรอก SN/Serial สำหรับ: ${it.name}`; return; }
      if(it.requiresIMEI && !it.imeiForProduct){ msg.classList.add('text-red-600'); msg.textContent = `กรุณากรอก IMEI สำหรับ: ${it.name}`; return; }
      if(it.requiresPassword && !it.passwordForProduct){ msg.classList.add('text-red-600'); msg.textContent = `กรุณากรอก รหัสผ่านสำหรับ: ${it.name}`; return; }
      if(it.requiresDetails && !it.additionalDetails){ msg.classList.add('text-red-600'); msg.textContent = `กรุณากรอกรายละเอียดสำหรับ: ${it.name}`; return; }
    }
    const total = CART.reduce((s,it)=> s + Number(it.price||0), 0);
    const lineOrders = CART.map(it => ({
      product: it.name,
      program: it.program,
      price: Number(it.price)||0,
          email: it.emailForProduct || CURRENT_USER?.email || '',
          username: it.usernameForProduct || '',
          sn: it.snForProduct || '',
          imei: it.imeiForProduct || '',
          password: it.passwordForProduct || '',
          additional: it.additionalDetails || ''
    }));
    const lineName = CURRENT_USER?.email || CURRENT_USER_DOC?.email || 'customer';
    try{
      // Transaction: deduct user credits and create paid orders atomically
      await runTransaction(db, async (tx)=>{
        const uref = doc(db,'users',CURRENT_USER.uid);
        const usnap = await tx.get(uref);
        const bal = (usnap.data()?.credits) || 0;
        if(bal < total) throw new Error('เครดิตไม่เพียงพอ');
        tx.update(uref, { credits: bal - total });
        const ocol = collection(db,'orders');
        for(let idx=0; idx<CART.length; idx++){
          const it = CART[idx];
          const oref = doc(ocol);
          if(lineOrders[idx]) lineOrders[idx].orderId = oref.id;
          tx.set(oref, {
            userId: CURRENT_USER.uid,
            userEmail: (CURRENT_USER.email||'').toLowerCase(),
            status: 'pending',
            product: {
              id: it.id,
              name: it.name,
              program: it.program,
              price: Number(it.price)||0,
              image: it.image||'',
              requiresEmail: !!it.requiresEmail,
              requiresUsername: !!it.requiresUsername,
              requiresSN: !!it.requiresSN,
              requiresIMEI: !!it.requiresIMEI,
              source: it.source||'firestore'
            },
            emailForProduct: it.emailForProduct||'',
            usernameForProduct: it.usernameForProduct||'',
            snForProduct: it.snForProduct||'',
            imeiForProduct: it.imeiForProduct||'',
            additionalDetails: it.additionalDetails||'',
            passwordForProduct: it.passwordForProduct||'',
            createdAt: serverTimestamp()
          });
        }
      });
      lineOrders.forEach(item => {
        const note = buildLineNote(item);
        notifyLineOrder({
          name: lineName,
          product: item.product,
          qty: 1,
          total: currencyTH(item.price),
          note
        });
      });
      // update local state and UI
      if(!CURRENT_USER_DOC) CURRENT_USER_DOC = { credits: 0 };
      CURRENT_USER_DOC.credits = (CURRENT_USER_DOC.credits || 0) - total;
      CART = []; saveCart(); renderCart(); updateHeaderAuth();
      msg.classList.add('text-emerald-700'); msg.textContent = 'สั่งซื้อสำเร็จ: หักเครดิตเรียบร้อยแล้ว';
      setTimeout(()=>{ closeCartModal(); }, 900);
    }catch(e){ msg.classList.add('text-red-600'); msg.textContent = e.message || 'เกิดข้อผิดพลาดในการทำรายการ'; }
  }

  document.getElementById('continueShopping')?.addEventListener('click', ()=>{ confirmCartOrders(); });

  // Buy now (immediate charge) from product modal
  document.getElementById('pdAddCart').addEventListener('click', ()=>{
    if(!PRODUCT_SELECTED){ return; }
    const msg = document.getElementById('pdMsg'); msg.textContent=''; msg.className='text-sm';
    const details = {
      emailForProduct: document.getElementById('pdEmail')?.value?.trim()||'',
      usernameForProduct: document.getElementById('pdUsername')?.value?.trim()||'',
      snForProduct: document.getElementById('pdSN')?.value?.trim()||'',
      imeiForProduct: document.getElementById('pdIMEI')?.value?.trim()||'',
      passwordForProduct: document.getElementById('pdPassword')?.value?.trim()||'',
      additionalDetails: document.getElementById('pdDetails')?.value?.trim()||''
    };
    
    // Handle credit products
    if(PRODUCT_SELECTED.type === 'credit') {
      const credits = document.getElementById('pdCredits');
      if(!credits || !credits.value) {
        msg.classList.add('text-red-600');
        msg.textContent = 'กรุณาระบุจำนวนเครดิต';
        return;
      }
      const amount = Math.max(1, parseInt(credits.value) || 0);
      if(amount < 1) {
        msg.classList.add('text-red-600');
        msg.textContent = 'จำนวนเครดิตต้องมากกว่า 0';
        return;
      }
  const pricePerCredit = Number(getEffectivePrice(PRODUCT_SELECTED)) || 0;
      const total = amount * pricePerCredit;
      
      // Create a modified product object for the cart
      const creditProduct = {
        ...PRODUCT_SELECTED,
        price: total,
        originalPrice: pricePerCredit,
        creditAmount: amount,
        pack: `${PRODUCT_SELECTED.pack} (${amount} เครดิต)`
      };
      addToCart(creditProduct, details);
      closeProductModal();
      return;
    }

    // Handle normal products
    if(PRODUCT_SELECTED.requiresEmail && !details.emailForProduct){ msg.classList.add('text-red-600'); msg.textContent='กรุณากรอก Email'; return; }
    if(PRODUCT_SELECTED.requiresUsername && !details.usernameForProduct){ msg.classList.add('text-red-600'); msg.textContent='กรุณากรอก Username'; return; }
    if(PRODUCT_SELECTED.requiresSN && !details.snForProduct){ msg.classList.add('text-red-600'); msg.textContent='กรุณากรอก SN/Serial'; return; }
    if(PRODUCT_SELECTED.requiresIMEI && !details.imeiForProduct){ msg.classList.add('text-red-600'); msg.textContent='กรุณากรอก IMEI'; return; }
    if(PRODUCT_SELECTED.requiresPassword && !details.passwordForProduct){ msg.classList.add('text-red-600'); msg.textContent='กรุณากรอก รหัสผ่าน'; return; }
    if(PRODUCT_SELECTED.requiresDetails && !details.additionalDetails){ msg.classList.add('text-red-600'); msg.textContent='กรุณากรอกรายละเอียดก่อนสั่งซื้อ'; return; }
    addToCart(PRODUCT_SELECTED, details);
    closeProductModal();
  });

  // ----- Events -----
  searchEl.addEventListener("input", ()=>{
    // Search works independently - not affected by program filter
    render(groupByProgram(FS_PRODUCTS), searchEl.value);
  });
  
  document.getElementById('programFilter')?.addEventListener('change', onProgramFilterChange);

  document.getElementById('registerBtn').addEventListener('click', openRegModal);
  document.getElementById('loginBtn').addEventListener('click', openLoginModal);
  document.getElementById('logoutBtn').addEventListener('click', logoutWithConfirm);
  document.getElementById('viewListBtn').addEventListener('click', ()=> setProductViewMode(VIEW_MODES.LIST));
  document.getElementById('viewTableBtn').addEventListener('click', ()=> setProductViewMode(VIEW_MODES.TABLE));
  document.getElementById('closeReg').addEventListener('click', closeRegModal);
    document.getElementById('doRegister').addEventListener('click', async ()=>{
    const email = document.getElementById('authEmailR').value.trim();
    const pass = document.getElementById('authPassR').value;
    const pass2 = document.getElementById('authPass2R').value;
    const question = document.getElementById('authQuestionR').value;
    const answer = document.getElementById('authAnswerR').value.trim();
    const msg = document.getElementById('authMsgR'); msg.textContent=''; msg.className='text-sm';
    if(!email){ msg.textContent='กรุณากรอกอีเมล'; return; }
    if(!pass){ msg.textContent='กรุณากรอกรหัสผ่าน'; return; }
    if(pass !== pass2){ msg.textContent='รหัสผ่านไม่ตรงกัน'; return; }
    if(!question){ msg.textContent='กรุณาเลือกคำถามเพื่อความปลอดภัย'; return; }
    if(!answer){ msg.textContent='กรุณากรอกคำตอบ'; return; }
    let answerHash = '';
    try{ answerHash = await hashAnswer(answer); }catch(_){ answerHash = answer.trim().toLowerCase(); }
    const extraProfile = {
      securityQuestionKey: question,
      securityAnswerHash: answerHash,
      securityQuestionUpdatedAt: serverTimestamp()
    };
    try{
      const cred = await createUserWithEmailAndPassword(auth,email,pass);
      try { await upsertSecurityQA(email, question, answerHash, cred.user?.uid||''); } catch(_){/* ignore */}
      // Create user profile in background; ignore failures here (rules may block)
      try { CURRENT_USER_DOC = await ensureUserProfile(cred.user); await bootstrapFirestoreAfterSignup(cred.user); updateHeaderAuth(); } catch(_){ }
      // Show success then leave registration
      msg.textContent = 'สมัครสมาชิกเรียบร้อย';
      msg.classList.add('text-emerald-700');
      setTimeout(()=>{ closeRegModal(); }, 900);
    }catch(e){ msg.textContent = e.message; }
  });

  document.getElementById('openForgot').addEventListener('click', ()=>{ closeLoginModal(); openForgotModal(); });
  document.getElementById('closeLogin').addEventListener('click', closeLoginModal);
  document.getElementById('doLogin').addEventListener('click', async ()=>{
    const email = document.getElementById('authEmailL').value.trim();
    const pass = document.getElementById('authPassL').value;
    const msg = document.getElementById('authMsgL'); msg.textContent=''; msg.className='text-sm text-red-600';
    if(!email){ msg.textContent='กรุณากรอกอีเมล'; return; }
    if(!pass){ msg.textContent='กรุณากรอกรหัสผ่าน'; return; }
    try{
      await signInWithEmailAndPassword(auth,email,pass);
      msg.classList.remove('text-red-600'); msg.classList.add('text-emerald-700');
      msg.textContent = 'เข้าสู่ระบบสำเร็จ';
      setTimeout(()=>{ closeLoginModal(); }, 500);
    }catch(e){ 
      msg.classList.add('text-red-600');
      msg.textContent = e.code === 'auth/invalid-credential' || e.code === 'auth/wrong-password' || e.code === 'auth/user-not-found' 
        ? 'อีเมลหรือรหัสผ่านไม่ถูกต้อง' 
        : e.message; 
    }
  });
  document.getElementById('closeForgot').addEventListener('click', closeForgotModal);
  document.getElementById('closeReset').addEventListener('click', closeResetPasswordModal);
        document.getElementById('doResetPassword').addEventListener('click', handleResetPassword);
  updateViewToggleUI();

  (async ()=>{
    try{
      const params = new URLSearchParams(window.location.search);
      const mode = params.get('mode');
      const code = params.get('oobCode');
      if(mode === 'resetPassword' && code){
        try{
          const email = await verifyPasswordResetCode(auth, code);
          openResetPasswordModal(email, code);
        }catch(_){
          alert('ลิงก์รีเซ็ตรหัสผ่านไม่ถูกต้องหรือหมดอายุ');
        }finally{
          params.delete('mode');
          params.delete('oobCode');
          params.delete('lang');
          params.delete('continueUrl');
          const qs = params.toString();
          const newUrl = `${window.location.origin}${window.location.pathname}${qs ? '?' + qs : ''}${window.location.hash}`;
          window.history.replaceState({}, document.title, newUrl);
        }
      }
    }catch(_){ }
  })();

  // escape HTML to avoid injection when rendering arbitrary text
  function escapeHtml(str){
    if(!str && str !== 0) return '';
    return String(str)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');
  }

  function renderUserHistory(docs){
    const tbody = document.getElementById('ordersTbody');
    if(!tbody) return;
    if(!docs.length){ tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-slate-500">ยังไม่มีคำสั่งซื้อ</td></tr>'; return; }
    // sort by createdAt desc client-side
    docs.sort((a,b)=>{
      const ta = a.createdAt?.toMillis?.() || 0;
      const tb = b.createdAt?.toMillis?.() || 0;
      return tb - ta;
    });
    tbody.innerHTML = '';
    docs.forEach(p=>{
      const prodName = p.product?.name || p.pack || p.name || '';
      const prodPrice = p.product?.price ?? p.price ?? 0;
      const statusRaw = (p.status||'').toString();
      const ts = p.createdAt?.toDate ? p.createdAt.toDate().toLocaleString('th-TH') : (p.createdAt? String(p.createdAt): '');
      const reply = p.reply || p.orderReply || p.adminMessage || p.resultMessage || p.message || p.note || '';
      // map status to Thai label and color
      let statusLabel = statusRaw;
      let statusClass = 'bg-slate-100 text-slate-700';
      if(statusRaw === 'pending') { statusLabel = 'กำลังดำเนินการ'; statusClass = 'bg-amber-200 text-amber-800'; }
      else if(statusRaw === 'accepted') { statusLabel = 'สำเร็จ'; statusClass = 'bg-emerald-200 text-emerald-800'; }
      else if(statusRaw === 'rejected') { statusLabel = 'ไม่สำเร็จ'; statusClass = 'bg-red-200 text-red-800'; }
      else if(statusRaw === 'paid') { statusLabel = 'ชำระแล้ว'; statusClass = 'bg-sky-100 text-sky-800'; }

      const tr = document.createElement('tr');
      tr.className = 'border-b';
      const noteString = buildLineNote({
        email: p.emailForProduct || p.email || '',
        username: p.usernameForProduct || p.username || '',
        sn: p.snForProduct || p.sn || '',
        imei: p.imeiForProduct || p.imei || '',
        password: p.passwordForProduct || p.password || ''
      });
      const noteParts = noteString ? noteString.split('|').map(part => part.trim()).filter(Boolean) : [];
      const noteHtml = noteParts.length
        ? noteParts.map(part => `<div class="text-sm text-slate-600">${escapeHtml(part)}</div>`).join('')
        : '<span class="text-slate-400">-</span>';

      tr.innerHTML = `
        <td class="p-2 align-top">${escapeHtml(prodName)}</td>
        <td class="p-2 align-top whitespace-nowrap"><span class="px-2 py-1 rounded ${statusClass} text-sm">${escapeHtml(statusLabel)}</span></td>
        <td class="p-2 align-top">${currencyTH(prodPrice)}</td>
        <td class="p-2 align-top">${escapeHtml(ts)}</td>
        <td class="p-2 align-top">${noteHtml}</td>
  <td class="p-2 align-top">${nl2br(escapeHtml(reply))}</td>
      `;
      tbody.appendChild(tr);
    });
  }
  function listenOrdersForUser(){
    if(USER_ORDERS_UNSUB){ USER_ORDERS_UNSUB(); USER_ORDERS_UNSUB=null; }
    if(!CURRENT_USER) return;
    const qref = query(collection(db,'orders'), where('userId','==', CURRENT_USER.uid));
    USER_ORDERS_UNSUB = onSnapshot(qref,(snap)=>{
      const rows = snap.docs.map(d=>({id:d.id, ...d.data()}));
      renderUserHistory(rows);
    },(err)=>{
      const tbody = document.getElementById('ordersTbody');
      if(tbody) tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-red-600">เกิดข้อผิดพลาด: ${err.message}</td></tr>`;
    });
  }
  document.getElementById('closeOrder').addEventListener('click', closeOrder);
  document.getElementById('cancelOrder').addEventListener('click', closeOrder);
  orderModal.addEventListener('click',(e)=>{ if(e.target===orderModal) closeOrder(); });
  document.getElementById('confirmOrder').addEventListener('click', placeOrder);
  document.getElementById('closeHistory').addEventListener('click', closeHistoryModal);
  document.getElementById('closeCart').addEventListener('click', closeCartModal);
  document.getElementById('closeProduct').addEventListener('click', closeProductModal);
  document.getElementById('pdCancel').addEventListener('click', closeProductModal);

  // Inline detail panel buttons
  document.getElementById('detailAddCart')?.addEventListener('click', addToCartFromDetail);
  document.getElementById('detailCancel')?.addEventListener('click', hideProductDetail);

  document.getElementById('addCreditBtn').addEventListener('click', async ()=>{
    const email = document.getElementById('creditEmail').value.trim();
    const amt = Number(document.getElementById('creditAmount').value||0);
    const el = document.getElementById('creditMsg'); el.textContent=''; el.className='text-sm';
    try{ await addCreditsByEmail(email, amt); el.classList.add('text-emerald-700'); el.textContent = 'อัปเดตเครดิตแล้ว'; }
    catch(e){ el.classList.add('text-red-600'); el.textContent = e.message; }
  });
  document.getElementById('addProductBtn').addEventListener('click', async ()=>{
    const program = document.getElementById('pProgram').value.trim();
    const image = document.getElementById('pImage').value.trim();
    const requiresEmail = document.getElementById('pReqEmail').checked;
    const requiresPassword = document.getElementById('pReqPassword')?.checked || false;
    const requiresUsername = document.getElementById('pReqUsername')?.checked || false;
    const requiresSN = document.getElementById('pReqSN')?.checked || false;
    const requiresIMEI = document.getElementById('pReqIMEI')?.checked || false;
    const requiresDetails = document.getElementById('pReqDetails')?.checked || false;
    const isCredit = document.getElementById('pTypeCredit')?.checked || false;
  const singleName = document.getElementById('pName').value.trim();
  const singlePrice = document.getElementById('pPrice').value.trim();
  const agentPriceRaw = document.getElementById('pAgentPrice')?.value.trim() || '';
    const bulkRaw = document.getElementById('pBulkLines')?.value || '';
    const details = document.getElementById('pDetails')?.value.trim() || '';

    const messageEl = document.getElementById('productMsg');
    messageEl.textContent = '';
    messageEl.className = 'text-sm';

    try {
      if (!program) throw new Error('กรุณาระบุโปรแกรม');

      const entries = [];
      const pushEntry = (name, price, lineLabel = '') => {
        const trimmedName = (name || '').trim();
        if (!trimmedName) throw new Error(lineLabel ? `บรรทัดที่ ${lineLabel}: กรุณาระบุชื่อแพ็กเกจ` : 'กรุณาระบุชื่อแพ็กเกจ');
        const priceNumber = Number(String(price || '').replace(/[^\d.]/g, ''));
        if (!priceNumber || !isFinite(priceNumber)) {
          throw new Error(lineLabel ? `บรรทัดที่ ${lineLabel}: ราคาต้องเป็นตัวเลข` : 'กรุณาระบุราคาเป็นตัวเลข');
        }
        entries.push({
          program,
          name: trimmedName,
          price: priceNumber,
          agentPrice: Number(String(agentPriceRaw || '').replace(/[^\d.]/g, '')) || 0,
          image,
          requiresEmail,
          requiresPassword,
          requiresUsername,
          requiresSN,
          requiresIMEI,
          requiresDetails,
          details,
          type: isCredit ? 'credit' : 'normal'
        });
      };

      if (bulkRaw.trim()) {
        const lines = bulkRaw.split(/\r?\n/);
        lines.forEach((line, idx) => {
          const raw = line.trim();
          if (!raw) return;
          let namePart = '';
          let pricePart = '';
          const splitByDelimiter = raw.split(/\s*[|,]\s*/);
          if (splitByDelimiter.length >= 2) {
            namePart = splitByDelimiter[0];
            pricePart = splitByDelimiter.slice(1).join(' ').trim();
          } else {
            const lastSpace = raw.lastIndexOf(' ');
            if (lastSpace > 0) {
              namePart = raw.slice(0, lastSpace).trim();
              pricePart = raw.slice(lastSpace + 1).trim();
            }
          }
          if (!namePart || !pricePart) {
            throw new Error(`รูปแบบบรรทัดที่ ${idx + 1} ไม่ถูกต้อง (ใช้รูปแบบ "แพ็กเกจ, ราคา")`);
          }
          pushEntry(namePart, pricePart, idx + 1);
        });
      }

      if (singleName || singlePrice) {
        if (!singleName || !singlePrice) {
          throw new Error('สำหรับการเพิ่มทีละรายการ กรุณากรอกทั้งแพ็กเกจและราคา');
        }
        pushEntry(singleName, singlePrice);
      }

      if (!entries.length) {
        throw new Error('กรุณากรอกแพ็กเกจและราคาอย่างน้อย 1 รายการ');
      }

      for (const entry of entries) {
        await addProductFS(entry);
      }

      document.getElementById('pName').value = '';
      document.getElementById('pPrice').value = '';
      if (document.getElementById('pDetails')) document.getElementById('pDetails').value = '';
      if (document.getElementById('pBulkLines')) document.getElementById('pBulkLines').value = '';

      messageEl.classList.add('text-emerald-700');
      messageEl.textContent = entries.length > 1
        ? `เพิ่มสินค้าใหม่ ${entries.length} รายการเรียบร้อย`
        : 'เพิ่มสินค้าเรียบร้อย';
    } catch (e) {
      messageEl.classList.add('text-red-600');
      messageEl.textContent = e.message || 'ไม่สามารถเพิ่มสินค้าได้';
    }
  });

  // ----- Admin Functions -----
  function checkIsAdmin() {
    if (!IS_ADMIN) {
      console.warn('Access denied: Admin only');
      return false;
    }
    return true;
  }

  // Admin product table state
  let adminSelectedProducts = new Set();
  let adminEditedProducts = new Map();
  let adminProductRefs = new Map();
  let adminLastSnapshot = null;

  const showMessage = (id, msg, type = 'info') => {
    const el = document.getElementById(id);
    if(!el) return;
    el.innerHTML = msg;
    el.className = 'text-sm mt-2 ' + (type === 'error' ? 'text-red-500' : type === 'success' ? 'text-emerald-500' : 'text-slate-600');
  };

  // Clean up any existing product listeners
  function cleanupProductListeners() {
    if(PRODUCTS_UNSUB) { 
      try { PRODUCTS_UNSUB(); } catch(e) { console.error('Error cleaning up products listener:', e); }
      PRODUCTS_UNSUB = null;
    }
    adminSelectedProducts.clear();
    adminEditedProducts.clear();
    adminProductRefs.clear();
  }

  function applyAdminProductFilter(term = '') {
    const normalized = nk(term);
    const rows = document.querySelectorAll('#productsTbody tr');
    rows.forEach(row => {
      const program = nk(row.dataset.program || '');
      const name = nk(row.dataset.name || '');
      const pack = nk(row.dataset.pack || '');
      const details = nk(row.dataset.details || '');
      const match = !normalized || program.includes(normalized) || name.includes(normalized) || pack.includes(normalized) || details.includes(normalized);
      row.classList.toggle('hidden', !match);
    });
  }

  // Set up product table with real-time updates
  async function setupProductTable() {
    if(!checkIsAdmin()) return;
    const tbody = document.getElementById('productsTbody');
    if(!tbody) return;
    
    // Clean up any existing listeners first
    cleanupProductListeners();
    tbody.innerHTML = '';

    const unsubscribe = onSnapshot(collection(db, 'products'), (snapshot) => {
      tbody.innerHTML = '';
      adminProductRefs.clear();

      const docs = [];
      snapshot.forEach(doc => docs.push(doc));

      docs.sort((a, b) => {
        const dataA = a.data() || {};
        const dataB = b.data() || {};
        const programA = String(dataA.program || '');
        const programB = String(dataB.program || '');
        const programCompare = programA.localeCompare(programB, 'th', { sensitivity: 'base' });
        if (programCompare !== 0) return programCompare;
        const nameA = String(dataA.name || dataA.pack || '');
        const nameB = String(dataB.name || dataB.pack || '');
        return nameA.localeCompare(nameB, 'th', { sensitivity: 'base' });
      });

      docs.forEach(doc => {
        const data = doc.data() || {};
        adminProductRefs.set(doc.id, doc.ref);
        const isEdited = adminEditedProducts.has(doc.id);
        const tr = document.createElement('tr');
        tr.className = 'border-b' + (isEdited ? ' bg-amber-50' : '');
        tr.id = 'tr-' + doc.id;
        tr.dataset.program = String(data.program || '');
        tr.dataset.name = String(data.name || data.pack || '');
        tr.dataset.pack = String(data.pack || '');
        tr.dataset.details = String(data.details || '');
        tr.innerHTML = `
          <td class="p-2"><input type="checkbox" class="product-select" data-id="${doc.id}" ${adminSelectedProducts.has(doc.id) ? 'checked' : ''}></td>
          <td class="p-2"><input type="text" class="border rounded px-2 py-1 w-full" value="${data.program ?? ''}" data-field="program"></td>
          <td class="p-2"><input type="text" class="border rounded px-2 py-1 w-full" value="${data.name ?? ''}" data-field="name"></td>
          <td class="p-2"><input type="number" class="border rounded px-2 py-1 w-20" value="${data.price ?? ''}" data-field="price"></td>
          <td class="p-2"><input type="number" class="border rounded px-2 py-1 w-20" value="${data.agentPrice ?? ''}" data-field="agentPrice"></td>
          <td class="p-2"><input type="text" class="border rounded px-2 py-1 w-full" value="${data.image ?? ''}" data-field="image"></td>
          <td class="p-2"><input type="checkbox" data-field="requiresEmail" ${data.requiresEmail ? 'checked' : ''}></td>
          <td class="p-2"><input type="checkbox" data-field="requiresPassword" ${data.requiresPassword ? 'checked' : ''}></td>
          <td class="p-2"><input type="checkbox" data-field="requiresUsername" ${data.requiresUsername ? 'checked' : ''}></td>
          <td class="p-2"><input type="checkbox" data-field="requiresSN" ${data.requiresSN ? 'checked' : ''}></td>
          <td class="p-2"><input type="checkbox" data-field="requiresIMEI" ${data.requiresIMEI ? 'checked' : ''}></td>
          <td class="p-2"><input type="checkbox" data-field="type" ${data.type === 'credit' ? 'checked' : ''} value="credit"> Credit</td>
          <td class="p-2"><textarea class="border rounded px-2 py-1 w-full text-xs leading-relaxed" rows="3" data-field="details">${data.details ?? ''}</textarea></td>
          <td class="p-2">
            <button class="bg-emerald-600 text-white px-2 py-1 rounded text-xs save-row" data-id="${doc.id}">Save</button>
            <button class="bg-red-600 text-white px-2 py-1 rounded text-xs delete-row" data-id="${doc.id}">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);

        const inputs = tr.querySelectorAll('input:not(.product-select), textarea[data-field]');
        inputs.forEach(input => {
          const evt = input.type === 'checkbox' ? 'change' : 'input';
          input.addEventListener(evt, () => {
            if (!adminEditedProducts.has(doc.id)) adminEditedProducts.set(doc.id, new Set());
            if (input.dataset.field) {
              adminEditedProducts.get(doc.id).add(input.dataset.field);
            }
            tr.classList.add('bg-amber-50');
          });
        });
      });

      // Wire up Save/Delete buttons
      document.querySelectorAll('.save-row').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          const tr = document.getElementById('tr-' + id);
          if (!adminEditedProducts.has(id)) return;
          
          const updates = {};
          adminEditedProducts.get(id).forEach(field => {
            const element = tr.querySelector(`[data-field="${field}"]`);
            if (!element) return;
            if (field === 'price' || field === 'agentPrice') updates[field] = parseInt(element.value) || 0;
            else if (field.startsWith('requires')) updates[field] = element.checked;
            else updates[field] = (element.value || '').trim();
          });

          try {
            await updateDoc(adminProductRefs.get(id), updates);
            adminEditedProducts.delete(id);
            tr.classList.remove('bg-amber-50');
            showMessage('bulkMsg', 'บันทึกการเปลี่ยนแปลงเรียบร้อย', 'success');
          } catch (e) {
            showMessage('bulkMsg', 'Error: ' + e.message, 'error');
          }
        });
      });

      document.querySelectorAll('.delete-row').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!confirm('ยืนยันการลบสินค้านี้?')) return;
          const id = btn.dataset.id;
          try {
            await deleteDoc(adminProductRefs.get(id));
            document.getElementById('tr-' + id)?.remove();
            adminEditedProducts.delete(id);
            adminSelectedProducts.delete(id);
            showMessage('bulkMsg', 'ลบรายการเรียบร้อย', 'success');
          } catch (e) {
            showMessage('bulkMsg', 'Error: ' + e.message, 'error');
          }
        });
      });

      document.querySelectorAll('.product-select').forEach(cb => {
        cb.addEventListener('change', () => {
          if (cb.checked) adminSelectedProducts.add(cb.dataset.id);
          else adminSelectedProducts.delete(cb.dataset.id);
        });
      });
      const searchEl = document.getElementById('adminProductSearch');
      applyAdminProductFilter(searchEl ? searchEl.value : '');
    });

    return unsubscribe;
  }

  // Wire up admin product management
  const wireProductManagement = () => {
    if (!IS_ADMIN) return; // ไม่ต้อง wire ถ้าไม่ใช่ admin
    
    const openAdminProductBtn = document.getElementById('openAdminProductBtn');
    const modal = document.getElementById('adminProductModal');

    if (!openAdminProductBtn || !modal) {
      console.warn('Product management elements not found');
      return;
    }

    // Set up click handler with proper admin check and error handling
    openAdminProductBtn.addEventListener('click', async () => {
      try {
        if (!checkIsAdmin()) {
          showMessage('bulkMsg', 'ต้องเข้าสู่ระบบด้วยสิทธิ์ผู้ดูแล', 'error');
          return;
        }

        // Clean up any existing product listeners before showing modal
        cleanupProductListeners();
        
        // Show modal and set up product table
        showModalElement(modal);
        
        // Set up real-time product updates
        PRODUCTS_UNSUB = await setupProductTable();
        
        if (!PRODUCTS_UNSUB) {
          throw new Error('Failed to initialize product table');
        }
      } catch (error) {
        console.error('Error setting up product management:', error);
        showMessage('bulkMsg', 'เกิดข้อผิดพลาด: ' + (error.message || 'ไม่สามารถโหลดข้อมูลสินค้าได้'), 'error');
        // Hide modal on error to prevent stuck state
        hideModalElement(modal);
      }
    });
  };

    // Set up close button handlers with proper cleanup
    const setupCloseHandler = (buttonId) => {
      const button = document.getElementById(buttonId);
      if (button) {
        button.addEventListener('click', () => {
          if (modal) {
            hideModalElement(modal);
            cleanupProductListeners();
          }
        });
      }
    };

    setupCloseHandler('closeAdminProduct');
    setupCloseHandler('closeAdminProductFooter');

    // Set up refresh button with proper error handling
    const refreshButton = document.getElementById('btnRefreshProducts');
    if (refreshButton) {
      refreshButton.addEventListener('click', async () => {
        try {
          if (!checkIsAdmin()) {
            showMessage('bulkMsg', 'ต้องเข้าสู่ระบบด้วยสิทธิ์ผู้ดูแล', 'error');
            return;
          }

          showMessage('bulkMsg', 'กำลังรีเฟรชรายการ...');
          
          // Clean up and re-attach listeners
          cleanupProductListeners();
          PRODUCTS_UNSUB = await setupProductTable();
          
          if (!PRODUCTS_UNSUB) {
            throw new Error('Failed to initialize product table');
          }

          showMessage('bulkMsg', 'รีเฟรชเรียบร้อย', 'success');
        } catch (error) {
          console.error('Error refreshing products:', error);
          showMessage('bulkMsg', 'เกิดข้อผิดพลาด: ' + (error.message || 'ไม่สามารถรีเฟรชข้อมูลได้'), 'error');
        }
      });
    }

  // ----- Auth state -----
  // Handle session expiration: clear client state, logout and reload once
  async function handleSessionExpired() {
    try {
      // Attempt to clear in-memory state used by the app
      CART = [];
      try { saveCart(); } catch(_) {}
      CURRENT_USER = null;
      CURRENT_USER_DOC = null;
      IS_ADMIN = false;
      IS_AGENT = false;
      // Stop any running listeners/monitors
      try { stopActivityMonitoring(); } catch(_) {}
      try { if (USER_ORDERS_UNSUB) { USER_ORDERS_UNSUB(); USER_ORDERS_UNSUB = null; } } catch(_) {}
      try { if (ADMIN_ORDERS_UNSUB) { ADMIN_ORDERS_UNSUB(); ADMIN_ORDERS_UNSUB = null; } } catch(_) {}
      // Clear storages to remove persisted session-like data (cart, prefs, tokens)
      try { localStorage.clear(); sessionStorage.clear(); } catch(_) {}
    } catch (err) {
      console.warn('handleSessionExpired cleanup error', err);
    }

    try {
      // Try to log out from Firebase/auth backend
      await performLogout();
    } catch (err) {
      console.warn('performLogout failed during session-expire handling', err);
    }

    try {
      // Prevent reload loops: reload only once per session-expire event
      const key = 'sessionExpiredReloaded';
      if (!sessionStorage.getItem(key)) {
        sessionStorage.setItem(key, '1');
        // Give user a short notice then reload so the app initializes cleanly
        //alert('เซสชันหมดอายุแล้ว เนื่องจากไม่มีการใช้งาน กรุณาเข้าสู่ระบบใหม่\\n(หน้าจะรีเฟรชให้อัตโนมัติ)');
        window.location.reload();
        return;
      } else {
        // Already reloaded once — clear the flag and show message without looping
        sessionStorage.removeItem(key);
        //alert('เซสชันหมดอายุแล้ว กรุณาเข้าสู่ระบบใหม่');
      }
    } catch (err) {
      console.warn('handleSessionExpired reload error', err);
      // Fallback: final alert
      //try { alert('เซสชันหมดอายุแล้ว กรุณาเข้าสู่ระบบใหม่'); } catch(_) {}
    }
  }
  // Set up auth state change listener
  onAuthStateChanged(auth, async (user)=>{
    CURRENT_USER = user||null;
    if(user){
      try {
        CURRENT_USER_DOC = await ensureUserProfile(user);
      } catch (e) {
        // Fall back to a minimal client state if rules temporarily block profile creation
        CURRENT_USER_DOC = { email: (user.email||'').toLowerCase(), credits: 0, isAdmin: false };
      }
      IS_ADMIN = !!CURRENT_USER_DOC?.isAdmin || ADMIN_EMAILS.includes((user.email||'').toLowerCase());
      // Determine agent role from custom claims (role===2 or agent flag) or from user profile
      try{
        const idResult = await getIdTokenResult(user);
        const claims = idResult?.claims || {};
        IS_AGENT = (claims.role === 2) || !!claims.agent || !!CURRENT_USER_DOC?.isAgent || (Number(CURRENT_USER_DOC?.role) === 2);
      }catch(_){
        IS_AGENT = !!CURRENT_USER_DOC?.isAgent || (Number(CURRENT_USER_DOC?.role) === 2);
      }
      
      // ✅ Check for inactivity timeout when page reloads or user logs in
      if (checkInactivityTimeout()) {
        console.log('User session expired due to inactivity');
        await handleSessionExpired();
        return;
      }
      
      // Re-render products after agent status is determined
      render(groupByProgram(FS_PRODUCTS), searchEl?.value || "");
      listenOrdersForUser();
      // Wire up product management after login 
      wireProductManagement();
      startActivityMonitoring();
    }else{
      CURRENT_USER_DOC = null; IS_ADMIN = false;
      if(USER_ORDERS_UNSUB){ USER_ORDERS_UNSUB(); USER_ORDERS_UNSUB=null; }
      if(ADMIN_ORDERS_UNSUB){ ADMIN_ORDERS_UNSUB(); ADMIN_ORDERS_UNSUB = null; }
      stopActivityMonitoring();
    }
    // load cart for current context (merge guest -> user when applicable)
    try{ loadCart(); } catch(e) { CART = []; }
    updateCartCount();
    updateHeaderAuth();
    sanitizeSearchPrefill();
    if(IS_ADMIN) listenOrdersForAdmin();
    // If there was an action waiting for login, resume it now (but do not auto-confirm cart)
    if(CURRENT_USER && AFTER_LOGIN_ACTION){
      const act = AFTER_LOGIN_ACTION; AFTER_LOGIN_ACTION = null;
      try{
        if(act.action === 'openCart'){
          // open cart so user can explicitly confirm
          setTimeout(()=>{ openCartModal(); }, 200);
        } else if(act.action === 'singleOrder'){
          setTimeout(()=>{ openOrderModal(PENDING_ORDER); }, 200);
        }
      }catch(e){ console.error('resume after login failed', e); }
    }
  });

  // Initialize the application
  (async () => {
    try {
      // Set up Firestore listener
      PRODUCTS_UNSUB = await setupFirestoreProducts();
      
      // Initialize cart
      try { 
        loadCart(); 
        updateCartCount(); 
      } catch(err) {
        console.error('Cart init error:', err);
      }
      
      // Wire up product management if admin
      if (IS_ADMIN) {
        try {
          wireProductManagement();
        } catch(err) {
          console.error('Product management init error:', err);
        }
      }
      
      // Update status
      statusEl.textContent = "อัปเดตล่าสุด: " + new Date().toLocaleString("th-TH");
    } catch(e) {
      statusEl.innerHTML = `<span class="text-red-600">เกิดข้อผิดพลาด:</span> ${e.message}`;
      console.error(e);
    }
  })();
  </script>
</body>
</html>